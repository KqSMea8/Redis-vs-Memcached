<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - redis.info - src/sentinel.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">src</a> - sentinel.c<span style="font-size: 80%;"> (source / <a href="sentinel.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">redis.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">2247</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2018-11-29 23:16:49</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">107</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Redis Sentinel implementation</a>
<span class="lineNum">       2 </span>            :  *
<span class="lineNum">       3 </span>            :  * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
<span class="lineNum">       4 </span>            :  * All rights reserved.
<span class="lineNum">       5 </span>            :  *
<span class="lineNum">       6 </span>            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">       7 </span>            :  * modification, are permitted provided that the following conditions are met:
<span class="lineNum">       8 </span>            :  *
<span class="lineNum">       9 </span>            :  *   * Redistributions of source code must retain the above copyright notice,
<span class="lineNum">      10 </span>            :  *     this list of conditions and the following disclaimer.
<span class="lineNum">      11 </span>            :  *   * Redistributions in binary form must reproduce the above copyright
<span class="lineNum">      12 </span>            :  *     notice, this list of conditions and the following disclaimer in the
<span class="lineNum">      13 </span>            :  *     documentation and/or other materials provided with the distribution.
<span class="lineNum">      14 </span>            :  *   * Neither the name of Redis nor the names of its contributors may be used
<span class="lineNum">      15 </span>            :  *     to endorse or promote products derived from this software without
<span class="lineNum">      16 </span>            :  *     specific prior written permission.
<span class="lineNum">      17 </span>            :  *
<span class="lineNum">      18 </span>            :  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
<span class="lineNum">      19 </span>            :  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
<span class="lineNum">      20 </span>            :  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
<span class="lineNum">      21 </span>            :  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
<span class="lineNum">      22 </span>            :  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
<span class="lineNum">      23 </span>            :  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
<span class="lineNum">      24 </span>            :  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
<span class="lineNum">      25 </span>            :  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
<span class="lineNum">      26 </span>            :  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
<span class="lineNum">      27 </span>            :  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
<span class="lineNum">      28 </span>            :  * POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      29 </span>            :  */
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : #include &quot;server.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;hiredis.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;async.h&quot;
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : #include &lt;ctype.h&gt;
<span class="lineNum">      36 </span>            : #include &lt;arpa/inet.h&gt;
<span class="lineNum">      37 </span>            : #include &lt;sys/socket.h&gt;
<span class="lineNum">      38 </span>            : #include &lt;sys/wait.h&gt;
<span class="lineNum">      39 </span>            : #include &lt;fcntl.h&gt;
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : extern char **environ;
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : #define REDIS_SENTINEL_PORT 26379
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : /* ======================== Sentinel global state =========================== */
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : /* Address object, used to describe an ip:port pair. */
<span class="lineNum">      48 </span>            : typedef struct sentinelAddr {
<span class="lineNum">      49 </span>            :     char *ip;
<span class="lineNum">      50 </span>            :     int port;
<span class="lineNum">      51 </span>            : } sentinelAddr;
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : /* A Sentinel Redis Instance object is monitoring. */
<span class="lineNum">      54 </span>            : #define SRI_MASTER  (1&lt;&lt;0)
<span class="lineNum">      55 </span>            : #define SRI_SLAVE   (1&lt;&lt;1)
<span class="lineNum">      56 </span>            : #define SRI_SENTINEL (1&lt;&lt;2)
<span class="lineNum">      57 </span>            : #define SRI_S_DOWN (1&lt;&lt;3)   /* Subjectively down (no quorum). */
<span class="lineNum">      58 </span>            : #define SRI_O_DOWN (1&lt;&lt;4)   /* Objectively down (confirmed by others). */
<span class="lineNum">      59 </span>            : #define SRI_MASTER_DOWN (1&lt;&lt;5) /* A Sentinel with this flag set thinks that
<span class="lineNum">      60 </span>            :                                    its master is down. */
<span class="lineNum">      61 </span>            : #define SRI_FAILOVER_IN_PROGRESS (1&lt;&lt;6) /* Failover is in progress for
<span class="lineNum">      62 </span>            :                                            this master. */
<span class="lineNum">      63 </span>            : #define SRI_PROMOTED (1&lt;&lt;7)            /* Slave selected for promotion. */
<span class="lineNum">      64 </span>            : #define SRI_RECONF_SENT (1&lt;&lt;8)     /* SLAVEOF &lt;newmaster&gt; sent. */
<span class="lineNum">      65 </span>            : #define SRI_RECONF_INPROG (1&lt;&lt;9)   /* Slave synchronization in progress. */
<span class="lineNum">      66 </span>            : #define SRI_RECONF_DONE (1&lt;&lt;10)     /* Slave synchronized with new master. */
<span class="lineNum">      67 </span>            : #define SRI_FORCE_FAILOVER (1&lt;&lt;11)  /* Force failover with master up. */
<span class="lineNum">      68 </span>            : #define SRI_SCRIPT_KILL_SENT (1&lt;&lt;12) /* SCRIPT KILL already sent on -BUSY */
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span>            : /* Note: times are in milliseconds. */
<span class="lineNum">      71 </span>            : #define SENTINEL_INFO_PERIOD 10000
<span class="lineNum">      72 </span>            : #define SENTINEL_PING_PERIOD 1000
<span class="lineNum">      73 </span>            : #define SENTINEL_ASK_PERIOD 1000
<span class="lineNum">      74 </span>            : #define SENTINEL_PUBLISH_PERIOD 2000
<span class="lineNum">      75 </span>            : #define SENTINEL_DEFAULT_DOWN_AFTER 30000
<span class="lineNum">      76 </span>            : #define SENTINEL_HELLO_CHANNEL &quot;__sentinel__:hello&quot;
<span class="lineNum">      77 </span>            : #define SENTINEL_TILT_TRIGGER 2000
<span class="lineNum">      78 </span>            : #define SENTINEL_TILT_PERIOD (SENTINEL_PING_PERIOD*30)
<span class="lineNum">      79 </span>            : #define SENTINEL_DEFAULT_SLAVE_PRIORITY 100
<span class="lineNum">      80 </span>            : #define SENTINEL_SLAVE_RECONF_TIMEOUT 10000
<span class="lineNum">      81 </span>            : #define SENTINEL_DEFAULT_PARALLEL_SYNCS 1
<span class="lineNum">      82 </span>            : #define SENTINEL_MIN_LINK_RECONNECT_PERIOD 15000
<span class="lineNum">      83 </span>            : #define SENTINEL_DEFAULT_FAILOVER_TIMEOUT (60*3*1000)
<span class="lineNum">      84 </span>            : #define SENTINEL_MAX_PENDING_COMMANDS 100
<span class="lineNum">      85 </span>            : #define SENTINEL_ELECTION_TIMEOUT 10000
<span class="lineNum">      86 </span>            : #define SENTINEL_MAX_DESYNC 1000
<span class="lineNum">      87 </span>            : #define SENTINEL_DEFAULT_DENY_SCRIPTS_RECONFIG 1
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span>            : /* Failover machine different states. */
<span class="lineNum">      90 </span>            : #define SENTINEL_FAILOVER_STATE_NONE 0  /* No failover in progress. */
<span class="lineNum">      91 </span>            : #define SENTINEL_FAILOVER_STATE_WAIT_START 1  /* Wait for failover_start_time*/
<span class="lineNum">      92 </span>            : #define SENTINEL_FAILOVER_STATE_SELECT_SLAVE 2 /* Select slave to promote */
<span class="lineNum">      93 </span>            : #define SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE 3 /* Slave -&gt; Master */
<span class="lineNum">      94 </span>            : #define SENTINEL_FAILOVER_STATE_WAIT_PROMOTION 4 /* Wait slave to change role */
<span class="lineNum">      95 </span>            : #define SENTINEL_FAILOVER_STATE_RECONF_SLAVES 5 /* SLAVEOF newmaster */
<span class="lineNum">      96 </span>            : #define SENTINEL_FAILOVER_STATE_UPDATE_CONFIG 6 /* Monitor promoted slave. */
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            : #define SENTINEL_MASTER_LINK_STATUS_UP 0
<span class="lineNum">      99 </span>            : #define SENTINEL_MASTER_LINK_STATUS_DOWN 1
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span>            : /* Generic flags that can be used with different functions.
<span class="lineNum">     102 </span>            :  * They use higher bits to avoid colliding with the function specific
<span class="lineNum">     103 </span>            :  * flags. */
<span class="lineNum">     104 </span>            : #define SENTINEL_NO_FLAGS 0
<span class="lineNum">     105 </span>            : #define SENTINEL_GENERATE_EVENT (1&lt;&lt;16)
<span class="lineNum">     106 </span>            : #define SENTINEL_LEADER (1&lt;&lt;17)
<span class="lineNum">     107 </span>            : #define SENTINEL_OBSERVER (1&lt;&lt;18)
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span>            : /* Script execution flags and limits. */
<span class="lineNum">     110 </span>            : #define SENTINEL_SCRIPT_NONE 0
<span class="lineNum">     111 </span>            : #define SENTINEL_SCRIPT_RUNNING 1
<span class="lineNum">     112 </span>            : #define SENTINEL_SCRIPT_MAX_QUEUE 256
<span class="lineNum">     113 </span>            : #define SENTINEL_SCRIPT_MAX_RUNNING 16
<span class="lineNum">     114 </span>            : #define SENTINEL_SCRIPT_MAX_RUNTIME 60000 /* 60 seconds max exec time. */
<span class="lineNum">     115 </span>            : #define SENTINEL_SCRIPT_MAX_RETRY 10
<span class="lineNum">     116 </span>            : #define SENTINEL_SCRIPT_RETRY_DELAY 30000 /* 30 seconds between retries. */
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span>            : /* SENTINEL SIMULATE-FAILURE command flags. */
<span class="lineNum">     119 </span>            : #define SENTINEL_SIMFAILURE_NONE 0
<span class="lineNum">     120 </span>            : #define SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION (1&lt;&lt;0)
<span class="lineNum">     121 </span>            : #define SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION (1&lt;&lt;1)
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span>            : /* The link to a sentinelRedisInstance. When we have the same set of Sentinels
<span class="lineNum">     124 </span>            :  * monitoring many masters, we have different instances representing the
<span class="lineNum">     125 </span>            :  * same Sentinels, one per master, and we need to share the hiredis connections
<span class="lineNum">     126 </span>            :  * among them. Oherwise if 5 Sentinels are monitoring 100 masters we create
<span class="lineNum">     127 </span>            :  * 500 outgoing connections instead of 5.
<span class="lineNum">     128 </span>            :  *
<span class="lineNum">     129 </span>            :  * So this structure represents a reference counted link in terms of the two
<span class="lineNum">     130 </span>            :  * hiredis connections for commands and Pub/Sub, and the fields needed for
<span class="lineNum">     131 </span>            :  * failure detection, since the ping/pong time are now local to the link: if
<span class="lineNum">     132 </span>            :  * the link is available, the instance is avaialbe. This way we don't just
<span class="lineNum">     133 </span>            :  * have 5 connections instead of 500, we also send 5 pings instead of 500.
<span class="lineNum">     134 </span>            :  *
<span class="lineNum">     135 </span>            :  * Links are shared only for Sentinels: master and slave instances have
<span class="lineNum">     136 </span>            :  * a link with refcount = 1, always. */
<span class="lineNum">     137 </span>            : typedef struct instanceLink {
<span class="lineNum">     138 </span>            :     int refcount;          /* Number of sentinelRedisInstance owners. */
<span class="lineNum">     139 </span>            :     int disconnected;      /* Non-zero if we need to reconnect cc or pc. */
<span class="lineNum">     140 </span>            :     int pending_commands;  /* Number of commands sent waiting for a reply. */
<span class="lineNum">     141 </span>            :     redisAsyncContext *cc; /* Hiredis context for commands. */
<span class="lineNum">     142 </span>            :     redisAsyncContext *pc; /* Hiredis context for Pub / Sub. */
<span class="lineNum">     143 </span>            :     mstime_t cc_conn_time; /* cc connection time. */
<span class="lineNum">     144 </span>            :     mstime_t pc_conn_time; /* pc connection time. */
<span class="lineNum">     145 </span>            :     mstime_t pc_last_activity; /* Last time we received any message. */
<span class="lineNum">     146 </span>            :     mstime_t last_avail_time; /* Last time the instance replied to ping with
<span class="lineNum">     147 </span>            :                                  a reply we consider valid. */
<span class="lineNum">     148 </span>            :     mstime_t act_ping_time;   /* Time at which the last pending ping (no pong
<span class="lineNum">     149 </span>            :                                  received after it) was sent. This field is
<span class="lineNum">     150 </span>            :                                  set to 0 when a pong is received, and set again
<span class="lineNum">     151 </span>            :                                  to the current time if the value is 0 and a new
<span class="lineNum">     152 </span>            :                                  ping is sent. */
<span class="lineNum">     153 </span>            :     mstime_t last_ping_time;  /* Time at which we sent the last ping. This is
<span class="lineNum">     154 </span>            :                                  only used to avoid sending too many pings
<span class="lineNum">     155 </span>            :                                  during failure. Idle time is computed using
<span class="lineNum">     156 </span>            :                                  the act_ping_time field. */
<span class="lineNum">     157 </span>            :     mstime_t last_pong_time;  /* Last time the instance replied to ping,
<span class="lineNum">     158 </span>            :                                  whatever the reply was. That's used to check
<span class="lineNum">     159 </span>            :                                  if the link is idle and must be reconnected. */
<span class="lineNum">     160 </span>            :     mstime_t last_reconn_time;  /* Last reconnection attempt performed when
<span class="lineNum">     161 </span>            :                                    the link was down. */
<span class="lineNum">     162 </span>            : } instanceLink;
<span class="lineNum">     163 </span>            : 
<span class="lineNum">     164 </span>            : typedef struct sentinelRedisInstance {
<span class="lineNum">     165 </span>            :     int flags;      /* See SRI_... defines */
<span class="lineNum">     166 </span>            :     char *name;     /* Master name from the point of view of this sentinel. */
<span class="lineNum">     167 </span>            :     char *runid;    /* Run ID of this instance, or unique ID if is a Sentinel.*/
<span class="lineNum">     168 </span>            :     uint64_t config_epoch;  /* Configuration epoch. */
<span class="lineNum">     169 </span>            :     sentinelAddr *addr; /* Master host. */
<span class="lineNum">     170 </span>            :     instanceLink *link; /* Link to the instance, may be shared for Sentinels. */
<span class="lineNum">     171 </span>            :     mstime_t last_pub_time;   /* Last time we sent hello via Pub/Sub. */
<span class="lineNum">     172 </span>            :     mstime_t last_hello_time; /* Only used if SRI_SENTINEL is set. Last time
<span class="lineNum">     173 </span>            :                                  we received a hello from this Sentinel
<span class="lineNum">     174 </span>            :                                  via Pub/Sub. */
<span class="lineNum">     175 </span>            :     mstime_t last_master_down_reply_time; /* Time of last reply to
<span class="lineNum">     176 </span>            :                                              SENTINEL is-master-down command. */
<span class="lineNum">     177 </span>            :     mstime_t s_down_since_time; /* Subjectively down since time. */
<span class="lineNum">     178 </span>            :     mstime_t o_down_since_time; /* Objectively down since time. */
<span class="lineNum">     179 </span>            :     mstime_t down_after_period; /* Consider it down after that period. */
<span class="lineNum">     180 </span>            :     mstime_t info_refresh;  /* Time at which we received INFO output from it. */
<span class="lineNum">     181 </span>            :     dict *renamed_commands;     /* Commands renamed in this instance:
<span class="lineNum">     182 </span>            :                                    Sentinel will use the alternative commands
<span class="lineNum">     183 </span>            :                                    mapped on this table to send things like
<span class="lineNum">     184 </span>            :                                    SLAVEOF, CONFING, INFO, ... */
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span>            :     /* Role and the first time we observed it.
<span class="lineNum">     187 </span>            :      * This is useful in order to delay replacing what the instance reports
<span class="lineNum">     188 </span>            :      * with our own configuration. We need to always wait some time in order
<span class="lineNum">     189 </span>            :      * to give a chance to the leader to report the new configuration before
<span class="lineNum">     190 </span>            :      * we do silly things. */
<span class="lineNum">     191 </span>            :     int role_reported;
<span class="lineNum">     192 </span>            :     mstime_t role_reported_time;
<span class="lineNum">     193 </span>            :     mstime_t slave_conf_change_time; /* Last time slave master addr changed. */
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            :     /* Master specific. */
<span class="lineNum">     196 </span>            :     dict *sentinels;    /* Other sentinels monitoring the same master. */
<span class="lineNum">     197 </span>            :     dict *slaves;       /* Slaves for this master instance. */
<span class="lineNum">     198 </span>            :     unsigned int quorum;/* Number of sentinels that need to agree on failure. */
<span class="lineNum">     199 </span>            :     int parallel_syncs; /* How many slaves to reconfigure at same time. */
<span class="lineNum">     200 </span>            :     char *auth_pass;    /* Password to use for AUTH against master &amp; slaves. */
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            :     /* Slave specific. */
<span class="lineNum">     203 </span>            :     mstime_t master_link_down_time; /* Slave replication link down time. */
<span class="lineNum">     204 </span>            :     int slave_priority; /* Slave priority according to its INFO output. */
<span class="lineNum">     205 </span>            :     mstime_t slave_reconf_sent_time; /* Time at which we sent SLAVE OF &lt;new&gt; */
<span class="lineNum">     206 </span>            :     struct sentinelRedisInstance *master; /* Master instance if it's slave. */
<span class="lineNum">     207 </span>            :     char *slave_master_host;    /* Master host as reported by INFO */
<span class="lineNum">     208 </span>            :     int slave_master_port;      /* Master port as reported by INFO */
<span class="lineNum">     209 </span>            :     int slave_master_link_status; /* Master link status as reported by INFO */
<span class="lineNum">     210 </span>            :     unsigned long long slave_repl_offset; /* Slave replication offset. */
<span class="lineNum">     211 </span>            :     /* Failover */
<span class="lineNum">     212 </span>            :     char *leader;       /* If this is a master instance, this is the runid of
<span class="lineNum">     213 </span>            :                            the Sentinel that should perform the failover. If
<span class="lineNum">     214 </span>            :                            this is a Sentinel, this is the runid of the Sentinel
<span class="lineNum">     215 </span>            :                            that this Sentinel voted as leader. */
<span class="lineNum">     216 </span>            :     uint64_t leader_epoch; /* Epoch of the 'leader' field. */
<span class="lineNum">     217 </span>            :     uint64_t failover_epoch; /* Epoch of the currently started failover. */
<span class="lineNum">     218 </span>            :     int failover_state; /* See SENTINEL_FAILOVER_STATE_* defines. */
<span class="lineNum">     219 </span>            :     mstime_t failover_state_change_time;
<span class="lineNum">     220 </span>            :     mstime_t failover_start_time;   /* Last failover attempt start time. */
<span class="lineNum">     221 </span>            :     mstime_t failover_timeout;      /* Max time to refresh failover state. */
<span class="lineNum">     222 </span>            :     mstime_t failover_delay_logged; /* For what failover_start_time value we
<span class="lineNum">     223 </span>            :                                        logged the failover delay. */
<span class="lineNum">     224 </span>            :     struct sentinelRedisInstance *promoted_slave; /* Promoted slave instance. */
<span class="lineNum">     225 </span>            :     /* Scripts executed to notify admin or reconfigure clients: when they
<span class="lineNum">     226 </span>            :      * are set to NULL no script is executed. */
<span class="lineNum">     227 </span>            :     char *notification_script;
<span class="lineNum">     228 </span>            :     char *client_reconfig_script;
<span class="lineNum">     229 </span>            :     sds info; /* cached INFO output */
<span class="lineNum">     230 </span>            : } sentinelRedisInstance;
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span>            : /* Main state. */
<span class="lineNum">     233 </span>            : struct sentinelState {
<span class="lineNum">     234 </span>            :     char myid[CONFIG_RUN_ID_SIZE+1]; /* This sentinel ID. */
<span class="lineNum">     235 </span>            :     uint64_t current_epoch;         /* Current epoch. */
<span class="lineNum">     236 </span>            :     dict *masters;      /* Dictionary of master sentinelRedisInstances.
<span class="lineNum">     237 </span>            :                            Key is the instance name, value is the
<span class="lineNum">     238 </span>            :                            sentinelRedisInstance structure pointer. */
<span class="lineNum">     239 </span>            :     int tilt;           /* Are we in TILT mode? */
<span class="lineNum">     240 </span>            :     int running_scripts;    /* Number of scripts in execution right now. */
<span class="lineNum">     241 </span>            :     mstime_t tilt_start_time;       /* When TITL started. */
<span class="lineNum">     242 </span>            :     mstime_t previous_time;         /* Last time we ran the time handler. */
<span class="lineNum">     243 </span>            :     list *scripts_queue;            /* Queue of user scripts to execute. */
<span class="lineNum">     244 </span>            :     char *announce_ip;  /* IP addr that is gossiped to other sentinels if
<span class="lineNum">     245 </span>            :                            not NULL. */
<span class="lineNum">     246 </span>            :     int announce_port;  /* Port that is gossiped to other sentinels if
<span class="lineNum">     247 </span>            :                            non zero. */
<span class="lineNum">     248 </span>            :     unsigned long simfailure_flags; /* Failures simulation. */
<span class="lineNum">     249 </span>            :     int deny_scripts_reconfig; /* Allow SENTINEL SET ... to change script
<span class="lineNum">     250 </span>            :                                   paths at runtime? */
<span class="lineNum">     251 </span>            : } sentinel;
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span>            : /* A script execution job. */
<span class="lineNum">     254 </span>            : typedef struct sentinelScriptJob {
<span class="lineNum">     255 </span>            :     int flags;              /* Script job flags: SENTINEL_SCRIPT_* */
<span class="lineNum">     256 </span>            :     int retry_num;          /* Number of times we tried to execute it. */
<span class="lineNum">     257 </span>            :     char **argv;            /* Arguments to call the script. */
<span class="lineNum">     258 </span>            :     mstime_t start_time;    /* Script execution time if the script is running,
<span class="lineNum">     259 </span>            :                                otherwise 0 if we are allowed to retry the
<span class="lineNum">     260 </span>            :                                execution at any time. If the script is not
<span class="lineNum">     261 </span>            :                                running and it's not 0, it means: do not run
<span class="lineNum">     262 </span>            :                                before the specified time. */
<span class="lineNum">     263 </span>            :     pid_t pid;              /* Script execution pid. */
<span class="lineNum">     264 </span>            : } sentinelScriptJob;
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span>            : /* ======================= hiredis ae.c adapters =============================
<span class="lineNum">     267 </span>            :  * Note: this implementation is taken from hiredis/adapters/ae.h, however
<span class="lineNum">     268 </span>            :  * we have our modified copy for Sentinel in order to use our allocator
<span class="lineNum">     269 </span>            :  * and to have full control over how the adapter works. */
<span class="lineNum">     270 </span>            : 
<span class="lineNum">     271 </span>            : typedef struct redisAeEvents {
<span class="lineNum">     272 </span>            :     redisAsyncContext *context;
<span class="lineNum">     273 </span>            :     aeEventLoop *loop;
<span class="lineNum">     274 </span>            :     int fd;
<span class="lineNum">     275 </span>            :     int reading, writing;
<a name="276"><span class="lineNum">     276 </span>            : } redisAeEvents;</a>
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span><span class="lineNoCov">          0 : static void redisAeReadEvent(aeEventLoop *el, int fd, void *privdata, int mask) {</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     ((void)el); ((void)fd); ((void)mask);</span>
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :     redisAsyncHandleRead(e-&gt;context);</span>
<a name="283"><span class="lineNum">     283 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span><span class="lineNoCov">          0 : static void redisAeWriteEvent(aeEventLoop *el, int fd, void *privdata, int mask) {</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     ((void)el); ((void)fd); ((void)mask);</span>
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :     redisAsyncHandleWrite(e-&gt;context);</span>
<a name="290"><span class="lineNum">     290 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span><span class="lineNoCov">          0 : static void redisAeAddRead(void *privdata) {</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :     aeEventLoop *loop = e-&gt;loop;</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :     if (!e-&gt;reading) {</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         e-&gt;reading = 1;</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :         aeCreateFileEvent(loop,e-&gt;fd,AE_READABLE,redisAeReadEvent,e);</span>
<span class="lineNum">     298 </span>            :     }
<a name="299"><span class="lineNum">     299 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span><span class="lineNoCov">          0 : static void redisAeDelRead(void *privdata) {</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :     aeEventLoop *loop = e-&gt;loop;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :     if (e-&gt;reading) {</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         e-&gt;reading = 0;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :         aeDeleteFileEvent(loop,e-&gt;fd,AE_READABLE);</span>
<span class="lineNum">     307 </span>            :     }
<a name="308"><span class="lineNum">     308 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span><span class="lineNoCov">          0 : static void redisAeAddWrite(void *privdata) {</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :     aeEventLoop *loop = e-&gt;loop;</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :     if (!e-&gt;writing) {</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :         e-&gt;writing = 1;</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :         aeCreateFileEvent(loop,e-&gt;fd,AE_WRITABLE,redisAeWriteEvent,e);</span>
<span class="lineNum">     316 </span>            :     }
<a name="317"><span class="lineNum">     317 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     318 </span>            : 
<span class="lineNum">     319 </span><span class="lineNoCov">          0 : static void redisAeDelWrite(void *privdata) {</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     aeEventLoop *loop = e-&gt;loop;</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :     if (e-&gt;writing) {</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :         e-&gt;writing = 0;</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :         aeDeleteFileEvent(loop,e-&gt;fd,AE_WRITABLE);</span>
<span class="lineNum">     325 </span>            :     }
<a name="326"><span class="lineNum">     326 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span><span class="lineNoCov">          0 : static void redisAeCleanup(void *privdata) {</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :     redisAeEvents *e = (redisAeEvents*)privdata;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :     redisAeDelRead(privdata);</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     redisAeDelWrite(privdata);</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     zfree(e);</span>
<a name="333"><span class="lineNum">     333 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span><span class="lineNoCov">          0 : static int redisAeAttach(aeEventLoop *loop, redisAsyncContext *ac) {</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     redisContext *c = &amp;(ac-&gt;c);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :     redisAeEvents *e;</span>
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span>            :     /* Nothing should be attached when something is already attached */
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     if (ac-&gt;ev.data != NULL)</span>
<span class="lineNum">     341 </span>            :         return C_ERR;
<span class="lineNum">     342 </span>            : 
<span class="lineNum">     343 </span>            :     /* Create container for context and r/w events */
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :     e = (redisAeEvents*)zmalloc(sizeof(*e));</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     e-&gt;context = ac;</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     e-&gt;loop = loop;</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :     e-&gt;fd = c-&gt;fd;</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :     e-&gt;reading = e-&gt;writing = 0;</span>
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span>            :     /* Register functions to start/stop listening for events */
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     ac-&gt;ev.addRead = redisAeAddRead;</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :     ac-&gt;ev.delRead = redisAeDelRead;</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :     ac-&gt;ev.addWrite = redisAeAddWrite;</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     ac-&gt;ev.delWrite = redisAeDelWrite;</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     ac-&gt;ev.cleanup = redisAeCleanup;</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :     ac-&gt;ev.data = e;</span>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :     return C_OK;</span>
<span class="lineNum">     359 </span>            : }
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span>            : /* ============================= Prototypes ================================= */
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span>            : void sentinelLinkEstablishedCallback(const redisAsyncContext *c, int status);
<span class="lineNum">     364 </span>            : void sentinelDisconnectCallback(const redisAsyncContext *c, int status);
<span class="lineNum">     365 </span>            : void sentinelReceiveHelloMessages(redisAsyncContext *c, void *reply, void *privdata);
<span class="lineNum">     366 </span>            : sentinelRedisInstance *sentinelGetMasterByName(char *name);
<span class="lineNum">     367 </span>            : char *sentinelGetSubjectiveLeader(sentinelRedisInstance *master);
<span class="lineNum">     368 </span>            : char *sentinelGetObjectiveLeader(sentinelRedisInstance *master);
<span class="lineNum">     369 </span>            : int yesnotoi(char *s);
<span class="lineNum">     370 </span>            : void instanceLinkConnectionError(const redisAsyncContext *c);
<span class="lineNum">     371 </span>            : const char *sentinelRedisInstanceTypeStr(sentinelRedisInstance *ri);
<span class="lineNum">     372 </span>            : void sentinelAbortFailover(sentinelRedisInstance *ri);
<span class="lineNum">     373 </span>            : void sentinelEvent(int level, char *type, sentinelRedisInstance *ri, const char *fmt, ...);
<span class="lineNum">     374 </span>            : sentinelRedisInstance *sentinelSelectSlave(sentinelRedisInstance *master);
<span class="lineNum">     375 </span>            : void sentinelScheduleScriptExecution(char *path, ...);
<span class="lineNum">     376 </span>            : void sentinelStartFailover(sentinelRedisInstance *master);
<span class="lineNum">     377 </span>            : void sentinelDiscardReplyCallback(redisAsyncContext *c, void *reply, void *privdata);
<span class="lineNum">     378 </span>            : int sentinelSendSlaveOf(sentinelRedisInstance *ri, char *host, int port);
<span class="lineNum">     379 </span>            : char *sentinelVoteLeader(sentinelRedisInstance *master, uint64_t req_epoch, char *req_runid, uint64_t *leader_epoch);
<span class="lineNum">     380 </span>            : void sentinelFlushConfig(void);
<span class="lineNum">     381 </span>            : void sentinelGenerateInitialMonitorEvents(void);
<span class="lineNum">     382 </span>            : int sentinelSendPing(sentinelRedisInstance *ri);
<span class="lineNum">     383 </span>            : int sentinelForceHelloUpdateForMaster(sentinelRedisInstance *master);
<span class="lineNum">     384 </span>            : sentinelRedisInstance *getSentinelRedisInstanceByAddrAndRunID(dict *instances, char *ip, int port, char *runid);
<span class="lineNum">     385 </span>            : void sentinelSimFailureCrash(void);
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span>            : /* ========================= Dictionary types =============================== */
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            : uint64_t dictSdsHash(const void *key);
<span class="lineNum">     390 </span>            : uint64_t dictSdsCaseHash(const void *key);
<span class="lineNum">     391 </span>            : int dictSdsKeyCompare(void *privdata, const void *key1, const void *key2);
<span class="lineNum">     392 </span>            : int dictSdsKeyCaseCompare(void *privdata, const void *key1, const void *key2);
<a name="393"><span class="lineNum">     393 </span>            : void releaseSentinelRedisInstance(sentinelRedisInstance *ri);</a>
<span class="lineNum">     394 </span>            : 
<span class="lineNum">     395 </span><span class="lineNoCov">          0 : void dictInstancesValDestructor (void *privdata, void *obj) {</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :     UNUSED(privdata);</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     releaseSentinelRedisInstance(obj);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            : /* Instance name (sds) -&gt; instance (sentinelRedisInstance pointer)
<span class="lineNum">     401 </span>            :  *
<span class="lineNum">     402 </span>            :  * also used for: sentinelRedisInstance-&gt;sentinels dictionary that maps
<span class="lineNum">     403 </span>            :  * sentinels ip:port to last seen time in Pub/Sub hello message. */
<span class="lineNum">     404 </span>            : dictType instancesDictType = {
<span class="lineNum">     405 </span>            :     dictSdsHash,               /* hash function */
<span class="lineNum">     406 </span>            :     NULL,                      /* key dup */
<span class="lineNum">     407 </span>            :     NULL,                      /* val dup */
<span class="lineNum">     408 </span>            :     dictSdsKeyCompare,         /* key compare */
<span class="lineNum">     409 </span>            :     NULL,                      /* key destructor */
<span class="lineNum">     410 </span>            :     dictInstancesValDestructor /* val destructor */
<span class="lineNum">     411 </span>            : };
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span>            : /* Instance runid (sds) -&gt; votes (long casted to void*)
<span class="lineNum">     414 </span>            :  *
<span class="lineNum">     415 </span>            :  * This is useful into sentinelGetObjectiveLeader() function in order to
<span class="lineNum">     416 </span>            :  * count the votes and understand who is the leader. */
<span class="lineNum">     417 </span>            : dictType leaderVotesDictType = {
<span class="lineNum">     418 </span>            :     dictSdsHash,               /* hash function */
<span class="lineNum">     419 </span>            :     NULL,                      /* key dup */
<span class="lineNum">     420 </span>            :     NULL,                      /* val dup */
<span class="lineNum">     421 </span>            :     dictSdsKeyCompare,         /* key compare */
<span class="lineNum">     422 </span>            :     NULL,                      /* key destructor */
<span class="lineNum">     423 </span>            :     NULL                       /* val destructor */
<span class="lineNum">     424 </span>            : };
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span>            : /* Instance renamed commands table. */
<span class="lineNum">     427 </span>            : dictType renamedCommandsDictType = {
<span class="lineNum">     428 </span>            :     dictSdsCaseHash,           /* hash function */
<span class="lineNum">     429 </span>            :     NULL,                      /* key dup */
<span class="lineNum">     430 </span>            :     NULL,                      /* val dup */
<span class="lineNum">     431 </span>            :     dictSdsKeyCaseCompare,     /* key compare */
<span class="lineNum">     432 </span>            :     dictSdsDestructor,         /* key destructor */
<span class="lineNum">     433 </span>            :     dictSdsDestructor          /* val destructor */
<span class="lineNum">     434 </span>            : };
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span>            : /* =========================== Initialization =============================== */
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span>            : void sentinelCommand(client *c);
<span class="lineNum">     439 </span>            : void sentinelInfoCommand(client *c);
<span class="lineNum">     440 </span>            : void sentinelSetCommand(client *c);
<span class="lineNum">     441 </span>            : void sentinelPublishCommand(client *c);
<span class="lineNum">     442 </span>            : void sentinelRoleCommand(client *c);
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span>            : struct redisCommand sentinelcmds[] = {
<span class="lineNum">     445 </span>            :     {&quot;ping&quot;,pingCommand,1,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     446 </span>            :     {&quot;sentinel&quot;,sentinelCommand,-2,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     447 </span>            :     {&quot;subscribe&quot;,subscribeCommand,-2,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     448 </span>            :     {&quot;unsubscribe&quot;,unsubscribeCommand,-1,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     449 </span>            :     {&quot;psubscribe&quot;,psubscribeCommand,-2,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     450 </span>            :     {&quot;punsubscribe&quot;,punsubscribeCommand,-1,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     451 </span>            :     {&quot;publish&quot;,sentinelPublishCommand,3,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     452 </span>            :     {&quot;info&quot;,sentinelInfoCommand,-1,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     453 </span>            :     {&quot;role&quot;,sentinelRoleCommand,1,&quot;l&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     454 </span>            :     {&quot;client&quot;,clientCommand,-2,&quot;rs&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     455 </span>            :     {&quot;shutdown&quot;,shutdownCommand,-1,&quot;&quot;,0,NULL,0,0,0,0,0},
<span class="lineNum">     456 </span>            :     {&quot;auth&quot;,authCommand,2,&quot;sltF&quot;,0,NULL,0,0,0,0,0}
<span class="lineNum">     457 </span>            : };
<span class="lineNum">     458 </span>            : 
<a name="459"><span class="lineNum">     459 </span>            : /* This function overwrites a few normal Redis config default with Sentinel</a>
<span class="lineNum">     460 </span>            :  * specific defaults. */
<span class="lineNum">     461 </span><span class="lineNoCov">          0 : void initSentinelConfig(void) {</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :     server.port = REDIS_SENTINEL_PORT;</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :     server.protected_mode = 0; /* Sentinel must be exposed. */</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 : }</span>
<a name="465"><span class="lineNum">     465 </span>            : </a>
<span class="lineNum">     466 </span>            : /* Perform the Sentinel mode initialization. */
<span class="lineNum">     467 </span><span class="lineNoCov">          0 : void initSentinel(void) {</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     unsigned int j;</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span>            :     /* Remove usual Redis commands from the command table, then just add
<span class="lineNum">     471 </span>            :      * the SENTINEL command. */
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     dictEmpty(server.commands,NULL);</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; sizeof(sentinelcmds)/sizeof(sentinelcmds[0]); j++) {</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :         int retval;</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :         struct redisCommand *cmd = sentinelcmds+j;</span>
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :         retval = dictAdd(server.commands, sdsnew(cmd-&gt;name), cmd);</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         serverAssert(retval == DICT_OK);</span>
<span class="lineNum">     479 </span>            :     }
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span>            :     /* Initialize various data structures. */
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :     sentinel.current_epoch = 0;</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :     sentinel.masters = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :     sentinel.tilt = 0;</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :     sentinel.tilt_start_time = 0;</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :     sentinel.previous_time = mstime();</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :     sentinel.running_scripts = 0;</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     sentinel.scripts_queue = listCreate();</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :     sentinel.announce_ip = NULL;</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :     sentinel.announce_port = 0;</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :     sentinel.simfailure_flags = SENTINEL_SIMFAILURE_NONE;</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :     sentinel.deny_scripts_reconfig = SENTINEL_DEFAULT_DENY_SCRIPTS_RECONFIG;</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :     memset(sentinel.myid,0,sizeof(sentinel.myid));</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     495 </span>            : 
<a name="496"><span class="lineNum">     496 </span>            : /* This function gets called when the server is in Sentinel mode, started,</a>
<span class="lineNum">     497 </span>            :  * loaded the configuration, and is ready for normal operations. */
<span class="lineNum">     498 </span><span class="lineNoCov">          0 : void sentinelIsRunning(void) {</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :     int j;</span>
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :     if (server.configfile == NULL) {</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :         serverLog(LL_WARNING,</span>
<span class="lineNum">     503 </span>            :             &quot;Sentinel started without a config file. Exiting...&quot;);
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :         exit(1);</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :     } else if (access(server.configfile,W_OK) == -1) {</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :         serverLog(LL_WARNING,</span>
<span class="lineNum">     507 </span>            :             &quot;Sentinel config file %s is not writable: %s. Exiting...&quot;,
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :             server.configfile,strerror(errno));</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :         exit(1);</span>
<span class="lineNum">     510 </span>            :     }
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span>            :     /* If this Sentinel has yet no ID set in the configuration file, we
<span class="lineNum">     513 </span>            :      * pick a random one and persist the config on disk. From now on this
<span class="lineNum">     514 </span>            :      * will be this Sentinel ID across restarts. */
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; CONFIG_RUN_ID_SIZE; j++)</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :         if (sentinel.myid[j] != 0) break;</span>
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     if (j == CONFIG_RUN_ID_SIZE) {</span>
<span class="lineNum">     519 </span>            :         /* Pick ID and persist the config. */
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :         getRandomHexChars(sentinel.myid,CONFIG_RUN_ID_SIZE);</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :         sentinelFlushConfig();</span>
<span class="lineNum">     522 </span>            :     }
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span>            :     /* Log its ID to make debugging of issues simpler. */
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :     serverLog(LL_WARNING,&quot;Sentinel ID is %s&quot;, sentinel.myid);</span>
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span>            :     /* We want to generate a +monitor event for every configured master
<span class="lineNum">     528 </span>            :      * at startup. */
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :     sentinelGenerateInitialMonitorEvents();</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span>            : /* ============================== sentinelAddr ============================== */
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span>            : /* Create a sentinelAddr object and return it on success.
<span class="lineNum">     535 </span>            :  * On error NULL is returned and errno is set to:
<span class="lineNum">     536 </span>            :  *  ENOENT: Can't resolve the hostname.
<a name="537"><span class="lineNum">     537 </span>            :  *  EINVAL: Invalid port number.</a>
<span class="lineNum">     538 </span>            :  */
<span class="lineNum">     539 </span><span class="lineNoCov">          0 : sentinelAddr *createSentinelAddr(char *hostname, int port) {</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :     char ip[NET_IP_STR_LEN];</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :     sentinelAddr *sa;</span>
<span class="lineNum">     542 </span>            : 
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     if (port &lt; 0 || port &gt; 65535) {</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :         errno = EINVAL;</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     546 </span>            :     }
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :     if (anetResolve(NULL,hostname,ip,sizeof(ip)) == ANET_ERR) {</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :         errno = ENOENT;</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     550 </span>            :     }
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :     sa = zmalloc(sizeof(*sa));</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     sa-&gt;ip = sdsnew(ip);</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :     sa-&gt;port = port;</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :     return sa;</span>
<span class="lineNum">     555 </span>            : }
<a name="556"><span class="lineNum">     556 </span>            : </a>
<span class="lineNum">     557 </span>            : /* Return a duplicate of the source address. */
<span class="lineNum">     558 </span><span class="lineNoCov">          0 : sentinelAddr *dupSentinelAddr(sentinelAddr *src) {</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :     sentinelAddr *sa;</span>
<span class="lineNum">     560 </span>            : 
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :     sa = zmalloc(sizeof(*sa));</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :     sa-&gt;ip = sdsnew(src-&gt;ip);</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :     sa-&gt;port = src-&gt;port;</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :     return sa;</span>
<span class="lineNum">     565 </span>            : }
<a name="566"><span class="lineNum">     566 </span>            : </a>
<span class="lineNum">     567 </span>            : /* Free a Sentinel address. Can't fail. */
<span class="lineNum">     568 </span><span class="lineNoCov">          0 : void releaseSentinelAddr(sentinelAddr *sa) {</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :     sdsfree(sa-&gt;ip);</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :     zfree(sa);</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 : }</span>
<a name="572"><span class="lineNum">     572 </span>            : </a>
<span class="lineNum">     573 </span>            : /* Return non-zero if two addresses are equal. */
<span class="lineNum">     574 </span><span class="lineNoCov">          0 : int sentinelAddrIsEqual(sentinelAddr *a, sentinelAddr *b) {</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :     return a-&gt;port == b-&gt;port &amp;&amp; !strcasecmp(a-&gt;ip,b-&gt;ip);</span>
<span class="lineNum">     576 </span>            : }
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span>            : /* =========================== Events notification ========================== */
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span>            : /* Send an event to log, pub/sub, user notification script.
<span class="lineNum">     581 </span>            :  *
<span class="lineNum">     582 </span>            :  * 'level' is the log level for logging. Only LL_WARNING events will trigger
<span class="lineNum">     583 </span>            :  * the execution of the user notification script.
<span class="lineNum">     584 </span>            :  *
<span class="lineNum">     585 </span>            :  * 'type' is the message type, also used as a pub/sub channel name.
<span class="lineNum">     586 </span>            :  *
<span class="lineNum">     587 </span>            :  * 'ri', is the redis instance target of this event if applicable, and is
<span class="lineNum">     588 </span>            :  * used to obtain the path of the notification script to execute.
<span class="lineNum">     589 </span>            :  *
<span class="lineNum">     590 </span>            :  * The remaining arguments are printf-alike.
<span class="lineNum">     591 </span>            :  * If the format specifier starts with the two characters &quot;%@&quot; then ri is
<span class="lineNum">     592 </span>            :  * not NULL, and the message is prefixed with an instance identifier in the
<span class="lineNum">     593 </span>            :  * following format:
<span class="lineNum">     594 </span>            :  *
<span class="lineNum">     595 </span>            :  *  &lt;instance type&gt; &lt;instance name&gt; &lt;ip&gt; &lt;port&gt;
<span class="lineNum">     596 </span>            :  *
<span class="lineNum">     597 </span>            :  *  If the instance type is not master, than the additional string is
<span class="lineNum">     598 </span>            :  *  added to specify the originating master:
<span class="lineNum">     599 </span>            :  *
<span class="lineNum">     600 </span>            :  *  @ &lt;master name&gt; &lt;master ip&gt; &lt;master port&gt;
<span class="lineNum">     601 </span>            :  *
<a name="602"><span class="lineNum">     602 </span>            :  *  Any other specifier after &quot;%@&quot; is processed by printf itself.</a>
<span class="lineNum">     603 </span>            :  */
<span class="lineNum">     604 </span><span class="lineNoCov">          0 : void sentinelEvent(int level, char *type, sentinelRedisInstance *ri,</span>
<span class="lineNum">     605 </span>            :                    const char *fmt, ...) {
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :     va_list ap;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :     char msg[LOG_MAX_LEN];</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :     robj *channel, *payload;</span>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span>            :     /* Handle %@ */
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :     if (fmt[0] == '%' &amp;&amp; fmt[1] == '@') {</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *master = (ri-&gt;flags &amp; SRI_MASTER) ?</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :                                          NULL : ri-&gt;master;</span>
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :         if (master) {</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :             snprintf(msg, sizeof(msg), &quot;%s %s %s %d @ %s %s %d&quot;,</span>
<span class="lineNum">     617 </span>            :                 sentinelRedisInstanceTypeStr(ri),
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :                 ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :                 master-&gt;name, master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port);</span>
<span class="lineNum">     620 </span>            :         } else {
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :             snprintf(msg, sizeof(msg), &quot;%s %s %s %d&quot;,</span>
<span class="lineNum">     622 </span>            :                 sentinelRedisInstanceTypeStr(ri),
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :                 ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port);</span>
<span class="lineNum">     624 </span>            :         }
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :         fmt += 2;</span>
<span class="lineNum">     626 </span>            :     } else {
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :         msg[0] = '\0';</span>
<span class="lineNum">     628 </span>            :     }
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span>            :     /* Use vsprintf for the rest of the formatting if any. */
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :     if (fmt[0] != '\0') {</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :         va_start(ap, fmt);</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :         vsnprintf(msg+strlen(msg), sizeof(msg)-strlen(msg), fmt, ap);</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :         va_end(ap);</span>
<span class="lineNum">     635 </span>            :     }
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span>            :     /* Log the message if the log level allows it to be logged. */
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :     if (level &gt;= server.verbosity)</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :         serverLog(level,&quot;%s %s&quot;,type,msg);</span>
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            :     /* Publish the message via Pub/Sub if it's not a debugging one. */
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :     if (level != LL_DEBUG) {</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :         channel = createStringObject(type,strlen(type));</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :         payload = createStringObject(msg,strlen(msg));</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :         pubsubPublishMessage(channel,payload);</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :         decrRefCount(channel);</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :         decrRefCount(payload);</span>
<span class="lineNum">     648 </span>            :     }
<span class="lineNum">     649 </span>            : 
<span class="lineNum">     650 </span>            :     /* Call the notification script if applicable. */
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :     if (level == LL_WARNING &amp;&amp; ri != NULL) {</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *master = (ri-&gt;flags &amp; SRI_MASTER) ?</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :                                          ri : ri-&gt;master;</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :         if (master &amp;&amp; master-&gt;notification_script) {</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :             sentinelScheduleScriptExecution(master-&gt;notification_script,</span>
<span class="lineNum">     656 </span>            :                 type,msg,NULL);
<span class="lineNum">     657 </span>            :         }
<span class="lineNum">     658 </span>            :     }
<span class="lineNum">     659 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span>            : /* This function is called only at startup and is used to generate a
<span class="lineNum">     662 </span>            :  * +monitor event for every configured master. The same events are also
<a name="663"><span class="lineNum">     663 </span>            :  * generated when a master to monitor is added at runtime via the</a>
<span class="lineNum">     664 </span>            :  * SENTINEL MONITOR command. */
<span class="lineNum">     665 </span><span class="lineNoCov">          0 : void sentinelGenerateInitialMonitorEvents(void) {</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :     di = dictGetIterator(sentinel.masters);</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;+monitor&quot;,ri,&quot;%@ quorum %d&quot;,ri-&gt;quorum);</span>
<span class="lineNum">     673 </span>            :     }
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span>            : /* ============================ script execution ============================ */
<a name="678"><span class="lineNum">     678 </span>            : </a>
<span class="lineNum">     679 </span>            : /* Release a script job structure and all the associated data. */
<span class="lineNum">     680 </span><span class="lineNoCov">          0 : void sentinelReleaseScriptJob(sentinelScriptJob *sj) {</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :     int j = 0;</span>
<span class="lineNum">     682 </span>            : 
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :     while(sj-&gt;argv[j]) sdsfree(sj-&gt;argv[j++]);</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :     zfree(sj-&gt;argv);</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :     zfree(sj);</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 : }</span>
<a name="687"><span class="lineNum">     687 </span>            : </a>
<span class="lineNum">     688 </span>            : #define SENTINEL_SCRIPT_MAX_ARGS 16
<span class="lineNum">     689 </span><span class="lineNoCov">          0 : void sentinelScheduleScriptExecution(char *path, ...) {</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :     va_list ap;</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :     char *argv[SENTINEL_SCRIPT_MAX_ARGS+1];</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :     int argc = 1;</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :     sentinelScriptJob *sj;</span>
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :     va_start(ap, path);</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :     while(argc &lt; SENTINEL_SCRIPT_MAX_ARGS) {</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :         argv[argc] = va_arg(ap,char*);</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :         if (!argv[argc]) break;</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :         argv[argc] = sdsnew(argv[argc]); /* Copy the string. */</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :         argc++;</span>
<span class="lineNum">     701 </span>            :     }
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :     va_end(ap);</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :     argv[0] = sdsnew(path);</span>
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :     sj = zmalloc(sizeof(*sj));</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :     sj-&gt;flags = SENTINEL_SCRIPT_NONE;</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :     sj-&gt;retry_num = 0;</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :     sj-&gt;argv = zmalloc(sizeof(char*)*(argc+1));</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :     sj-&gt;start_time = 0;</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :     sj-&gt;pid = 0;</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :     memcpy(sj-&gt;argv,argv,sizeof(char*)*(argc+1));</span>
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :     listAddNodeTail(sentinel.scripts_queue,sj);</span>
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span>            :     /* Remove the oldest non running script if we already hit the limit. */
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :     if (listLength(sentinel.scripts_queue) &gt; SENTINEL_SCRIPT_MAX_QUEUE) {</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :         listNode *ln;</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :         listIter li;</span>
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :         listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :         while ((ln = listNext(&amp;li)) != NULL) {</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :             sj = ln-&gt;value;</span>
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :             if (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) continue;</span>
<span class="lineNum">     725 </span>            :             /* The first node is the oldest as we add on tail. */
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :             listDelNode(sentinel.scripts_queue,ln);</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :             sentinelReleaseScriptJob(sj);</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     729 </span>            :         }
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :         serverAssert(listLength(sentinel.scripts_queue) &lt;=</span>
<span class="lineNum">     731 </span>            :                     SENTINEL_SCRIPT_MAX_QUEUE);
<span class="lineNum">     732 </span>            :     }
<span class="lineNum">     733 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     734 </span>            : 
<a name="735"><span class="lineNum">     735 </span>            : /* Lookup a script in the scripts queue via pid, and returns the list node</a>
<span class="lineNum">     736 </span>            :  * (so that we can easily remove it from the queue if needed). */
<span class="lineNum">     737 </span><span class="lineNoCov">          0 : listNode *sentinelGetScriptListNodeByPid(pid_t pid) {</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :     listNode *ln;</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :     listIter li;</span>
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :     listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :     while ((ln = listNext(&amp;li)) != NULL) {</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :         sentinelScriptJob *sj = ln-&gt;value;</span>
<span class="lineNum">     744 </span>            : 
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :         if ((sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) &amp;&amp; sj-&gt;pid == pid)</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :             return ln;</span>
<span class="lineNum">     747 </span>            :     }
<span class="lineNum">     748 </span>            :     return NULL;
<span class="lineNum">     749 </span>            : }
<span class="lineNum">     750 </span>            : 
<a name="751"><span class="lineNum">     751 </span>            : /* Run pending scripts if we are not already at max number of running</a>
<span class="lineNum">     752 </span>            :  * scripts. */
<span class="lineNum">     753 </span><span class="lineNoCov">          0 : void sentinelRunPendingScripts(void) {</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :     listNode *ln;</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :     listIter li;</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :     mstime_t now = mstime();</span>
<span class="lineNum">     757 </span>            : 
<span class="lineNum">     758 </span>            :     /* Find jobs that are not running and run them, from the top to the
<span class="lineNum">     759 </span>            :      * tail of the queue, so we run older jobs first. */
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :     while (sentinel.running_scripts &lt; SENTINEL_SCRIPT_MAX_RUNNING &amp;&amp;</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :            (ln = listNext(&amp;li)) != NULL)</span>
<span class="lineNum">     763 </span>            :     {
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :         sentinelScriptJob *sj = ln-&gt;value;</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :         pid_t pid;</span>
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            :         /* Skip if already running. */
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :         if (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) continue;</span>
<span class="lineNum">     769 </span>            : 
<span class="lineNum">     770 </span>            :         /* Skip if it's a retry, but not enough time has elapsed. */
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :         if (sj-&gt;start_time &amp;&amp; sj-&gt;start_time &gt; now) continue;</span>
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :         sj-&gt;flags |= SENTINEL_SCRIPT_RUNNING;</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :         sj-&gt;start_time = mstime();</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :         sj-&gt;retry_num++;</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :         pid = fork();</span>
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :         if (pid == -1) {</span>
<span class="lineNum">     779 </span>            :             /* Parent (fork error).
<span class="lineNum">     780 </span>            :              * We report fork errors as signal 99, in order to unify the
<span class="lineNum">     781 </span>            :              * reporting with other kind of errors. */
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;-script-error&quot;,NULL,</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :                           &quot;%s %d %d&quot;, sj-&gt;argv[0], 99, 0);</span>
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :             sj-&gt;flags &amp;= ~SENTINEL_SCRIPT_RUNNING;</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :             sj-&gt;pid = 0;</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :         } else if (pid == 0) {</span>
<span class="lineNum">     787 </span>            :             /* Child */
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :             execve(sj-&gt;argv[0],sj-&gt;argv,environ);</span>
<span class="lineNum">     789 </span>            :             /* If we are here an error occurred. */
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :             _exit(2); /* Don't retry execution. */</span>
<span class="lineNum">     791 </span>            :         } else {
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :             sentinel.running_scripts++;</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :             sj-&gt;pid = pid;</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_DEBUG,&quot;+script-child&quot;,NULL,&quot;%ld&quot;,(long)pid);</span>
<span class="lineNum">     795 </span>            :         }
<span class="lineNum">     796 </span>            :     }
<span class="lineNum">     797 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     798 </span>            : 
<span class="lineNum">     799 </span>            : /* How much to delay the execution of a script that we need to retry after
<span class="lineNum">     800 </span>            :  * an error?
<span class="lineNum">     801 </span>            :  *
<span class="lineNum">     802 </span>            :  * We double the retry delay for every further retry we do. So for instance
<span class="lineNum">     803 </span>            :  * if RETRY_DELAY is set to 30 seconds and the max number of retries is 10
<a name="804"><span class="lineNum">     804 </span>            :  * starting from the second attempt to execute the script the delays are:</a>
<span class="lineNum">     805 </span>            :  * 30 sec, 60 sec, 2 min, 4 min, 8 min, 16 min, 32 min, 64 min, 128 min. */
<span class="lineNum">     806 </span><span class="lineNoCov">          0 : mstime_t sentinelScriptRetryDelay(int retry_num) {</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :     mstime_t delay = SENTINEL_SCRIPT_RETRY_DELAY;</span>
<span class="lineNum">     808 </span>            : 
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :     while (retry_num-- &gt; 1) delay *= 2;</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :     return delay;</span>
<span class="lineNum">     811 </span>            : }
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span>            : /* Check for scripts that terminated, and remove them from the queue if the
<span class="lineNum">     814 </span>            :  * script terminated successfully. If instead the script was terminated by
<a name="815"><span class="lineNum">     815 </span>            :  * a signal, or returned exit code &quot;1&quot;, it is scheduled to run again if</a>
<span class="lineNum">     816 </span>            :  * the max number of retries did not already elapsed. */
<span class="lineNum">     817 </span><span class="lineNoCov">          0 : void sentinelCollectTerminatedScripts(void) {</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :     int statloc;</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :     pid_t pid;</span>
<span class="lineNum">     820 </span>            : 
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :     while ((pid = wait3(&amp;statloc,WNOHANG,NULL)) &gt; 0) {</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :         int exitcode = WEXITSTATUS(statloc);</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :         int bysignal = 0;</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :         listNode *ln;</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :         sentinelScriptJob *sj;</span>
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :         if (WIFSIGNALED(statloc)) bysignal = WTERMSIG(statloc);</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_DEBUG,&quot;-script-child&quot;,NULL,&quot;%ld %d %d&quot;,</span>
<span class="lineNum">     829 </span>            :             (long)pid, exitcode, bysignal);
<span class="lineNum">     830 </span>            : 
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :         ln = sentinelGetScriptListNodeByPid(pid);</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :         if (ln == NULL) {</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :             serverLog(LL_WARNING,&quot;wait3() returned a pid (%ld) we can't find in our scripts execution queue!&quot;, (long)pid);</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     835 </span>            :         }
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :         sj = ln-&gt;value;</span>
<span class="lineNum">     837 </span>            : 
<span class="lineNum">     838 </span>            :         /* If the script was terminated by a signal or returns an
<span class="lineNum">     839 </span>            :          * exit code of &quot;1&quot; (that means: please retry), we reschedule it
<span class="lineNum">     840 </span>            :          * if the max number of retries is not already reached. */
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :         if ((bysignal || exitcode == 1) &amp;&amp;</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :             sj-&gt;retry_num != SENTINEL_SCRIPT_MAX_RETRY)</span>
<span class="lineNum">     843 </span>            :         {
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :             sj-&gt;flags &amp;= ~SENTINEL_SCRIPT_RUNNING;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :             sj-&gt;pid = 0;</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :             sj-&gt;start_time = mstime() +</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :                              sentinelScriptRetryDelay(sj-&gt;retry_num);</span>
<span class="lineNum">     848 </span>            :         } else {
<span class="lineNum">     849 </span>            :             /* Otherwise let's remove the script, but log the event if the
<span class="lineNum">     850 </span>            :              * execution did not terminated in the best of the ways. */
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :             if (bysignal || exitcode != 0) {</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :                 sentinelEvent(LL_WARNING,&quot;-script-error&quot;,NULL,</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :                               &quot;%s %d %d&quot;, sj-&gt;argv[0], bysignal, exitcode);</span>
<span class="lineNum">     854 </span>            :             }
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :             listDelNode(sentinel.scripts_queue,ln);</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :             sentinelReleaseScriptJob(sj);</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :             sentinel.running_scripts--;</span>
<span class="lineNum">     858 </span>            :         }
<span class="lineNum">     859 </span>            :     }
<span class="lineNum">     860 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     861 </span>            : 
<a name="862"><span class="lineNum">     862 </span>            : /* Kill scripts in timeout, they'll be collected by the</a>
<span class="lineNum">     863 </span>            :  * sentinelCollectTerminatedScripts() function. */
<span class="lineNum">     864 </span><span class="lineNoCov">          0 : void sentinelKillTimedoutScripts(void) {</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :     listNode *ln;</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :     listIter li;</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :     mstime_t now = mstime();</span>
<span class="lineNum">     868 </span>            : 
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :     listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     while ((ln = listNext(&amp;li)) != NULL) {</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :         sentinelScriptJob *sj = ln-&gt;value;</span>
<span class="lineNum">     872 </span>            : 
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :         if (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING &amp;&amp;</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :             (now - sj-&gt;start_time) &gt; SENTINEL_SCRIPT_MAX_RUNTIME)</span>
<span class="lineNum">     875 </span>            :         {
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;-script-timeout&quot;,NULL,&quot;%s %ld&quot;,</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :                 sj-&gt;argv[0], (long)sj-&gt;pid);</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :             kill(sj-&gt;pid,SIGKILL);</span>
<span class="lineNum">     879 </span>            :         }
<span class="lineNum">     880 </span>            :     }
<span class="lineNum">     881 </span><span class="lineNoCov">          0 : }</span>
<a name="882"><span class="lineNum">     882 </span>            : </a>
<span class="lineNum">     883 </span>            : /* Implements SENTINEL PENDING-SCRIPTS command. */
<span class="lineNum">     884 </span><span class="lineNoCov">          0 : void sentinelPendingScriptsCommand(client *c) {</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :     listNode *ln;</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :     listIter li;</span>
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :     addReplyMultiBulkLen(c,listLength(sentinel.scripts_queue));</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :     listRewind(sentinel.scripts_queue,&amp;li);</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :     while ((ln = listNext(&amp;li)) != NULL) {</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :         sentinelScriptJob *sj = ln-&gt;value;</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :         int j = 0;</span>
<span class="lineNum">     893 </span>            : 
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :         addReplyMultiBulkLen(c,10);</span>
<span class="lineNum">     895 </span>            : 
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;argv&quot;);</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :         while (sj-&gt;argv[j]) j++;</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :         addReplyMultiBulkLen(c,j);</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :         j = 0;</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :         while (sj-&gt;argv[j]) addReplyBulkCString(c,sj-&gt;argv[j++]);</span>
<span class="lineNum">     901 </span>            : 
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;flags&quot;);</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :             (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) ? &quot;running&quot; : &quot;scheduled&quot;);</span>
<span class="lineNum">     905 </span>            : 
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;pid&quot;);</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,sj-&gt;pid);</span>
<span class="lineNum">     908 </span>            : 
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :         if (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) {</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :             addReplyBulkCString(c,&quot;run-time&quot;);</span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :             addReplyBulkLongLong(c,mstime() - sj-&gt;start_time);</span>
<span class="lineNum">     912 </span>            :         } else {
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :             mstime_t delay = sj-&gt;start_time ? (sj-&gt;start_time-mstime()) : 0;</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :             if (delay &lt; 0) delay = 0;</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :             addReplyBulkCString(c,&quot;run-delay&quot;);</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :             addReplyBulkLongLong(c,delay);</span>
<span class="lineNum">     917 </span>            :         }
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;retry-num&quot;);</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,sj-&gt;retry_num);</span>
<span class="lineNum">     921 </span>            :     }
<span class="lineNum">     922 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span>            : /* This function calls, if any, the client reconfiguration script with the
<span class="lineNum">     925 </span>            :  * following parameters:
<span class="lineNum">     926 </span>            :  *
<span class="lineNum">     927 </span>            :  * &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;
<span class="lineNum">     928 </span>            :  *
<span class="lineNum">     929 </span>            :  * It is called every time a failover is performed.
<span class="lineNum">     930 </span>            :  *
<span class="lineNum">     931 </span>            :  * &lt;state&gt; is currently always &quot;failover&quot;.
<span class="lineNum">     932 </span>            :  * &lt;role&gt; is either &quot;leader&quot; or &quot;observer&quot;.
<span class="lineNum">     933 </span>            :  *
<a name="934"><span class="lineNum">     934 </span>            :  * from/to fields are respectively master -&gt; promoted slave addresses for</a>
<span class="lineNum">     935 </span>            :  * &quot;start&quot; and &quot;end&quot;. */
<span class="lineNum">     936 </span><span class="lineNoCov">          0 : void sentinelCallClientReconfScript(sentinelRedisInstance *master, int role, char *state, sentinelAddr *from, sentinelAddr *to) {</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :     char fromport[32], toport[32];</span>
<span class="lineNum">     938 </span>            : 
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :     if (master-&gt;client_reconfig_script == NULL) return;</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :     ll2string(fromport,sizeof(fromport),from-&gt;port);</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :     ll2string(toport,sizeof(toport),to-&gt;port);</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :     sentinelScheduleScriptExecution(master-&gt;client_reconfig_script,</span>
<span class="lineNum">     943 </span>            :         master-&gt;name,
<span class="lineNum">     944 </span>            :         (role == SENTINEL_LEADER) ? &quot;leader&quot; : &quot;observer&quot;,
<span class="lineNum">     945 </span>            :         state, from-&gt;ip, fromport, to-&gt;ip, toport, NULL);
<span class="lineNum">     946 </span>            : }
<span class="lineNum">     947 </span>            : 
<span class="lineNum">     948 </span>            : /* =============================== instanceLink ============================= */
<a name="949"><span class="lineNum">     949 </span>            : </a>
<span class="lineNum">     950 </span>            : /* Create a not yet connected link object. */
<span class="lineNum">     951 </span><span class="lineNoCov">          0 : instanceLink *createInstanceLink(void) {</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :     instanceLink *link = zmalloc(sizeof(*link));</span>
<span class="lineNum">     953 </span>            : 
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :     link-&gt;refcount = 1;</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :     link-&gt;disconnected = 1;</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :     link-&gt;pending_commands = 0;</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :     link-&gt;cc = NULL;</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :     link-&gt;pc = NULL;</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :     link-&gt;cc_conn_time = 0;</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :     link-&gt;pc_conn_time = 0;</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :     link-&gt;last_reconn_time = 0;</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :     link-&gt;pc_last_activity = 0;</span>
<span class="lineNum">     963 </span>            :     /* We set the act_ping_time to &quot;now&quot; even if we actually don't have yet
<span class="lineNum">     964 </span>            :      * a connection with the node, nor we sent a ping.
<span class="lineNum">     965 </span>            :      * This is useful to detect a timeout in case we'll not be able to connect
<span class="lineNum">     966 </span>            :      * with the node at all. */
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :     link-&gt;act_ping_time = mstime();</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :     link-&gt;last_ping_time = 0;</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :     link-&gt;last_avail_time = mstime();</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :     link-&gt;last_pong_time = mstime();</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :     return link;</span>
<span class="lineNum">     972 </span>            : }
<a name="973"><span class="lineNum">     973 </span>            : </a>
<span class="lineNum">     974 </span>            : /* Disconnect an hiredis connection in the context of an instance link. */
<span class="lineNum">     975 </span><span class="lineNoCov">          0 : void instanceLinkCloseConnection(instanceLink *link, redisAsyncContext *c) {</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :     if (c == NULL) return;</span>
<span class="lineNum">     977 </span>            : 
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :     if (link-&gt;cc == c) {</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :         link-&gt;cc = NULL;</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :         link-&gt;pending_commands = 0;</span>
<span class="lineNum">     981 </span>            :     }
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :     if (link-&gt;pc == c) link-&gt;pc = NULL;</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :     c-&gt;data = NULL;</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :     link-&gt;disconnected = 1;</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :     redisAsyncFree(c);</span>
<span class="lineNum">     986 </span>            : }
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span>            : /* Decrement the refcount of a link object, if it drops to zero, actually
<span class="lineNum">     989 </span>            :  * free it and return NULL. Otherwise don't do anything and return the pointer
<span class="lineNum">     990 </span>            :  * to the object.
<span class="lineNum">     991 </span>            :  *
<span class="lineNum">     992 </span>            :  * If we are not going to free the link and ri is not NULL, we rebind all the
<span class="lineNum">     993 </span>            :  * pending requests in link-&gt;cc (hiredis connection for commands) to a
<a name="994"><span class="lineNum">     994 </span>            :  * callback that will just ignore them. This is useful to avoid processing</a>
<span class="lineNum">     995 </span>            :  * replies for an instance that no longer exists. */
<span class="lineNum">     996 </span><span class="lineNoCov">          0 : instanceLink *releaseInstanceLink(instanceLink *link, sentinelRedisInstance *ri)</span>
<span class="lineNum">     997 </span>            : {
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :     serverAssert(link-&gt;refcount &gt; 0);</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :     link-&gt;refcount--;</span>
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :     if (link-&gt;refcount != 0) {</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :         if (ri &amp;&amp; ri-&gt;link-&gt;cc) {</span>
<span class="lineNum">    1002 </span>            :             /* This instance may have pending callbacks in the hiredis async
<span class="lineNum">    1003 </span>            :              * context, having as 'privdata' the instance that we are going to
<span class="lineNum">    1004 </span>            :              * free. Let's rewrite the callback list, directly exploiting
<span class="lineNum">    1005 </span>            :              * hiredis internal data structures, in order to bind them with
<span class="lineNum">    1006 </span>            :              * a callback that will ignore the reply at all. */
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :             redisCallback *cb;</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :             redisCallbackList *callbacks = &amp;link-&gt;cc-&gt;replies;</span>
<span class="lineNum">    1009 </span>            : 
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :             cb = callbacks-&gt;head;</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :             while(cb) {</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                 if (cb-&gt;privdata == ri) {</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :                     cb-&gt;fn = sentinelDiscardReplyCallback;</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :                     cb-&gt;privdata = NULL; /* Not strictly needed. */</span>
<span class="lineNum">    1015 </span>            :                 }
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :                 cb = cb-&gt;next;</span>
<span class="lineNum">    1017 </span>            :             }
<span class="lineNum">    1018 </span>            :         }
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :         return link; /* Other active users. */</span>
<span class="lineNum">    1020 </span>            :     }
<span class="lineNum">    1021 </span>            : 
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :     instanceLinkCloseConnection(link,link-&gt;cc);</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :     instanceLinkCloseConnection(link,link-&gt;pc);</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :     zfree(link);</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">    1026 </span>            : }
<span class="lineNum">    1027 </span>            : 
<span class="lineNum">    1028 </span>            : /* This function will attempt to share the instance link we already have
<span class="lineNum">    1029 </span>            :  * for the same Sentinel in the context of a different master, with the
<span class="lineNum">    1030 </span>            :  * instance we are passing as argument.
<span class="lineNum">    1031 </span>            :  *
<span class="lineNum">    1032 </span>            :  * This way multiple Sentinel objects that refer all to the same physical
<span class="lineNum">    1033 </span>            :  * Sentinel instance but in the context of different masters will use
<span class="lineNum">    1034 </span>            :  * a single connection, will send a single PING per second for failure
<span class="lineNum">    1035 </span>            :  * detection and so forth.
<span class="lineNum">    1036 </span>            :  *
<span class="lineNum">    1037 </span>            :  * Return C_OK if a matching Sentinel was found in the context of a
<a name="1038"><span class="lineNum">    1038 </span>            :  * different master and sharing was performed. Otherwise C_ERR</a>
<span class="lineNum">    1039 </span>            :  * is returned. */
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 : int sentinelTryConnectionSharing(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :     serverAssert(ri-&gt;flags &amp; SRI_SENTINEL);</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :     if (ri-&gt;runid == NULL) return C_ERR; /* No way to identify it. */</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :     if (ri-&gt;link-&gt;refcount &gt; 1) return C_ERR; /* Already shared. */</span>
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :     di = dictGetIterator(sentinel.masters);</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *master = dictGetVal(de), *match;</span>
<span class="lineNum">    1051 </span>            :         /* We want to share with the same physical Sentinel referenced
<span class="lineNum">    1052 </span>            :          * in other masters, so skip our master. */
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :         if (master == ri-&gt;master) continue;</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :         match = getSentinelRedisInstanceByAddrAndRunID(master-&gt;sentinels,</span>
<span class="lineNum">    1055 </span>            :                                                        NULL,0,ri-&gt;runid);
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :         if (match == NULL) continue; /* No match. */</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :         if (match == ri) continue; /* Should never happen but... safer. */</span>
<span class="lineNum">    1058 </span>            : 
<span class="lineNum">    1059 </span>            :         /* We identified a matching Sentinel, great! Let's free our link
<span class="lineNum">    1060 </span>            :          * and use the one of the matching Sentinel. */
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :         releaseInstanceLink(ri-&gt;link,NULL);</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :         ri-&gt;link = match-&gt;link;</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :         match-&gt;link-&gt;refcount++;</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :         return C_OK;</span>
<span class="lineNum">    1065 </span>            :     }
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :     return C_ERR;</span>
<span class="lineNum">    1068 </span>            : }
<span class="lineNum">    1069 </span>            : 
<span class="lineNum">    1070 </span>            : /* When we detect a Sentinel to switch address (reporting a different IP/port
<span class="lineNum">    1071 </span>            :  * pair in Hello messages), let's update all the matching Sentinels in the
<span class="lineNum">    1072 </span>            :  * context of other masters as well and disconnect the links, so that everybody
<span class="lineNum">    1073 </span>            :  * will be updated.
<a name="1074"><span class="lineNum">    1074 </span>            :  *</a>
<span class="lineNum">    1075 </span>            :  * Return the number of updated Sentinel addresses. */
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 : int sentinelUpdateSentinelAddressInAllMasters(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :     serverAssert(ri-&gt;flags &amp; SRI_SENTINEL);</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :     int reconfigured = 0;</span>
<span class="lineNum">    1081 </span>            : 
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :     di = dictGetIterator(sentinel.masters);</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *master = dictGetVal(de), *match;</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :         match = getSentinelRedisInstanceByAddrAndRunID(master-&gt;sentinels,</span>
<span class="lineNum">    1086 </span>            :                                                        NULL,0,ri-&gt;runid);
<span class="lineNum">    1087 </span>            :         /* If there is no match, this master does not know about this
<span class="lineNum">    1088 </span>            :          * Sentinel, try with the next one. */
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :         if (match == NULL) continue;</span>
<span class="lineNum">    1090 </span>            : 
<span class="lineNum">    1091 </span>            :         /* Disconnect the old links if connected. */
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :         if (match-&gt;link-&gt;cc != NULL)</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :             instanceLinkCloseConnection(match-&gt;link,match-&gt;link-&gt;cc);</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :         if (match-&gt;link-&gt;pc != NULL)</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :             instanceLinkCloseConnection(match-&gt;link,match-&gt;link-&gt;pc);</span>
<span class="lineNum">    1096 </span>            : 
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :         if (match == ri) continue; /* Address already updated for it. */</span>
<span class="lineNum">    1098 </span>            : 
<span class="lineNum">    1099 </span>            :         /* Update the address of the matching Sentinel by copying the address
<span class="lineNum">    1100 </span>            :          * of the Sentinel object that received the address update. */
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :         releaseSentinelAddr(match-&gt;addr);</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :         match-&gt;addr = dupSentinelAddr(ri-&gt;addr);</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :         reconfigured++;</span>
<span class="lineNum">    1104 </span>            :     }
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :     if (reconfigured)</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_NOTICE,&quot;+sentinel-address-update&quot;, ri,</span>
<span class="lineNum">    1108 </span>            :                     &quot;%@ %d additional matching instances&quot;, reconfigured);
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :     return reconfigured;</span>
<span class="lineNum">    1110 </span>            : }
<span class="lineNum">    1111 </span>            : 
<span class="lineNum">    1112 </span>            : /* This function is called when an hiredis connection reported an error.
<span class="lineNum">    1113 </span>            :  * We set it to NULL and mark the link as disconnected so that it will be
<span class="lineNum">    1114 </span>            :  * reconnected again.
<span class="lineNum">    1115 </span>            :  *
<a name="1116"><span class="lineNum">    1116 </span>            :  * Note: we don't free the hiredis context as hiredis will do it for us</a>
<span class="lineNum">    1117 </span>            :  * for async connections. */
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 : void instanceLinkConnectionError(const redisAsyncContext *c) {</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :     instanceLink *link = c-&gt;data;</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :     int pubsub;</span>
<span class="lineNum">    1121 </span>            : 
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :     if (!link) return;</span>
<span class="lineNum">    1123 </span>            : 
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :     pubsub = (link-&gt;pc == c);</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :     if (pubsub)</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :         link-&gt;pc = NULL;</span>
<span class="lineNum">    1127 </span>            :     else
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :         link-&gt;cc = NULL;</span>
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :     link-&gt;disconnected = 1;</span>
<span class="lineNum">    1130 </span>            : }
<span class="lineNum">    1131 </span>            : 
<a name="1132"><span class="lineNum">    1132 </span>            : /* Hiredis connection established / disconnected callbacks. We need them</a>
<span class="lineNum">    1133 </span>            :  * just to cleanup our link state. */
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 : void sentinelLinkEstablishedCallback(const redisAsyncContext *c, int status) {</span>
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :     if (status != C_OK) instanceLinkConnectionError(c);</span>
<a name="1136"><span class="lineNum">    1136 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1137 </span>            : 
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 : void sentinelDisconnectCallback(const redisAsyncContext *c, int status) {</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :     UNUSED(status);</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :     instanceLinkConnectionError(c);</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span>            : /* ========================== sentinelRedisInstance ========================= */
<span class="lineNum">    1144 </span>            : 
<span class="lineNum">    1145 </span>            : /* Create a redis instance, the following fields must be populated by the
<span class="lineNum">    1146 </span>            :  * caller if needed:
<span class="lineNum">    1147 </span>            :  * runid: set to NULL but will be populated once INFO output is received.
<span class="lineNum">    1148 </span>            :  * info_refresh: is set to 0 to mean that we never received INFO so far.
<span class="lineNum">    1149 </span>            :  *
<span class="lineNum">    1150 </span>            :  * If SRI_MASTER is set into initial flags the instance is added to
<span class="lineNum">    1151 </span>            :  * sentinel.masters table.
<span class="lineNum">    1152 </span>            :  *
<span class="lineNum">    1153 </span>            :  * if SRI_SLAVE or SRI_SENTINEL is set then 'master' must be not NULL and the
<span class="lineNum">    1154 </span>            :  * instance is added into master-&gt;slaves or master-&gt;sentinels table.
<span class="lineNum">    1155 </span>            :  *
<span class="lineNum">    1156 </span>            :  * If the instance is a slave or sentinel, the name parameter is ignored and
<span class="lineNum">    1157 </span>            :  * is created automatically as hostname:port.
<span class="lineNum">    1158 </span>            :  *
<span class="lineNum">    1159 </span>            :  * The function fails if hostname can't be resolved or port is out of range.
<span class="lineNum">    1160 </span>            :  * When this happens NULL is returned and errno is set accordingly to the
<span class="lineNum">    1161 </span>            :  * createSentinelAddr() function.
<span class="lineNum">    1162 </span>            :  *
<span class="lineNum">    1163 </span>            :  * The function may also fail and return NULL with errno set to EBUSY if
<span class="lineNum">    1164 </span>            :  * a master with the same name, a slave with the same address, or a sentinel
<a name="1165"><span class="lineNum">    1165 </span>            :  * with the same ID already exists. */</a>
<span class="lineNum">    1166 </span>            : 
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 : sentinelRedisInstance *createSentinelRedisInstance(char *name, int flags, char *hostname, int port, int quorum, sentinelRedisInstance *master) {</span>
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri;</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :     sentinelAddr *addr;</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :     dict *table = NULL;</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :     char slavename[NET_PEER_ID_LEN], *sdsname;</span>
<span class="lineNum">    1172 </span>            : 
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :     serverAssert(flags &amp; (SRI_MASTER|SRI_SLAVE|SRI_SENTINEL));</span>
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :     serverAssert((flags &amp; SRI_MASTER) || master != NULL);</span>
<span class="lineNum">    1175 </span>            : 
<span class="lineNum">    1176 </span>            :     /* Check address validity. */
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :     addr = createSentinelAddr(hostname,port);</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :     if (addr == NULL) return NULL;</span>
<span class="lineNum">    1179 </span>            : 
<span class="lineNum">    1180 </span>            :     /* For slaves use ip:port as name. */
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :     if (flags &amp; SRI_SLAVE) {</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :         anetFormatAddr(slavename, sizeof(slavename), hostname, port);</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :         name = slavename;</span>
<span class="lineNum">    1184 </span>            :     }
<span class="lineNum">    1185 </span>            : 
<span class="lineNum">    1186 </span>            :     /* Make sure the entry is not duplicated. This may happen when the same
<span class="lineNum">    1187 </span>            :      * name for a master is used multiple times inside the configuration or
<span class="lineNum">    1188 </span>            :      * if we try to add multiple times a slave or sentinel with same ip/port
<span class="lineNum">    1189 </span>            :      * to a master. */
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :     if (flags &amp; SRI_MASTER) table = sentinel.masters;</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :     else if (flags &amp; SRI_SLAVE) table = master-&gt;slaves;</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :     else if (flags &amp; SRI_SENTINEL) table = master-&gt;sentinels;</span>
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :     sdsname = sdsnew(name);</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :     if (dictFind(table,sdsname)) {</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :         releaseSentinelAddr(addr);</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :         sdsfree(sdsname);</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :         errno = EBUSY;</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1199 </span>            :     }
<span class="lineNum">    1200 </span>            : 
<span class="lineNum">    1201 </span>            :     /* Create the instance object. */
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :     ri = zmalloc(sizeof(*ri));</span>
<span class="lineNum">    1203 </span>            :     /* Note that all the instances are started in the disconnected state,
<span class="lineNum">    1204 </span>            :      * the event loop will take care of connecting them. */
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :     ri-&gt;flags = flags;</span>
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :     ri-&gt;name = sdsname;</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :     ri-&gt;runid = NULL;</span>
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :     ri-&gt;config_epoch = 0;</span>
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :     ri-&gt;addr = addr;</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :     ri-&gt;link = createInstanceLink();</span>
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :     ri-&gt;last_pub_time = mstime();</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :     ri-&gt;last_hello_time = mstime();</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :     ri-&gt;last_master_down_reply_time = mstime();</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :     ri-&gt;s_down_since_time = 0;</span>
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :     ri-&gt;o_down_since_time = 0;</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :     ri-&gt;down_after_period = master ? master-&gt;down_after_period :</span>
<span class="lineNum">    1217 </span>            :                             SENTINEL_DEFAULT_DOWN_AFTER;
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :     ri-&gt;master_link_down_time = 0;</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :     ri-&gt;auth_pass = NULL;</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :     ri-&gt;slave_priority = SENTINEL_DEFAULT_SLAVE_PRIORITY;</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :     ri-&gt;slave_reconf_sent_time = 0;</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :     ri-&gt;slave_master_host = NULL;</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :     ri-&gt;slave_master_port = 0;</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :     ri-&gt;slave_master_link_status = SENTINEL_MASTER_LINK_STATUS_DOWN;</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :     ri-&gt;slave_repl_offset = 0;</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :     ri-&gt;sentinels = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :     ri-&gt;quorum = quorum;</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :     ri-&gt;parallel_syncs = SENTINEL_DEFAULT_PARALLEL_SYNCS;</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :     ri-&gt;master = master;</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :     ri-&gt;slaves = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :     ri-&gt;info_refresh = 0;</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :     ri-&gt;renamed_commands = dictCreate(&amp;renamedCommandsDictType,NULL);</span>
<span class="lineNum">    1233 </span>            : 
<span class="lineNum">    1234 </span>            :     /* Failover state. */
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :     ri-&gt;leader = NULL;</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :     ri-&gt;leader_epoch = 0;</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :     ri-&gt;failover_epoch = 0;</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_NONE;</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state_change_time = 0;</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :     ri-&gt;failover_start_time = 0;</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :     ri-&gt;failover_timeout = SENTINEL_DEFAULT_FAILOVER_TIMEOUT;</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :     ri-&gt;failover_delay_logged = 0;</span>
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :     ri-&gt;promoted_slave = NULL;</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :     ri-&gt;notification_script = NULL;</span>
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :     ri-&gt;client_reconfig_script = NULL;</span>
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :     ri-&gt;info = NULL;</span>
<span class="lineNum">    1247 </span>            : 
<span class="lineNum">    1248 </span>            :     /* Role */
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :     ri-&gt;role_reported = ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE);</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :     ri-&gt;role_reported_time = mstime();</span>
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :     ri-&gt;slave_conf_change_time = mstime();</span>
<span class="lineNum">    1252 </span>            : 
<span class="lineNum">    1253 </span>            :     /* Add into the right table. */
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :     dictAdd(table, ri-&gt;name, ri);</span>
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :     return ri;</span>
<span class="lineNum">    1256 </span>            : }
<span class="lineNum">    1257 </span>            : 
<span class="lineNum">    1258 </span>            : /* Release this instance and all its slaves, sentinels, hiredis connections.
<span class="lineNum">    1259 </span>            :  * This function does not take care of unlinking the instance from the main
<a name="1260"><span class="lineNum">    1260 </span>            :  * masters table (if it is a master) or from its master sentinels/slaves table</a>
<span class="lineNum">    1261 </span>            :  * if it is a slave or sentinel. */
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 : void releaseSentinelRedisInstance(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    1263 </span>            :     /* Release all its slaves or sentinels if any. */
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :     dictRelease(ri-&gt;sentinels);</span>
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :     dictRelease(ri-&gt;slaves);</span>
<span class="lineNum">    1266 </span>            : 
<span class="lineNum">    1267 </span>            :     /* Disconnect the instance. */
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :     releaseInstanceLink(ri-&gt;link,ri);</span>
<span class="lineNum">    1269 </span>            : 
<span class="lineNum">    1270 </span>            :     /* Free other resources. */
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;name);</span>
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;runid);</span>
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;notification_script);</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;client_reconfig_script);</span>
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;slave_master_host);</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;leader);</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;auth_pass);</span>
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;info);</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :     releaseSentinelAddr(ri-&gt;addr);</span>
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :     dictRelease(ri-&gt;renamed_commands);</span>
<span class="lineNum">    1281 </span>            : 
<span class="lineNum">    1282 </span>            :     /* Clear state into the master if needed. */
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp; (ri-&gt;flags &amp; SRI_PROMOTED) &amp;&amp; ri-&gt;master)</span>
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :         ri-&gt;master-&gt;promoted_slave = NULL;</span>
<span class="lineNum">    1285 </span>            : 
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :     zfree(ri);</span>
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 : }</span>
<a name="1288"><span class="lineNum">    1288 </span>            : </a>
<span class="lineNum">    1289 </span>            : /* Lookup a slave in a master Redis instance, by ip and port. */
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 : sentinelRedisInstance *sentinelRedisInstanceLookupSlave(</span>
<span class="lineNum">    1291 </span>            :                 sentinelRedisInstance *ri, char *ip, int port)
<span class="lineNum">    1292 </span>            : {
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :     sds key;</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *slave;</span>
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :     char buf[NET_PEER_ID_LEN];</span>
<span class="lineNum">    1296 </span>            : 
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :     serverAssert(ri-&gt;flags &amp; SRI_MASTER);</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :     anetFormatAddr(buf,sizeof(buf),ip,port);</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :     key = sdsnew(buf);</span>
<span class="lineNum">    1300 </span><span class="lineNoCov">          0 :     slave = dictFetchValue(ri-&gt;slaves,key);</span>
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :     sdsfree(key);</span>
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :     return slave;</span>
<span class="lineNum">    1303 </span>            : }
<a name="1304"><span class="lineNum">    1304 </span>            : </a>
<span class="lineNum">    1305 </span>            : /* Return the name of the type of the instance as a string. */
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 : const char *sentinelRedisInstanceTypeStr(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) return &quot;master&quot;;</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :     else if (ri-&gt;flags &amp; SRI_SLAVE) return &quot;slave&quot;;</span>
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :     else if (ri-&gt;flags &amp; SRI_SENTINEL) return &quot;sentinel&quot;;</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :     else return &quot;unknown&quot;;</span>
<span class="lineNum">    1311 </span>            : }
<span class="lineNum">    1312 </span>            : 
<span class="lineNum">    1313 </span>            : /* This function remove the Sentinel with the specified ID from the
<span class="lineNum">    1314 </span>            :  * specified master.
<span class="lineNum">    1315 </span>            :  *
<span class="lineNum">    1316 </span>            :  * If &quot;runid&quot; is NULL the function returns ASAP.
<span class="lineNum">    1317 </span>            :  *
<span class="lineNum">    1318 </span>            :  * This function is useful because on Sentinels address switch, we want to
<span class="lineNum">    1319 </span>            :  * remove our old entry and add a new one for the same ID but with the new
<span class="lineNum">    1320 </span>            :  * address.
<span class="lineNum">    1321 </span>            :  *
<a name="1322"><span class="lineNum">    1322 </span>            :  * The function returns 1 if the matching Sentinel was removed, otherwise</a>
<span class="lineNum">    1323 </span>            :  * 0 if there was no Sentinel with this ID. */
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 : int removeMatchingSentinelFromMaster(sentinelRedisInstance *master, char *runid) {</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :     int removed = 0;</span>
<span class="lineNum">    1328 </span>            : 
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :     if (runid == NULL) return 0;</span>
<span class="lineNum">    1330 </span>            : 
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :     di = dictGetSafeIterator(master-&gt;sentinels);</span>
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1334 </span>            : 
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :         if (ri-&gt;runid &amp;&amp; strcmp(ri-&gt;runid,runid) == 0) {</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :             dictDelete(master-&gt;sentinels,ri-&gt;name);</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :             removed++;</span>
<span class="lineNum">    1338 </span>            :         }
<span class="lineNum">    1339 </span>            :     }
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :     return removed;</span>
<span class="lineNum">    1342 </span>            : }
<span class="lineNum">    1343 </span>            : 
<span class="lineNum">    1344 </span>            : /* Search an instance with the same runid, ip and port into a dictionary
<span class="lineNum">    1345 </span>            :  * of instances. Return NULL if not found, otherwise return the instance
<span class="lineNum">    1346 </span>            :  * pointer.
<span class="lineNum">    1347 </span>            :  *
<a name="1348"><span class="lineNum">    1348 </span>            :  * runid or ip can be NULL. In such a case the search is performed only</a>
<span class="lineNum">    1349 </span>            :  * by the non-NULL field. */
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 : sentinelRedisInstance *getSentinelRedisInstanceByAddrAndRunID(dict *instances, char *ip, int port, char *runid) {</span>
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *instance = NULL;</span>
<span class="lineNum">    1354 </span>            : 
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :     serverAssert(ip || runid);   /* User must pass at least one search param. */</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1359 </span>            : 
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :         if (runid &amp;&amp; !ri-&gt;runid) continue;</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :         if ((runid == NULL || strcmp(ri-&gt;runid, runid) == 0) &amp;&amp;</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :             (ip == NULL || (strcmp(ri-&gt;addr-&gt;ip, ip) == 0 &amp;&amp;</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :                             ri-&gt;addr-&gt;port == port)))</span>
<span class="lineNum">    1364 </span>            :         {
<span class="lineNum">    1365 </span>            :             instance = ri;
<span class="lineNum">    1366 </span>            :             break;
<span class="lineNum">    1367 </span>            :         }
<span class="lineNum">    1368 </span>            :     }
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :     return instance;</span>
<span class="lineNum">    1371 </span>            : }
<a name="1372"><span class="lineNum">    1372 </span>            : </a>
<span class="lineNum">    1373 </span>            : /* Master lookup by name */
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 : sentinelRedisInstance *sentinelGetMasterByName(char *name) {</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri;</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :     sds sdsname = sdsnew(name);</span>
<span class="lineNum">    1377 </span>            : 
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :     ri = dictFetchValue(sentinel.masters,sdsname);</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :     sdsfree(sdsname);</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :     return ri;</span>
<span class="lineNum">    1381 </span>            : }
<a name="1382"><span class="lineNum">    1382 </span>            : </a>
<span class="lineNum">    1383 </span>            : /* Add the specified flags to all the instances in the specified dictionary. */
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 : void sentinelAddFlagsToDictOfRedisInstances(dict *instances, int flags) {</span>
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1387 </span>            : 
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :         ri-&gt;flags |= flags;</span>
<span class="lineNum">    1392 </span>            :     }
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1395 </span>            : 
<a name="1396"><span class="lineNum">    1396 </span>            : /* Remove the specified flags to all the instances in the specified</a>
<span class="lineNum">    1397 </span>            :  * dictionary. */
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 : void sentinelDelFlagsToDictOfRedisInstances(dict *instances, int flags) {</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1401 </span>            : 
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :         ri-&gt;flags &amp;= ~flags;</span>
<span class="lineNum">    1406 </span>            :     }
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1409 </span>            : 
<span class="lineNum">    1410 </span>            : /* Reset the state of a monitored master:
<span class="lineNum">    1411 </span>            :  * 1) Remove all slaves.
<span class="lineNum">    1412 </span>            :  * 2) Remove all sentinels.
<span class="lineNum">    1413 </span>            :  * 3) Remove most of the flags resulting from runtime operations.
<span class="lineNum">    1414 </span>            :  * 4) Reset timers to their default value. For example after a reset it will be
<span class="lineNum">    1415 </span>            :  *    possible to failover again the same master ASAP, without waiting the
<span class="lineNum">    1416 </span>            :  *    failover timeout delay.
<span class="lineNum">    1417 </span>            :  * 5) In the process of doing this undo the failover if in progress.
<span class="lineNum">    1418 </span>            :  * 6) Disconnect the connections with the master (will reconnect automatically).
<span class="lineNum">    1419 </span>            :  */
<a name="1420"><span class="lineNum">    1420 </span>            : </a>
<span class="lineNum">    1421 </span>            : #define SENTINEL_RESET_NO_SENTINELS (1&lt;&lt;0)
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 : void sentinelResetMaster(sentinelRedisInstance *ri, int flags) {</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :     serverAssert(ri-&gt;flags &amp; SRI_MASTER);</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :     dictRelease(ri-&gt;slaves);</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :     ri-&gt;slaves = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :     if (!(flags &amp; SENTINEL_RESET_NO_SENTINELS)) {</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :         dictRelease(ri-&gt;sentinels);</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :         ri-&gt;sentinels = dictCreate(&amp;instancesDictType,NULL);</span>
<span class="lineNum">    1429 </span>            :     }
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 :     instanceLinkCloseConnection(ri-&gt;link,ri-&gt;link-&gt;cc);</span>
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :     instanceLinkCloseConnection(ri-&gt;link,ri-&gt;link-&gt;pc);</span>
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :     ri-&gt;flags &amp;= SRI_MASTER;</span>
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :     if (ri-&gt;leader) {</span>
<span class="lineNum">    1434 </span><span class="lineNoCov">          0 :         sdsfree(ri-&gt;leader);</span>
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :         ri-&gt;leader = NULL;</span>
<span class="lineNum">    1436 </span>            :     }
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_NONE;</span>
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state_change_time = 0;</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :     ri-&gt;failover_start_time = 0; /* We can failover again ASAP. */</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :     ri-&gt;promoted_slave = NULL;</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;runid);</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;slave_master_host);</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :     ri-&gt;runid = NULL;</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :     ri-&gt;slave_master_host = NULL;</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;act_ping_time = mstime();</span>
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;last_ping_time = 0;</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;last_avail_time = mstime();</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;last_pong_time = mstime();</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :     ri-&gt;role_reported_time = mstime();</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :     ri-&gt;role_reported = SRI_MASTER;</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :     if (flags &amp; SENTINEL_GENERATE_EVENT)</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;+reset-master&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1454 </span>            : 
<a name="1455"><span class="lineNum">    1455 </span>            : /* Call sentinelResetMaster() on every master with a name matching the specified</a>
<span class="lineNum">    1456 </span>            :  * pattern. */
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 : int sentinelResetMastersByPattern(char *pattern, int flags) {</span>
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :     int reset = 0;</span>
<span class="lineNum">    1461 </span>            : 
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :     di = dictGetIterator(sentinel.masters);</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1465 </span>            : 
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 :         if (ri-&gt;name) {</span>
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :             if (stringmatch(pattern,ri-&gt;name,0)) {</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :                 sentinelResetMaster(ri,flags);</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :                 reset++;</span>
<span class="lineNum">    1470 </span>            :             }
<span class="lineNum">    1471 </span>            :         }
<span class="lineNum">    1472 </span>            :     }
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :     return reset;</span>
<span class="lineNum">    1475 </span>            : }
<span class="lineNum">    1476 </span>            : 
<span class="lineNum">    1477 </span>            : /* Reset the specified master with sentinelResetMaster(), and also change
<span class="lineNum">    1478 </span>            :  * the ip:port address, but take the name of the instance unmodified.
<span class="lineNum">    1479 </span>            :  *
<span class="lineNum">    1480 </span>            :  * This is used to handle the +switch-master event.
<span class="lineNum">    1481 </span>            :  *
<a name="1482"><span class="lineNum">    1482 </span>            :  * The function returns C_ERR if the address can't be resolved for some</a>
<span class="lineNum">    1483 </span>            :  * reason. Otherwise C_OK is returned.  */
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 : int sentinelResetMasterAndChangeAddress(sentinelRedisInstance *master, char *ip, int port) {</span>
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :     sentinelAddr *oldaddr, *newaddr;</span>
<span class="lineNum">    1486 </span><span class="lineNoCov">          0 :     sentinelAddr **slaves = NULL;</span>
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :     int numslaves = 0, j;</span>
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1490 </span>            : 
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :     newaddr = createSentinelAddr(ip,port);</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :     if (newaddr == NULL) return C_ERR;</span>
<span class="lineNum">    1493 </span>            : 
<span class="lineNum">    1494 </span>            :     /* Make a list of slaves to add back after the reset.
<span class="lineNum">    1495 </span>            :      * Don't include the one having the address we are switching to. */
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    1497 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    1499 </span>            : 
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :         if (sentinelAddrIsEqual(slave-&gt;addr,newaddr)) continue;</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :         slaves = zrealloc(slaves,sizeof(sentinelAddr*)*(numslaves+1));</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :         slaves[numslaves++] = createSentinelAddr(slave-&gt;addr-&gt;ip,</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :                                                  slave-&gt;addr-&gt;port);</span>
<span class="lineNum">    1504 </span>            :     }
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1506 </span>            : 
<span class="lineNum">    1507 </span>            :     /* If we are switching to a different address, include the old address
<span class="lineNum">    1508 </span>            :      * as a slave as well, so that we'll be able to sense / reconfigure
<span class="lineNum">    1509 </span>            :      * the old master. */
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :     if (!sentinelAddrIsEqual(newaddr,master-&gt;addr)) {</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :         slaves = zrealloc(slaves,sizeof(sentinelAddr*)*(numslaves+1));</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :         slaves[numslaves++] = createSentinelAddr(master-&gt;addr-&gt;ip,</span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :                                                  master-&gt;addr-&gt;port);</span>
<span class="lineNum">    1514 </span>            :     }
<span class="lineNum">    1515 </span>            : 
<span class="lineNum">    1516 </span>            :     /* Reset and switch address. */
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :     sentinelResetMaster(master,SENTINEL_RESET_NO_SENTINELS);</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :     oldaddr = master-&gt;addr;</span>
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :     master-&gt;addr = newaddr;</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :     master-&gt;o_down_since_time = 0;</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :     master-&gt;s_down_since_time = 0;</span>
<span class="lineNum">    1522 </span>            : 
<span class="lineNum">    1523 </span>            :     /* Add slaves back. */
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; numslaves; j++) {</span>
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *slave;</span>
<span class="lineNum">    1526 </span>            : 
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :         slave = createSentinelRedisInstance(NULL,SRI_SLAVE,slaves[j]-&gt;ip,</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :                     slaves[j]-&gt;port, master-&gt;quorum, master);</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :         releaseSentinelAddr(slaves[j]);</span>
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :         if (slave) sentinelEvent(LL_NOTICE,&quot;+slave&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    1531 </span>            :     }
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :     zfree(slaves);</span>
<span class="lineNum">    1533 </span>            : 
<span class="lineNum">    1534 </span>            :     /* Release the old address at the end so we are safe even if the function
<span class="lineNum">    1535 </span>            :      * gets the master-&gt;addr-&gt;ip and master-&gt;addr-&gt;port as arguments. */
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :     releaseSentinelAddr(oldaddr);</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :     sentinelFlushConfig();</span>
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :     return C_OK;</span>
<span class="lineNum">    1539 </span>            : }
<span class="lineNum">    1540 </span>            : 
<a name="1541"><span class="lineNum">    1541 </span>            : /* Return non-zero if there was no SDOWN or ODOWN error associated to this</a>
<span class="lineNum">    1542 </span>            :  * instance in the latest 'ms' milliseconds. */
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 : int sentinelRedisInstanceNoDownFor(sentinelRedisInstance *ri, mstime_t ms) {</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :     mstime_t most_recent;</span>
<span class="lineNum">    1545 </span>            : 
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :     most_recent = ri-&gt;s_down_since_time;</span>
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 :     if (ri-&gt;o_down_since_time &gt; most_recent)</span>
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :         most_recent = ri-&gt;o_down_since_time;</span>
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :     return most_recent == 0 || (mstime() - most_recent) &gt; ms;</span>
<span class="lineNum">    1550 </span>            : }
<span class="lineNum">    1551 </span>            : 
<a name="1552"><span class="lineNum">    1552 </span>            : /* Return the current master address, that is, its address or the address</a>
<span class="lineNum">    1553 </span>            :  * of the promoted slave if already operational. */
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 : sentinelAddr *sentinelGetCurrentMasterAddress(sentinelRedisInstance *master) {</span>
<span class="lineNum">    1555 </span>            :     /* If we are failing over the master, and the state is already
<span class="lineNum">    1556 </span>            :      * SENTINEL_FAILOVER_STATE_RECONF_SLAVES or greater, it means that we
<span class="lineNum">    1557 </span>            :      * already have the new configuration epoch in the master, and the
<span class="lineNum">    1558 </span>            :      * slave acknowledged the configuration switch. Advertise the new
<span class="lineNum">    1559 </span>            :      * address. */
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :     if ((master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &amp;&amp;</span>
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :         master-&gt;promoted_slave &amp;&amp;</span>
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :         master-&gt;failover_state &gt;= SENTINEL_FAILOVER_STATE_RECONF_SLAVES)</span>
<span class="lineNum">    1563 </span>            :     {
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :         return master-&gt;promoted_slave-&gt;addr;</span>
<span class="lineNum">    1565 </span>            :     } else {
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :         return master-&gt;addr;</span>
<span class="lineNum">    1567 </span>            :     }
<span class="lineNum">    1568 </span>            : }
<span class="lineNum">    1569 </span>            : 
<a name="1570"><span class="lineNum">    1570 </span>            : /* This function sets the down_after_period field value in 'master' to all</a>
<span class="lineNum">    1571 </span>            :  * the slaves and sentinel instances connected to this master. */
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 : void sentinelPropagateDownAfterPeriod(sentinelRedisInstance *master) {</span>
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :     int j;</span>
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :     dict *d[] = {master-&gt;slaves, master-&gt;sentinels, NULL};</span>
<span class="lineNum">    1577 </span>            : 
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :     for (j = 0; d[j]; j++) {</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :         di = dictGetIterator(d[j]);</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :         while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :             sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :             ri-&gt;down_after_period = master-&gt;down_after_period;</span>
<span class="lineNum">    1583 </span>            :         }
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :         dictReleaseIterator(di);</span>
<span class="lineNum">    1585 </span>            :     }
<a name="1586"><span class="lineNum">    1586 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1587 </span>            : 
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 : char *sentinelGetInstanceTypeString(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) return &quot;master&quot;;</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :     else if (ri-&gt;flags &amp; SRI_SLAVE) return &quot;slave&quot;;</span>
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :     else if (ri-&gt;flags &amp; SRI_SENTINEL) return &quot;sentinel&quot;;</span>
<span class="lineNum">    1592 </span><span class="lineNoCov">          0 :     else return &quot;unknown&quot;;</span>
<span class="lineNum">    1593 </span>            : }
<span class="lineNum">    1594 </span>            : 
<span class="lineNum">    1595 </span>            : /* This function is used in order to send commands to Redis instances: the
<span class="lineNum">    1596 </span>            :  * commands we send from Sentinel may be renamed, a common case is a master
<span class="lineNum">    1597 </span>            :  * with CONFIG and SLAVEOF commands renamed for security concerns. In that
<span class="lineNum">    1598 </span>            :  * case we check the ri-&gt;renamed_command table (or if the instance is a slave,
<span class="lineNum">    1599 </span>            :  * we check the one of the master), and map the command that we should send
<a name="1600"><span class="lineNum">    1600 </span>            :  * to the set of renamed commads. However, if the command was not renamed,</a>
<span class="lineNum">    1601 </span>            :  * we just return &quot;command&quot; itself. */
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 : char *sentinelInstanceMapCommand(sentinelRedisInstance *ri, char *command) {</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :     sds sc = sdsnew(command);</span>
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :     if (ri-&gt;master) ri = ri-&gt;master;</span>
<span class="lineNum">    1605 </span><span class="lineNoCov">          0 :     char *retval = dictFetchValue(ri-&gt;renamed_commands, sc);</span>
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :     sdsfree(sc);</span>
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :     return retval ? retval : command;</span>
<span class="lineNum">    1608 </span>            : }
<a name="1609"><span class="lineNum">    1609 </span>            : </a>
<span class="lineNum">    1610 </span>            : /* ============================ Config handling ============================= */
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 : char *sentinelHandleConfiguration(char **argv, int argc) {</span>
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri;</span>
<span class="lineNum">    1613 </span>            : 
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :     if (!strcasecmp(argv[0],&quot;monitor&quot;) &amp;&amp; argc == 5) {</span>
<span class="lineNum">    1615 </span>            :         /* monitor &lt;name&gt; &lt;host&gt; &lt;port&gt; &lt;quorum&gt; */
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :         int quorum = atoi(argv[4]);</span>
<span class="lineNum">    1617 </span>            : 
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :         if (quorum &lt;= 0) return &quot;Quorum must be 1 or greater.&quot;;</span>
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :         if (createSentinelRedisInstance(argv[1],SRI_MASTER,argv[2],</span>
<span class="lineNum">    1620 </span>            :                                         atoi(argv[3]),quorum,NULL) == NULL)
<span class="lineNum">    1621 </span>            :         {
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :             switch(errno) {</span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :             case EBUSY: return &quot;Duplicated master name.&quot;;</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :             case ENOENT: return &quot;Can't resolve master instance hostname.&quot;;</span>
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :             case EINVAL: return &quot;Invalid port number&quot;;</span>
<span class="lineNum">    1626 </span>            :             }
<span class="lineNum">    1627 </span>            :         }
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;down-after-milliseconds&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1629 </span>            :         /* down-after-milliseconds &lt;name&gt; &lt;milliseconds&gt; */
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :         ri-&gt;down_after_period = atoi(argv[2]);</span>
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :         if (ri-&gt;down_after_period &lt;= 0)</span>
<span class="lineNum">    1634 </span>            :             return &quot;negative or zero time parameter.&quot;;
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :         sentinelPropagateDownAfterPeriod(ri);</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;failover-timeout&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1637 </span>            :         /* failover-timeout &lt;name&gt; &lt;milliseconds&gt; */
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :         ri-&gt;failover_timeout = atoi(argv[2]);</span>
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :         if (ri-&gt;failover_timeout &lt;= 0)</span>
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :             return &quot;negative or zero time parameter.&quot;;</span>
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :    } else if (!strcasecmp(argv[0],&quot;parallel-syncs&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1644 </span>            :         /* parallel-syncs &lt;name&gt; &lt;milliseconds&gt; */
<span class="lineNum">    1645 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :         ri-&gt;parallel_syncs = atoi(argv[2]);</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :    } else if (!strcasecmp(argv[0],&quot;notification-script&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1649 </span>            :         /* notification-script &lt;name&gt; &lt;path&gt; */
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :         if (access(argv[2],X_OK) == -1)</span>
<span class="lineNum">    1653 </span>            :             return &quot;Notification script seems non existing or non executable.&quot;;
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :         ri-&gt;notification_script = sdsnew(argv[2]);</span>
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :    } else if (!strcasecmp(argv[0],&quot;client-reconfig-script&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1656 </span>            :         /* client-reconfig-script &lt;name&gt; &lt;path&gt; */
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1658 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :         if (access(argv[2],X_OK) == -1)</span>
<span class="lineNum">    1660 </span>            :             return &quot;Client reconfiguration script seems non existing or &quot;
<span class="lineNum">    1661 </span>            :                    &quot;non executable.&quot;;
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :         ri-&gt;client_reconfig_script = sdsnew(argv[2]);</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :    } else if (!strcasecmp(argv[0],&quot;auth-pass&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1664 </span>            :         /* auth-pass &lt;name&gt; &lt;password&gt; */
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :         ri-&gt;auth_pass = sdsnew(argv[2]);</span>
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;current-epoch&quot;) &amp;&amp; argc == 2) {</span>
<span class="lineNum">    1669 </span>            :         /* current-epoch &lt;epoch&gt; */
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :         unsigned long long current_epoch = strtoull(argv[1],NULL,10);</span>
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :         if (current_epoch &gt; sentinel.current_epoch)</span>
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :             sentinel.current_epoch = current_epoch;</span>
<span class="lineNum">    1673 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;myid&quot;) &amp;&amp; argc == 2) {</span>
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :         if (strlen(argv[1]) != CONFIG_RUN_ID_SIZE)</span>
<span class="lineNum">    1675 </span>            :             return &quot;Malformed Sentinel id in myid option.&quot;;
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :         memcpy(sentinel.myid,argv[1],CONFIG_RUN_ID_SIZE);</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;config-epoch&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1678 </span>            :         /* config-epoch &lt;name&gt; &lt;epoch&gt; */
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1680 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 :         ri-&gt;config_epoch = strtoull(argv[2],NULL,10);</span>
<span class="lineNum">    1682 </span>            :         /* The following update of current_epoch is not really useful as
<span class="lineNum">    1683 </span>            :          * now the current epoch is persisted on the config file, but
<span class="lineNum">    1684 </span>            :          * we leave this check here for redundancy. */
<span class="lineNum">    1685 </span><span class="lineNoCov">          0 :         if (ri-&gt;config_epoch &gt; sentinel.current_epoch)</span>
<span class="lineNum">    1686 </span><span class="lineNoCov">          0 :             sentinel.current_epoch = ri-&gt;config_epoch;</span>
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;leader-epoch&quot;) &amp;&amp; argc == 3) {</span>
<span class="lineNum">    1688 </span>            :         /* leader-epoch &lt;name&gt; &lt;epoch&gt; */
<span class="lineNum">    1689 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :         ri-&gt;leader_epoch = strtoull(argv[2],NULL,10);</span>
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :     } else if ((!strcasecmp(argv[0],&quot;known-slave&quot;) ||</span>
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :                 !strcasecmp(argv[0],&quot;known-replica&quot;)) &amp;&amp; argc == 4)</span>
<span class="lineNum">    1694 </span>            :     {
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *slave;</span>
<span class="lineNum">    1696 </span>            : 
<span class="lineNum">    1697 </span>            :         /* known-replica &lt;name&gt; &lt;ip&gt; &lt;port&gt; */
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1700 </span><span class="lineNoCov">          0 :         if ((slave = createSentinelRedisInstance(NULL,SRI_SLAVE,argv[2],</span>
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 :                     atoi(argv[3]), ri-&gt;quorum, ri)) == NULL)</span>
<span class="lineNum">    1702 </span>            :         {
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :             return &quot;Wrong hostname or port for replica.&quot;;</span>
<span class="lineNum">    1704 </span>            :         }
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;known-sentinel&quot;) &amp;&amp;</span>
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :                (argc == 4 || argc == 5)) {</span>
<span class="lineNum">    1707 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *si;</span>
<span class="lineNum">    1708 </span>            : 
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :         if (argc == 5) { /* Ignore the old form without runid. */</span>
<span class="lineNum">    1710 </span>            :             /* known-sentinel &lt;name&gt; &lt;ip&gt; &lt;port&gt; [runid] */
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :             ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :             if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 :             if ((si = createSentinelRedisInstance(argv[4],SRI_SENTINEL,argv[2],</span>
<span class="lineNum">    1714 </span><span class="lineNoCov">          0 :                         atoi(argv[3]), ri-&gt;quorum, ri)) == NULL)</span>
<span class="lineNum">    1715 </span>            :             {
<span class="lineNum">    1716 </span>            :                 return &quot;Wrong hostname or port for sentinel.&quot;;
<span class="lineNum">    1717 </span>            :             }
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :             si-&gt;runid = sdsnew(argv[4]);</span>
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 :             sentinelTryConnectionSharing(si);</span>
<span class="lineNum">    1720 </span>            :         }
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;rename-command&quot;) &amp;&amp; argc == 4) {</span>
<span class="lineNum">    1722 </span>            :         /* rename-command &lt;name&gt; &lt;command&gt; &lt;renamed-command&gt; */
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(argv[1]);</span>
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :         if (!ri) return &quot;No such master with specified name.&quot;;</span>
<span class="lineNum">    1725 </span><span class="lineNoCov">          0 :         sds oldcmd = sdsnew(argv[2]);</span>
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :         sds newcmd = sdsnew(argv[3]);</span>
<span class="lineNum">    1727 </span><span class="lineNoCov">          0 :         if (dictAdd(ri-&gt;renamed_commands,oldcmd,newcmd) != DICT_OK) {</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :             sdsfree(oldcmd);</span>
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 :             sdsfree(newcmd);</span>
<span class="lineNum">    1730 </span><span class="lineNoCov">          0 :             return &quot;Same command renamed multiple times with rename-command.&quot;;</span>
<span class="lineNum">    1731 </span>            :         }
<span class="lineNum">    1732 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;announce-ip&quot;) &amp;&amp; argc == 2) {</span>
<span class="lineNum">    1733 </span>            :         /* announce-ip &lt;ip-address&gt; */
<span class="lineNum">    1734 </span><span class="lineNoCov">          0 :         if (strlen(argv[1]))</span>
<span class="lineNum">    1735 </span><span class="lineNoCov">          0 :             sentinel.announce_ip = sdsnew(argv[1]);</span>
<span class="lineNum">    1736 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;announce-port&quot;) &amp;&amp; argc == 2) {</span>
<span class="lineNum">    1737 </span>            :         /* announce-port &lt;port&gt; */
<span class="lineNum">    1738 </span><span class="lineNoCov">          0 :         sentinel.announce_port = atoi(argv[1]);</span>
<span class="lineNum">    1739 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(argv[0],&quot;deny-scripts-reconfig&quot;) &amp;&amp; argc == 2) {</span>
<span class="lineNum">    1740 </span>            :         /* deny-scripts-reconfig &lt;yes|no&gt; */
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :         if ((sentinel.deny_scripts_reconfig = yesnotoi(argv[1])) == -1) {</span>
<span class="lineNum">    1742 </span><span class="lineNoCov">          0 :             return &quot;Please specify yes or no for the &quot;</span>
<span class="lineNum">    1743 </span>            :                    &quot;deny-scripts-reconfig options.&quot;;
<span class="lineNum">    1744 </span>            :         }
<span class="lineNum">    1745 </span>            :     } else {
<span class="lineNum">    1746 </span>            :         return &quot;Unrecognized sentinel configuration statement.&quot;;
<span class="lineNum">    1747 </span>            :     }
<span class="lineNum">    1748 </span>            :     return NULL;
<span class="lineNum">    1749 </span>            : }
<span class="lineNum">    1750 </span>            : 
<span class="lineNum">    1751 </span>            : /* Implements CONFIG REWRITE for &quot;sentinel&quot; option.
<span class="lineNum">    1752 </span>            :  * This is used not just to rewrite the configuration given by the user
<span class="lineNum">    1753 </span>            :  * (the configured masters) but also in order to retain the state of
<a name="1754"><span class="lineNum">    1754 </span>            :  * Sentinel across restarts: config epoch of masters, associated slaves</a>
<span class="lineNum">    1755 </span>            :  * and sentinel instances, and so forth. */
<span class="lineNum">    1756 </span><span class="lineNoCov">          0 : void rewriteConfigSentinelOption(struct rewriteConfigState *state) {</span>
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :     dictIterator *di, *di2;</span>
<span class="lineNum">    1758 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    1759 </span><span class="lineNoCov">          0 :     sds line;</span>
<span class="lineNum">    1760 </span>            : 
<span class="lineNum">    1761 </span>            :     /* sentinel unique ID. */
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :     line = sdscatprintf(sdsempty(), &quot;sentinel myid %s&quot;, sentinel.myid);</span>
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 :     rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1764 </span>            : 
<span class="lineNum">    1765 </span>            :     /* sentinel deny-scripts-reconfig. */
<span class="lineNum">    1766 </span><span class="lineNoCov">          0 :     line = sdscatprintf(sdsempty(), &quot;sentinel deny-scripts-reconfig %s&quot;,</span>
<span class="lineNum">    1767 </span><span class="lineNoCov">          0 :         sentinel.deny_scripts_reconfig ? &quot;yes&quot; : &quot;no&quot;);</span>
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :     rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,</span>
<span class="lineNum">    1769 </span><span class="lineNoCov">          0 :         sentinel.deny_scripts_reconfig != SENTINEL_DEFAULT_DENY_SCRIPTS_RECONFIG);</span>
<span class="lineNum">    1770 </span>            : 
<span class="lineNum">    1771 </span>            :     /* For every master emit a &quot;sentinel monitor&quot; config entry. */
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :     di = dictGetIterator(sentinel.masters);</span>
<span class="lineNum">    1773 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    1774 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *master, *ri;</span>
<span class="lineNum">    1775 </span><span class="lineNoCov">          0 :         sentinelAddr *master_addr;</span>
<span class="lineNum">    1776 </span>            : 
<span class="lineNum">    1777 </span>            :         /* sentinel monitor */
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :         master = dictGetVal(de);</span>
<span class="lineNum">    1779 </span><span class="lineNoCov">          0 :         master_addr = sentinelGetCurrentMasterAddress(master);</span>
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :         line = sdscatprintf(sdsempty(),&quot;sentinel monitor %s %s %d %d&quot;,</span>
<span class="lineNum">    1781 </span>            :             master-&gt;name, master_addr-&gt;ip, master_addr-&gt;port,
<span class="lineNum">    1782 </span>            :             master-&gt;quorum);
<span class="lineNum">    1783 </span><span class="lineNoCov">          0 :         rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1784 </span>            : 
<span class="lineNum">    1785 </span>            :         /* sentinel down-after-milliseconds */
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :         if (master-&gt;down_after_period != SENTINEL_DEFAULT_DOWN_AFTER) {</span>
<span class="lineNum">    1787 </span><span class="lineNoCov">          0 :             line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1788 </span>            :                 &quot;sentinel down-after-milliseconds %s %ld&quot;,
<span class="lineNum">    1789 </span>            :                 master-&gt;name, (long) master-&gt;down_after_period);
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 :             rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1791 </span>            :         }
<span class="lineNum">    1792 </span>            : 
<span class="lineNum">    1793 </span>            :         /* sentinel failover-timeout */
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :         if (master-&gt;failover_timeout != SENTINEL_DEFAULT_FAILOVER_TIMEOUT) {</span>
<span class="lineNum">    1795 </span><span class="lineNoCov">          0 :             line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1796 </span>            :                 &quot;sentinel failover-timeout %s %ld&quot;,
<span class="lineNum">    1797 </span>            :                 master-&gt;name, (long) master-&gt;failover_timeout);
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :             rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1799 </span>            :         }
<span class="lineNum">    1800 </span>            : 
<span class="lineNum">    1801 </span>            :         /* sentinel parallel-syncs */
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :         if (master-&gt;parallel_syncs != SENTINEL_DEFAULT_PARALLEL_SYNCS) {</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 :             line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1804 </span>            :                 &quot;sentinel parallel-syncs %s %d&quot;,
<span class="lineNum">    1805 </span>            :                 master-&gt;name, master-&gt;parallel_syncs);
<span class="lineNum">    1806 </span><span class="lineNoCov">          0 :             rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1807 </span>            :         }
<span class="lineNum">    1808 </span>            : 
<span class="lineNum">    1809 </span>            :         /* sentinel notification-script */
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :         if (master-&gt;notification_script) {</span>
<span class="lineNum">    1811 </span><span class="lineNoCov">          0 :             line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1812 </span>            :                 &quot;sentinel notification-script %s %s&quot;,
<span class="lineNum">    1813 </span>            :                 master-&gt;name, master-&gt;notification_script);
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :             rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1815 </span>            :         }
<span class="lineNum">    1816 </span>            : 
<span class="lineNum">    1817 </span>            :         /* sentinel client-reconfig-script */
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :         if (master-&gt;client_reconfig_script) {</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :             line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1820 </span>            :                 &quot;sentinel client-reconfig-script %s %s&quot;,
<span class="lineNum">    1821 </span>            :                 master-&gt;name, master-&gt;client_reconfig_script);
<span class="lineNum">    1822 </span><span class="lineNoCov">          0 :             rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1823 </span>            :         }
<span class="lineNum">    1824 </span>            : 
<span class="lineNum">    1825 </span>            :         /* sentinel auth-pass */
<span class="lineNum">    1826 </span><span class="lineNoCov">          0 :         if (master-&gt;auth_pass) {</span>
<span class="lineNum">    1827 </span><span class="lineNoCov">          0 :             line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1828 </span>            :                 &quot;sentinel auth-pass %s %s&quot;,
<span class="lineNum">    1829 </span>            :                 master-&gt;name, master-&gt;auth_pass);
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :             rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1831 </span>            :         }
<span class="lineNum">    1832 </span>            : 
<span class="lineNum">    1833 </span>            :         /* sentinel config-epoch */
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :         line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1835 </span>            :             &quot;sentinel config-epoch %s %llu&quot;,
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :             master-&gt;name, (unsigned long long) master-&gt;config_epoch);</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :         rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1838 </span>            : 
<span class="lineNum">    1839 </span>            :         /* sentinel leader-epoch */
<span class="lineNum">    1840 </span><span class="lineNoCov">          0 :         line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1841 </span>            :             &quot;sentinel leader-epoch %s %llu&quot;,
<span class="lineNum">    1842 </span><span class="lineNoCov">          0 :             master-&gt;name, (unsigned long long) master-&gt;leader_epoch);</span>
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 :         rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1844 </span>            : 
<span class="lineNum">    1845 </span>            :         /* sentinel known-slave */
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :         di2 = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    1847 </span><span class="lineNoCov">          0 :         while((de = dictNext(di2)) != NULL) {</span>
<span class="lineNum">    1848 </span><span class="lineNoCov">          0 :             sentinelAddr *slave_addr;</span>
<span class="lineNum">    1849 </span>            : 
<span class="lineNum">    1850 </span><span class="lineNoCov">          0 :             ri = dictGetVal(de);</span>
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :             slave_addr = ri-&gt;addr;</span>
<span class="lineNum">    1852 </span>            : 
<span class="lineNum">    1853 </span>            :             /* If master_addr (obtained using sentinelGetCurrentMasterAddress()
<span class="lineNum">    1854 </span>            :              * so it may be the address of the promoted slave) is equal to this
<span class="lineNum">    1855 </span>            :              * slave's address, a failover is in progress and the slave was
<span class="lineNum">    1856 </span>            :              * already successfully promoted. So as the address of this slave
<span class="lineNum">    1857 </span>            :              * we use the old master address instead. */
<span class="lineNum">    1858 </span><span class="lineNoCov">          0 :             if (sentinelAddrIsEqual(slave_addr,master_addr))</span>
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 :                 slave_addr = master-&gt;addr;</span>
<span class="lineNum">    1860 </span><span class="lineNoCov">          0 :             line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1861 </span>            :                 &quot;sentinel known-replica %s %s %d&quot;,
<span class="lineNum">    1862 </span>            :                 master-&gt;name, slave_addr-&gt;ip, slave_addr-&gt;port);
<span class="lineNum">    1863 </span><span class="lineNoCov">          0 :             rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1864 </span>            :         }
<span class="lineNum">    1865 </span><span class="lineNoCov">          0 :         dictReleaseIterator(di2);</span>
<span class="lineNum">    1866 </span>            : 
<span class="lineNum">    1867 </span>            :         /* sentinel known-sentinel */
<span class="lineNum">    1868 </span><span class="lineNoCov">          0 :         di2 = dictGetIterator(master-&gt;sentinels);</span>
<span class="lineNum">    1869 </span><span class="lineNoCov">          0 :         while((de = dictNext(di2)) != NULL) {</span>
<span class="lineNum">    1870 </span><span class="lineNoCov">          0 :             ri = dictGetVal(de);</span>
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :             if (ri-&gt;runid == NULL) continue;</span>
<span class="lineNum">    1872 </span><span class="lineNoCov">          0 :             line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1873 </span>            :                 &quot;sentinel known-sentinel %s %s %d %s&quot;,
<span class="lineNum">    1874 </span><span class="lineNoCov">          0 :                 master-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port, ri-&gt;runid);</span>
<span class="lineNum">    1875 </span><span class="lineNoCov">          0 :             rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1876 </span>            :         }
<span class="lineNum">    1877 </span><span class="lineNoCov">          0 :         dictReleaseIterator(di2);</span>
<span class="lineNum">    1878 </span>            : 
<span class="lineNum">    1879 </span>            :         /* sentinel rename-command */
<span class="lineNum">    1880 </span><span class="lineNoCov">          0 :         di2 = dictGetIterator(master-&gt;renamed_commands);</span>
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 :         while((de = dictNext(di2)) != NULL) {</span>
<span class="lineNum">    1882 </span><span class="lineNoCov">          0 :             sds oldname = dictGetKey(de);</span>
<span class="lineNum">    1883 </span><span class="lineNoCov">          0 :             sds newname = dictGetVal(de);</span>
<span class="lineNum">    1884 </span><span class="lineNoCov">          0 :             line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1885 </span>            :                 &quot;sentinel rename-command %s %s %s&quot;,
<span class="lineNum">    1886 </span>            :                 master-&gt;name, oldname, newname);
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :             rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1888 </span>            :         }
<span class="lineNum">    1889 </span><span class="lineNoCov">          0 :         dictReleaseIterator(di2);</span>
<span class="lineNum">    1890 </span>            :     }
<span class="lineNum">    1891 </span>            : 
<span class="lineNum">    1892 </span>            :     /* sentinel current-epoch is a global state valid for all the masters. */
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 :     line = sdscatprintf(sdsempty(),</span>
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :         &quot;sentinel current-epoch %llu&quot;, (unsigned long long) sentinel.current_epoch);</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :     rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1896 </span>            : 
<span class="lineNum">    1897 </span>            :     /* sentinel announce-ip. */
<span class="lineNum">    1898 </span><span class="lineNoCov">          0 :     if (sentinel.announce_ip) {</span>
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :         line = sdsnew(&quot;sentinel announce-ip &quot;);</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :         line = sdscatrepr(line, sentinel.announce_ip, sdslen(sentinel.announce_ip));</span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :         rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1902 </span>            :     }
<span class="lineNum">    1903 </span>            : 
<span class="lineNum">    1904 </span>            :     /* sentinel announce-port. */
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :     if (sentinel.announce_port) {</span>
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :         line = sdscatprintf(sdsempty(),&quot;sentinel announce-port %d&quot;,</span>
<span class="lineNum">    1907 </span>            :                             sentinel.announce_port);
<span class="lineNum">    1908 </span><span class="lineNoCov">          0 :         rewriteConfigRewriteLine(state,&quot;sentinel&quot;,line,1);</span>
<span class="lineNum">    1909 </span>            :     }
<span class="lineNum">    1910 </span>            : 
<span class="lineNum">    1911 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    1912 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1913 </span>            : 
<span class="lineNum">    1914 </span>            : /* This function uses the config rewriting Redis engine in order to persist
<span class="lineNum">    1915 </span>            :  * the state of the Sentinel in the current configuration file.
<span class="lineNum">    1916 </span>            :  *
<span class="lineNum">    1917 </span>            :  * Before returning the function calls fsync() against the generated
<span class="lineNum">    1918 </span>            :  * configuration file to make sure changes are committed to disk.
<a name="1919"><span class="lineNum">    1919 </span>            :  *</a>
<span class="lineNum">    1920 </span>            :  * On failure the function logs a warning on the Redis log. */
<span class="lineNum">    1921 </span><span class="lineNoCov">          0 : void sentinelFlushConfig(void) {</span>
<span class="lineNum">    1922 </span><span class="lineNoCov">          0 :     int fd = -1;</span>
<span class="lineNum">    1923 </span><span class="lineNoCov">          0 :     int saved_hz = server.hz;</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :     int rewrite_status;</span>
<span class="lineNum">    1925 </span>            : 
<span class="lineNum">    1926 </span><span class="lineNoCov">          0 :     server.hz = CONFIG_DEFAULT_HZ;</span>
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :     rewrite_status = rewriteConfig(server.configfile);</span>
<span class="lineNum">    1928 </span><span class="lineNoCov">          0 :     server.hz = saved_hz;</span>
<span class="lineNum">    1929 </span>            : 
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :     if (rewrite_status == -1) goto werr;</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :     if ((fd = open(server.configfile,O_RDONLY)) == -1) goto werr;</span>
<span class="lineNum">    1932 </span><span class="lineNoCov">          0 :     if (fsync(fd) == -1) goto werr;</span>
<span class="lineNum">    1933 </span><span class="lineNoCov">          0 :     if (close(fd) == EOF) goto werr;</span>
<span class="lineNum">    1934 </span>            :     return;
<span class="lineNum">    1935 </span>            : 
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 : werr:</span>
<span class="lineNum">    1937 </span><span class="lineNoCov">          0 :     if (fd != -1) close(fd);</span>
<span class="lineNum">    1938 </span><span class="lineNoCov">          0 :     serverLog(LL_WARNING,&quot;WARNING: Sentinel was not able to save the new configuration on disk!!!: %s&quot;, strerror(errno));</span>
<span class="lineNum">    1939 </span>            : }
<span class="lineNum">    1940 </span>            : 
<span class="lineNum">    1941 </span>            : /* ====================== hiredis connection handling ======================= */
<span class="lineNum">    1942 </span>            : 
<span class="lineNum">    1943 </span>            : /* Send the AUTH command with the specified master password if needed.
<span class="lineNum">    1944 </span>            :  * Note that for slaves the password set for the master is used.
<span class="lineNum">    1945 </span>            :  *
<span class="lineNum">    1946 </span>            :  * In case this Sentinel requires a password as well, via the &quot;requirepass&quot;
<span class="lineNum">    1947 </span>            :  * configuration directive, we assume we should use the local password in
<span class="lineNum">    1948 </span>            :  * order to authenticate when connecting with the other Sentinels as well.
<span class="lineNum">    1949 </span>            :  * So basically all the Sentinels share the same password and use it to
<span class="lineNum">    1950 </span>            :  * authenticate reciprocally.
<span class="lineNum">    1951 </span>            :  *
<span class="lineNum">    1952 </span>            :  * We don't check at all if the command was successfully transmitted
<a name="1953"><span class="lineNum">    1953 </span>            :  * to the instance as if it fails Sentinel will detect the instance down,</a>
<span class="lineNum">    1954 </span>            :  * will disconnect and reconnect the link and so forth. */
<span class="lineNum">    1955 </span><span class="lineNoCov">          0 : void sentinelSendAuthIfNeeded(sentinelRedisInstance *ri, redisAsyncContext *c) {</span>
<span class="lineNum">    1956 </span><span class="lineNoCov">          0 :     char *auth_pass = NULL;</span>
<span class="lineNum">    1957 </span>            : 
<span class="lineNum">    1958 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) {</span>
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :         auth_pass = ri-&gt;auth_pass;</span>
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :     } else if (ri-&gt;flags &amp; SRI_SLAVE) {</span>
<span class="lineNum">    1961 </span><span class="lineNoCov">          0 :         auth_pass = ri-&gt;master-&gt;auth_pass;</span>
<span class="lineNum">    1962 </span><span class="lineNoCov">          0 :     } else if (ri-&gt;flags &amp; SRI_SENTINEL) {</span>
<span class="lineNum">    1963 </span><span class="lineNoCov">          0 :         if (server.requirepass) auth_pass = server.requirepass;</span>
<span class="lineNum">    1964 </span>            :     }
<span class="lineNum">    1965 </span>            : 
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :     if (auth_pass) {</span>
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 :         if (redisAsyncCommand(c, sentinelDiscardReplyCallback, ri, &quot;%s %s&quot;,</span>
<span class="lineNum">    1968 </span>            :             sentinelInstanceMapCommand(ri,&quot;AUTH&quot;),
<span class="lineNum">    1969 </span><span class="lineNoCov">          0 :             auth_pass) == C_OK) ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    1970 </span>            :     }
<span class="lineNum">    1971 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1972 </span>            : 
<span class="lineNum">    1973 </span>            : /* Use CLIENT SETNAME to name the connection in the Redis instance as
<span class="lineNum">    1974 </span>            :  * sentinel-&lt;first_8_chars_of_runid&gt;-&lt;connection_type&gt;
<span class="lineNum">    1975 </span>            :  * The connection type is &quot;cmd&quot; or &quot;pubsub&quot; as specified by 'type'.
<span class="lineNum">    1976 </span>            :  *
<a name="1977"><span class="lineNum">    1977 </span>            :  * This makes it possible to list all the sentinel instances connected</a>
<span class="lineNum">    1978 </span>            :  * to a Redis servewr with CLIENT LIST, grepping for a specific name format. */
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 : void sentinelSetClientName(sentinelRedisInstance *ri, redisAsyncContext *c, char *type) {</span>
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :     char name[64];</span>
<span class="lineNum">    1981 </span>            : 
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :     snprintf(name,sizeof(name),&quot;sentinel-%.8s-%s&quot;,sentinel.myid,type);</span>
<span class="lineNum">    1983 </span><span class="lineNoCov">          0 :     if (redisAsyncCommand(c, sentinelDiscardReplyCallback, ri,</span>
<span class="lineNum">    1984 </span>            :         &quot;%s SETNAME %s&quot;,
<span class="lineNum">    1985 </span>            :         sentinelInstanceMapCommand(ri,&quot;CLIENT&quot;),
<span class="lineNum">    1986 </span>            :         name) == C_OK)
<span class="lineNum">    1987 </span>            :     {
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :         ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    1989 </span>            :     }
<span class="lineNum">    1990 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1991 </span>            : 
<span class="lineNum">    1992 </span>            : /* Create the async connections for the instance link if the link
<a name="1993"><span class="lineNum">    1993 </span>            :  * is disconnected. Note that link-&gt;disconnected is true even if just</a>
<span class="lineNum">    1994 </span>            :  * one of the two links (commands and pub/sub) is missing. */
<span class="lineNum">    1995 </span><span class="lineNoCov">          0 : void sentinelReconnectInstance(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    1996 </span><span class="lineNoCov">          0 :     if (ri-&gt;link-&gt;disconnected == 0) return;</span>
<span class="lineNum">    1997 </span><span class="lineNoCov">          0 :     if (ri-&gt;addr-&gt;port == 0) return; /* port == 0 means invalid address. */</span>
<span class="lineNum">    1998 </span><span class="lineNoCov">          0 :     instanceLink *link = ri-&gt;link;</span>
<span class="lineNum">    1999 </span><span class="lineNoCov">          0 :     mstime_t now = mstime();</span>
<span class="lineNum">    2000 </span>            : 
<span class="lineNum">    2001 </span><span class="lineNoCov">          0 :     if (now - ri-&gt;link-&gt;last_reconn_time &lt; SENTINEL_PING_PERIOD) return;</span>
<span class="lineNum">    2002 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;last_reconn_time = now;</span>
<span class="lineNum">    2003 </span>            : 
<span class="lineNum">    2004 </span>            :     /* Commands connection. */
<span class="lineNum">    2005 </span><span class="lineNoCov">          0 :     if (link-&gt;cc == NULL) {</span>
<span class="lineNum">    2006 </span><span class="lineNoCov">          0 :         link-&gt;cc = redisAsyncConnectBind(ri-&gt;addr-&gt;ip,ri-&gt;addr-&gt;port,NET_FIRST_BIND_ADDR);</span>
<span class="lineNum">    2007 </span><span class="lineNoCov">          0 :         if (link-&gt;cc-&gt;err) {</span>
<span class="lineNum">    2008 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_DEBUG,&quot;-cmd-link-reconnection&quot;,ri,&quot;%@ #%s&quot;,</span>
<span class="lineNum">    2009 </span>            :                 link-&gt;cc-&gt;errstr);
<span class="lineNum">    2010 </span><span class="lineNoCov">          0 :             instanceLinkCloseConnection(link,link-&gt;cc);</span>
<span class="lineNum">    2011 </span>            :         } else {
<span class="lineNum">    2012 </span><span class="lineNoCov">          0 :             link-&gt;pending_commands = 0;</span>
<span class="lineNum">    2013 </span><span class="lineNoCov">          0 :             link-&gt;cc_conn_time = mstime();</span>
<span class="lineNum">    2014 </span><span class="lineNoCov">          0 :             link-&gt;cc-&gt;data = link;</span>
<span class="lineNum">    2015 </span><span class="lineNoCov">          0 :             redisAeAttach(server.el,link-&gt;cc);</span>
<span class="lineNum">    2016 </span><span class="lineNoCov">          0 :             redisAsyncSetConnectCallback(link-&gt;cc,</span>
<span class="lineNum">    2017 </span>            :                     sentinelLinkEstablishedCallback);
<span class="lineNum">    2018 </span><span class="lineNoCov">          0 :             redisAsyncSetDisconnectCallback(link-&gt;cc,</span>
<span class="lineNum">    2019 </span>            :                     sentinelDisconnectCallback);
<span class="lineNum">    2020 </span><span class="lineNoCov">          0 :             sentinelSendAuthIfNeeded(ri,link-&gt;cc);</span>
<span class="lineNum">    2021 </span><span class="lineNoCov">          0 :             sentinelSetClientName(ri,link-&gt;cc,&quot;cmd&quot;);</span>
<span class="lineNum">    2022 </span>            : 
<span class="lineNum">    2023 </span>            :             /* Send a PING ASAP when reconnecting. */
<span class="lineNum">    2024 </span><span class="lineNoCov">          0 :             sentinelSendPing(ri);</span>
<span class="lineNum">    2025 </span>            :         }
<span class="lineNum">    2026 </span>            :     }
<span class="lineNum">    2027 </span>            :     /* Pub / Sub */
<span class="lineNum">    2028 </span><span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) &amp;&amp; link-&gt;pc == NULL) {</span>
<span class="lineNum">    2029 </span><span class="lineNoCov">          0 :         link-&gt;pc = redisAsyncConnectBind(ri-&gt;addr-&gt;ip,ri-&gt;addr-&gt;port,NET_FIRST_BIND_ADDR);</span>
<span class="lineNum">    2030 </span><span class="lineNoCov">          0 :         if (link-&gt;pc-&gt;err) {</span>
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_DEBUG,&quot;-pubsub-link-reconnection&quot;,ri,&quot;%@ #%s&quot;,</span>
<span class="lineNum">    2032 </span>            :                 link-&gt;pc-&gt;errstr);
<span class="lineNum">    2033 </span><span class="lineNoCov">          0 :             instanceLinkCloseConnection(link,link-&gt;pc);</span>
<span class="lineNum">    2034 </span>            :         } else {
<span class="lineNum">    2035 </span><span class="lineNoCov">          0 :             int retval;</span>
<span class="lineNum">    2036 </span>            : 
<span class="lineNum">    2037 </span><span class="lineNoCov">          0 :             link-&gt;pc_conn_time = mstime();</span>
<span class="lineNum">    2038 </span><span class="lineNoCov">          0 :             link-&gt;pc-&gt;data = link;</span>
<span class="lineNum">    2039 </span><span class="lineNoCov">          0 :             redisAeAttach(server.el,link-&gt;pc);</span>
<span class="lineNum">    2040 </span><span class="lineNoCov">          0 :             redisAsyncSetConnectCallback(link-&gt;pc,</span>
<span class="lineNum">    2041 </span>            :                     sentinelLinkEstablishedCallback);
<span class="lineNum">    2042 </span><span class="lineNoCov">          0 :             redisAsyncSetDisconnectCallback(link-&gt;pc,</span>
<span class="lineNum">    2043 </span>            :                     sentinelDisconnectCallback);
<span class="lineNum">    2044 </span><span class="lineNoCov">          0 :             sentinelSendAuthIfNeeded(ri,link-&gt;pc);</span>
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :             sentinelSetClientName(ri,link-&gt;pc,&quot;pubsub&quot;);</span>
<span class="lineNum">    2046 </span>            :             /* Now we subscribe to the Sentinels &quot;Hello&quot; channel. */
<span class="lineNum">    2047 </span><span class="lineNoCov">          0 :             retval = redisAsyncCommand(link-&gt;pc,</span>
<span class="lineNum">    2048 </span>            :                 sentinelReceiveHelloMessages, ri, &quot;%s %s&quot;,
<span class="lineNum">    2049 </span>            :                 sentinelInstanceMapCommand(ri,&quot;SUBSCRIBE&quot;),
<span class="lineNum">    2050 </span>            :                 SENTINEL_HELLO_CHANNEL);
<span class="lineNum">    2051 </span><span class="lineNoCov">          0 :             if (retval != C_OK) {</span>
<span class="lineNum">    2052 </span>            :                 /* If we can't subscribe, the Pub/Sub connection is useless
<span class="lineNum">    2053 </span>            :                  * and we can simply disconnect it and try again. */
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :                 instanceLinkCloseConnection(link,link-&gt;pc);</span>
<span class="lineNum">    2055 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    2056 </span>            :             }
<span class="lineNum">    2057 </span>            :         }
<span class="lineNum">    2058 </span>            :     }
<span class="lineNum">    2059 </span>            :     /* Clear the disconnected status only if we have both the connections
<span class="lineNum">    2060 </span>            :      * (or just the commands connection if this is a sentinel instance). */
<span class="lineNum">    2061 </span><span class="lineNoCov">          0 :     if (link-&gt;cc &amp;&amp; (ri-&gt;flags &amp; SRI_SENTINEL || link-&gt;pc))</span>
<span class="lineNum">    2062 </span><span class="lineNoCov">          0 :         link-&gt;disconnected = 0;</span>
<span class="lineNum">    2063 </span>            : }
<span class="lineNum">    2064 </span>            : 
<span class="lineNum">    2065 </span>            : /* ======================== Redis instances pinging  ======================== */
<span class="lineNum">    2066 </span>            : 
<span class="lineNum">    2067 </span>            : /* Return true if master looks &quot;sane&quot;, that is:
<span class="lineNum">    2068 </span>            :  * 1) It is actually a master in the current configuration.
<span class="lineNum">    2069 </span>            :  * 2) It reports itself as a master.
<a name="2070"><span class="lineNum">    2070 </span>            :  * 3) It is not SDOWN or ODOWN.</a>
<span class="lineNum">    2071 </span>            :  * 4) We obtained last INFO no more than two times the INFO period time ago. */
<span class="lineNum">    2072 </span><span class="lineNoCov">          0 : int sentinelMasterLooksSane(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2073 </span><span class="lineNoCov">          0 :     return</span>
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 :         master-&gt;flags &amp; SRI_MASTER &amp;&amp;</span>
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 :         master-&gt;role_reported == SRI_MASTER &amp;&amp;</span>
<span class="lineNum">    2076 </span><span class="lineNoCov">          0 :         (master-&gt;flags &amp; (SRI_S_DOWN|SRI_O_DOWN)) == 0 &amp;&amp;</span>
<span class="lineNum">    2077 </span><span class="lineNoCov">          0 :         (mstime() - master-&gt;info_refresh) &lt; SENTINEL_INFO_PERIOD*2;</span>
<span class="lineNum">    2078 </span>            : }
<a name="2079"><span class="lineNum">    2079 </span>            : </a>
<span class="lineNum">    2080 </span>            : /* Process the INFO output from masters. */
<span class="lineNum">    2081 </span><span class="lineNoCov">          0 : void sentinelRefreshInstanceInfo(sentinelRedisInstance *ri, const char *info) {</span>
<span class="lineNum">    2082 </span><span class="lineNoCov">          0 :     sds *lines;</span>
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :     int numlines, j;</span>
<span class="lineNum">    2084 </span><span class="lineNoCov">          0 :     int role = 0;</span>
<span class="lineNum">    2085 </span>            : 
<span class="lineNum">    2086 </span>            :     /* cache full INFO output for instance */
<span class="lineNum">    2087 </span><span class="lineNoCov">          0 :     sdsfree(ri-&gt;info);</span>
<span class="lineNum">    2088 </span><span class="lineNoCov">          0 :     ri-&gt;info = sdsnew(info);</span>
<span class="lineNum">    2089 </span>            : 
<span class="lineNum">    2090 </span>            :     /* The following fields must be reset to a given value in the case they
<span class="lineNum">    2091 </span>            :      * are not found at all in the INFO output. */
<span class="lineNum">    2092 </span><span class="lineNoCov">          0 :     ri-&gt;master_link_down_time = 0;</span>
<span class="lineNum">    2093 </span>            : 
<span class="lineNum">    2094 </span>            :     /* Process line by line. */
<span class="lineNum">    2095 </span><span class="lineNoCov">          0 :     lines = sdssplitlen(info,strlen(info),&quot;\r\n&quot;,2,&amp;numlines);</span>
<span class="lineNum">    2096 </span><span class="lineNoCov">          0 :     for (j = 0; j &lt; numlines; j++) {</span>
<span class="lineNum">    2097 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *slave;</span>
<span class="lineNum">    2098 </span><span class="lineNoCov">          0 :         sds l = lines[j];</span>
<span class="lineNum">    2099 </span>            : 
<span class="lineNum">    2100 </span>            :         /* run_id:&lt;40 hex chars&gt;*/
<span class="lineNum">    2101 </span><span class="lineNoCov">          0 :         if (sdslen(l) &gt;= 47 &amp;&amp; !memcmp(l,&quot;run_id:&quot;,7)) {</span>
<span class="lineNum">    2102 </span><span class="lineNoCov">          0 :             if (ri-&gt;runid == NULL) {</span>
<span class="lineNum">    2103 </span><span class="lineNoCov">          0 :                 ri-&gt;runid = sdsnewlen(l+7,40);</span>
<span class="lineNum">    2104 </span>            :             } else {
<span class="lineNum">    2105 </span><span class="lineNoCov">          0 :                 if (strncmp(ri-&gt;runid,l+7,40) != 0) {</span>
<span class="lineNum">    2106 </span><span class="lineNoCov">          0 :                     sentinelEvent(LL_NOTICE,&quot;+reboot&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2107 </span><span class="lineNoCov">          0 :                     sdsfree(ri-&gt;runid);</span>
<span class="lineNum">    2108 </span><span class="lineNoCov">          0 :                     ri-&gt;runid = sdsnewlen(l+7,40);</span>
<span class="lineNum">    2109 </span>            :                 }
<span class="lineNum">    2110 </span>            :             }
<span class="lineNum">    2111 </span>            :         }
<span class="lineNum">    2112 </span>            : 
<span class="lineNum">    2113 </span>            :         /* old versions: slave0:&lt;ip&gt;,&lt;port&gt;,&lt;state&gt;
<span class="lineNum">    2114 </span>            :          * new versions: slave0:ip=127.0.0.1,port=9999,... */
<span class="lineNum">    2115 </span><span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_MASTER) &amp;&amp;</span>
<span class="lineNum">    2116 </span><span class="lineNoCov">          0 :             sdslen(l) &gt;= 7 &amp;&amp;</span>
<span class="lineNum">    2117 </span><span class="lineNoCov">          0 :             !memcmp(l,&quot;slave&quot;,5) &amp;&amp; isdigit(l[5]))</span>
<span class="lineNum">    2118 </span>            :         {
<span class="lineNum">    2119 </span><span class="lineNoCov">          0 :             char *ip, *port, *end;</span>
<span class="lineNum">    2120 </span>            : 
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :             if (strstr(l,&quot;ip=&quot;) == NULL) {</span>
<span class="lineNum">    2122 </span>            :                 /* Old format. */
<span class="lineNum">    2123 </span><span class="lineNoCov">          0 :                 ip = strchr(l,':'); if (!ip) continue;</span>
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :                 ip++; /* Now ip points to start of ip address. */</span>
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :                 port = strchr(ip,','); if (!port) continue;</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :                 *port = '\0'; /* nul term for easy access. */</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :                 port++; /* Now port points to start of port number. */</span>
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :                 end = strchr(port,','); if (!end) continue;</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :                 *end = '\0'; /* nul term for easy access. */</span>
<span class="lineNum">    2130 </span>            :             } else {
<span class="lineNum">    2131 </span>            :                 /* New format. */
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :                 ip = strstr(l,&quot;ip=&quot;); if (!ip) continue;</span>
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :                 ip += 3; /* Now ip points to start of ip address. */</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :                 port = strstr(l,&quot;port=&quot;); if (!port) continue;</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :                 port += 5; /* Now port points to start of port number. */</span>
<span class="lineNum">    2136 </span>            :                 /* Nul term both fields for easy access. */
<span class="lineNum">    2137 </span><span class="lineNoCov">          0 :                 end = strchr(ip,','); if (end) *end = '\0';</span>
<span class="lineNum">    2138 </span><span class="lineNoCov">          0 :                 end = strchr(port,','); if (end) *end = '\0';</span>
<span class="lineNum">    2139 </span>            :             }
<span class="lineNum">    2140 </span>            : 
<span class="lineNum">    2141 </span>            :             /* Check if we already have this slave into our table,
<span class="lineNum">    2142 </span>            :              * otherwise add it. */
<span class="lineNum">    2143 </span><span class="lineNoCov">          0 :             if (sentinelRedisInstanceLookupSlave(ri,ip,atoi(port)) == NULL) {</span>
<span class="lineNum">    2144 </span><span class="lineNoCov">          0 :                 if ((slave = createSentinelRedisInstance(NULL,SRI_SLAVE,ip,</span>
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :                             atoi(port), ri-&gt;quorum, ri)) != NULL)</span>
<span class="lineNum">    2146 </span>            :                 {
<span class="lineNum">    2147 </span><span class="lineNoCov">          0 :                     sentinelEvent(LL_NOTICE,&quot;+slave&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :                     sentinelFlushConfig();</span>
<span class="lineNum">    2149 </span>            :                 }
<span class="lineNum">    2150 </span>            :             }
<span class="lineNum">    2151 </span>            :         }
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span>            :         /* master_link_down_since_seconds:&lt;seconds&gt; */
<span class="lineNum">    2154 </span><span class="lineNoCov">          0 :         if (sdslen(l) &gt;= 32 &amp;&amp;</span>
<span class="lineNum">    2155 </span><span class="lineNoCov">          0 :             !memcmp(l,&quot;master_link_down_since_seconds&quot;,30))</span>
<span class="lineNum">    2156 </span>            :         {
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :             ri-&gt;master_link_down_time = strtoll(l+31,NULL,10)*1000;</span>
<span class="lineNum">    2158 </span>            :         }
<span class="lineNum">    2159 </span>            : 
<span class="lineNum">    2160 </span>            :         /* role:&lt;role&gt; */
<span class="lineNum">    2161 </span><span class="lineNoCov">          0 :         if (!memcmp(l,&quot;role:master&quot;,11)) role = SRI_MASTER;</span>
<span class="lineNum">    2162 </span><span class="lineNoCov">          0 :         else if (!memcmp(l,&quot;role:slave&quot;,10)) role = SRI_SLAVE;</span>
<span class="lineNum">    2163 </span>            : 
<span class="lineNum">    2164 </span><span class="lineNoCov">          0 :         if (role == SRI_SLAVE) {</span>
<span class="lineNum">    2165 </span>            :             /* master_host:&lt;host&gt; */
<span class="lineNum">    2166 </span><span class="lineNoCov">          0 :             if (sdslen(l) &gt;= 12 &amp;&amp; !memcmp(l,&quot;master_host:&quot;,12)) {</span>
<span class="lineNum">    2167 </span><span class="lineNoCov">          0 :                 if (ri-&gt;slave_master_host == NULL ||</span>
<span class="lineNum">    2168 </span><span class="lineNoCov">          0 :                     strcasecmp(l+12,ri-&gt;slave_master_host))</span>
<span class="lineNum">    2169 </span>            :                 {
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :                     sdsfree(ri-&gt;slave_master_host);</span>
<span class="lineNum">    2171 </span><span class="lineNoCov">          0 :                     ri-&gt;slave_master_host = sdsnew(l+12);</span>
<span class="lineNum">    2172 </span><span class="lineNoCov">          0 :                     ri-&gt;slave_conf_change_time = mstime();</span>
<span class="lineNum">    2173 </span>            :                 }
<span class="lineNum">    2174 </span>            :             }
<span class="lineNum">    2175 </span>            : 
<span class="lineNum">    2176 </span>            :             /* master_port:&lt;port&gt; */
<span class="lineNum">    2177 </span><span class="lineNoCov">          0 :             if (sdslen(l) &gt;= 12 &amp;&amp; !memcmp(l,&quot;master_port:&quot;,12)) {</span>
<span class="lineNum">    2178 </span><span class="lineNoCov">          0 :                 int slave_master_port = atoi(l+12);</span>
<span class="lineNum">    2179 </span>            : 
<span class="lineNum">    2180 </span><span class="lineNoCov">          0 :                 if (ri-&gt;slave_master_port != slave_master_port) {</span>
<span class="lineNum">    2181 </span><span class="lineNoCov">          0 :                     ri-&gt;slave_master_port = slave_master_port;</span>
<span class="lineNum">    2182 </span><span class="lineNoCov">          0 :                     ri-&gt;slave_conf_change_time = mstime();</span>
<span class="lineNum">    2183 </span>            :                 }
<span class="lineNum">    2184 </span>            :             }
<span class="lineNum">    2185 </span>            : 
<span class="lineNum">    2186 </span>            :             /* master_link_status:&lt;status&gt; */
<span class="lineNum">    2187 </span><span class="lineNoCov">          0 :             if (sdslen(l) &gt;= 19 &amp;&amp; !memcmp(l,&quot;master_link_status:&quot;,19)) {</span>
<span class="lineNum">    2188 </span><span class="lineNoCov">          0 :                 ri-&gt;slave_master_link_status =</span>
<span class="lineNum">    2189 </span><span class="lineNoCov">          0 :                     (strcasecmp(l+19,&quot;up&quot;) == 0) ?</span>
<span class="lineNum">    2190 </span><span class="lineNoCov">          0 :                     SENTINEL_MASTER_LINK_STATUS_UP :</span>
<span class="lineNum">    2191 </span>            :                     SENTINEL_MASTER_LINK_STATUS_DOWN;
<span class="lineNum">    2192 </span>            :             }
<span class="lineNum">    2193 </span>            : 
<span class="lineNum">    2194 </span>            :             /* slave_priority:&lt;priority&gt; */
<span class="lineNum">    2195 </span><span class="lineNoCov">          0 :             if (sdslen(l) &gt;= 15 &amp;&amp; !memcmp(l,&quot;slave_priority:&quot;,15))</span>
<span class="lineNum">    2196 </span><span class="lineNoCov">          0 :                 ri-&gt;slave_priority = atoi(l+15);</span>
<span class="lineNum">    2197 </span>            : 
<span class="lineNum">    2198 </span>            :             /* slave_repl_offset:&lt;offset&gt; */
<span class="lineNum">    2199 </span><span class="lineNoCov">          0 :             if (sdslen(l) &gt;= 18 &amp;&amp; !memcmp(l,&quot;slave_repl_offset:&quot;,18))</span>
<span class="lineNum">    2200 </span><span class="lineNoCov">          0 :                 ri-&gt;slave_repl_offset = strtoull(l+18,NULL,10);</span>
<span class="lineNum">    2201 </span>            :         }
<span class="lineNum">    2202 </span>            :     }
<span class="lineNum">    2203 </span><span class="lineNoCov">          0 :     ri-&gt;info_refresh = mstime();</span>
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :     sdsfreesplitres(lines,numlines);</span>
<span class="lineNum">    2205 </span>            : 
<span class="lineNum">    2206 </span>            :     /* ---------------------------- Acting half -----------------------------
<span class="lineNum">    2207 </span>            :      * Some things will not happen if sentinel.tilt is true, but some will
<span class="lineNum">    2208 </span>            :      * still be processed. */
<span class="lineNum">    2209 </span>            : 
<span class="lineNum">    2210 </span>            :     /* Remember when the role changed. */
<span class="lineNum">    2211 </span><span class="lineNoCov">          0 :     if (role != ri-&gt;role_reported) {</span>
<span class="lineNum">    2212 </span><span class="lineNoCov">          0 :         ri-&gt;role_reported_time = mstime();</span>
<span class="lineNum">    2213 </span><span class="lineNoCov">          0 :         ri-&gt;role_reported = role;</span>
<span class="lineNum">    2214 </span><span class="lineNoCov">          0 :         if (role == SRI_SLAVE) ri-&gt;slave_conf_change_time = mstime();</span>
<span class="lineNum">    2215 </span>            :         /* Log the event with +role-change if the new role is coherent or
<span class="lineNum">    2216 </span>            :          * with -role-change if there is a mismatch with the current config. */
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_VERBOSE,</span>
<span class="lineNum">    2218 </span><span class="lineNoCov">          0 :             ((ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) == role) ?</span>
<span class="lineNum">    2219 </span>            :             &quot;+role-change&quot; : &quot;-role-change&quot;,
<span class="lineNum">    2220 </span>            :             ri, &quot;%@ new reported role is %s&quot;,
<span class="lineNum">    2221 </span>            :             role == SRI_MASTER ? &quot;master&quot; : &quot;slave&quot;,
<span class="lineNum">    2222 </span><span class="lineNoCov">          0 :             ri-&gt;flags &amp; SRI_MASTER ? &quot;master&quot; : &quot;slave&quot;);</span>
<span class="lineNum">    2223 </span>            :     }
<span class="lineNum">    2224 </span>            : 
<span class="lineNum">    2225 </span>            :     /* None of the following conditions are processed when in tilt mode, so
<span class="lineNum">    2226 </span>            :      * return asap. */
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :     if (sentinel.tilt) return;</span>
<span class="lineNum">    2228 </span>            : 
<span class="lineNum">    2229 </span>            :     /* Handle master -&gt; slave role switch. */
<span class="lineNum">    2230 </span><span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_MASTER) &amp;&amp; role == SRI_SLAVE) {</span>
<span class="lineNum">    2231 </span>            :         /* Nothing to do, but masters claiming to be slaves are
<span class="lineNum">    2232 </span>            :          * considered to be unreachable by Sentinel, so eventually
<span class="lineNum">    2233 </span>            :          * a failover will be triggered. */
<span class="lineNum">    2234 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    2235 </span>            : 
<span class="lineNum">    2236 </span>            :     /* Handle slave -&gt; master role switch. */
<span class="lineNum">    2237 </span><span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp; role == SRI_MASTER) {</span>
<span class="lineNum">    2238 </span>            :         /* If this is a promoted slave we can change state to the
<span class="lineNum">    2239 </span>            :          * failover state machine. */
<span class="lineNum">    2240 </span><span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_PROMOTED) &amp;&amp;</span>
<span class="lineNum">    2241 </span><span class="lineNoCov">          0 :             (ri-&gt;master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &amp;&amp;</span>
<span class="lineNum">    2242 </span><span class="lineNoCov">          0 :             (ri-&gt;master-&gt;failover_state ==</span>
<span class="lineNum">    2243 </span>            :                 SENTINEL_FAILOVER_STATE_WAIT_PROMOTION))
<span class="lineNum">    2244 </span>            :         {
<span class="lineNum">    2245 </span>            :             /* Now that we are sure the slave was reconfigured as a master
<span class="lineNum">    2246 </span>            :              * set the master configuration epoch to the epoch we won the
<span class="lineNum">    2247 </span>            :              * election to perform this failover. This will force the other
<span class="lineNum">    2248 </span>            :              * Sentinels to update their config (assuming there is not
<span class="lineNum">    2249 </span>            :              * a newer one already available). */
<span class="lineNum">    2250 </span><span class="lineNoCov">          0 :             ri-&gt;master-&gt;config_epoch = ri-&gt;master-&gt;failover_epoch;</span>
<span class="lineNum">    2251 </span><span class="lineNoCov">          0 :             ri-&gt;master-&gt;failover_state = SENTINEL_FAILOVER_STATE_RECONF_SLAVES;</span>
<span class="lineNum">    2252 </span><span class="lineNoCov">          0 :             ri-&gt;master-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    2253 </span><span class="lineNoCov">          0 :             sentinelFlushConfig();</span>
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;+promoted-slave&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2255 </span><span class="lineNoCov">          0 :             if (sentinel.simfailure_flags &amp;</span>
<span class="lineNum">    2256 </span>            :                 SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION)
<span class="lineNum">    2257 </span><span class="lineNoCov">          0 :                 sentinelSimFailureCrash();</span>
<span class="lineNum">    2258 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;+failover-state-reconf-slaves&quot;,</span>
<span class="lineNum">    2259 </span><span class="lineNoCov">          0 :                 ri-&gt;master,&quot;%@&quot;);</span>
<span class="lineNum">    2260 </span><span class="lineNoCov">          0 :             sentinelCallClientReconfScript(ri-&gt;master,SENTINEL_LEADER,</span>
<span class="lineNum">    2261 </span><span class="lineNoCov">          0 :                 &quot;start&quot;,ri-&gt;master-&gt;addr,ri-&gt;addr);</span>
<span class="lineNum">    2262 </span><span class="lineNoCov">          0 :             sentinelForceHelloUpdateForMaster(ri-&gt;master);</span>
<span class="lineNum">    2263 </span>            :         } else {
<span class="lineNum">    2264 </span>            :             /* A slave turned into a master. We want to force our view and
<span class="lineNum">    2265 </span>            :              * reconfigure as slave. Wait some time after the change before
<span class="lineNum">    2266 </span>            :              * going forward, to receive new configs if any. */
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :             mstime_t wait_time = SENTINEL_PUBLISH_PERIOD*4;</span>
<span class="lineNum">    2268 </span>            : 
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :             if (!(ri-&gt;flags &amp; SRI_PROMOTED) &amp;&amp;</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :                  sentinelMasterLooksSane(ri-&gt;master) &amp;&amp;</span>
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 :                  sentinelRedisInstanceNoDownFor(ri,wait_time) &amp;&amp;</span>
<span class="lineNum">    2272 </span><span class="lineNoCov">          0 :                  mstime() - ri-&gt;role_reported_time &gt; wait_time)</span>
<span class="lineNum">    2273 </span>            :             {
<span class="lineNum">    2274 </span><span class="lineNoCov">          0 :                 int retval = sentinelSendSlaveOf(ri,</span>
<span class="lineNum">    2275 </span>            :                         ri-&gt;master-&gt;addr-&gt;ip,
<span class="lineNum">    2276 </span><span class="lineNoCov">          0 :                         ri-&gt;master-&gt;addr-&gt;port);</span>
<span class="lineNum">    2277 </span><span class="lineNoCov">          0 :                 if (retval == C_OK)</span>
<span class="lineNum">    2278 </span><span class="lineNoCov">          0 :                     sentinelEvent(LL_NOTICE,&quot;+convert-to-slave&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2279 </span>            :             }
<span class="lineNum">    2280 </span>            :         }
<span class="lineNum">    2281 </span>            :     }
<span class="lineNum">    2282 </span>            : 
<span class="lineNum">    2283 </span>            :     /* Handle slaves replicating to a different master address. */
<span class="lineNum">    2284 </span><span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp;</span>
<span class="lineNum">    2285 </span><span class="lineNoCov">          0 :         role == SRI_SLAVE &amp;&amp;</span>
<span class="lineNum">    2286 </span><span class="lineNoCov">          0 :         (ri-&gt;slave_master_port != ri-&gt;master-&gt;addr-&gt;port ||</span>
<span class="lineNum">    2287 </span><span class="lineNoCov">          0 :          strcasecmp(ri-&gt;slave_master_host,ri-&gt;master-&gt;addr-&gt;ip)))</span>
<span class="lineNum">    2288 </span>            :     {
<span class="lineNum">    2289 </span><span class="lineNoCov">          0 :         mstime_t wait_time = ri-&gt;master-&gt;failover_timeout;</span>
<span class="lineNum">    2290 </span>            : 
<span class="lineNum">    2291 </span>            :         /* Make sure the master is sane before reconfiguring this instance
<span class="lineNum">    2292 </span>            :          * into a slave. */
<span class="lineNum">    2293 </span><span class="lineNoCov">          0 :         if (sentinelMasterLooksSane(ri-&gt;master) &amp;&amp;</span>
<span class="lineNum">    2294 </span><span class="lineNoCov">          0 :             sentinelRedisInstanceNoDownFor(ri,wait_time) &amp;&amp;</span>
<span class="lineNum">    2295 </span><span class="lineNoCov">          0 :             mstime() - ri-&gt;slave_conf_change_time &gt; wait_time)</span>
<span class="lineNum">    2296 </span>            :         {
<span class="lineNum">    2297 </span><span class="lineNoCov">          0 :             int retval = sentinelSendSlaveOf(ri,</span>
<span class="lineNum">    2298 </span>            :                     ri-&gt;master-&gt;addr-&gt;ip,
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :                     ri-&gt;master-&gt;addr-&gt;port);</span>
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :             if (retval == C_OK)</span>
<span class="lineNum">    2301 </span><span class="lineNoCov">          0 :                 sentinelEvent(LL_NOTICE,&quot;+fix-slave-config&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2302 </span>            :         }
<span class="lineNum">    2303 </span>            :     }
<span class="lineNum">    2304 </span>            : 
<span class="lineNum">    2305 </span>            :     /* Detect if the slave that is in the process of being reconfigured
<span class="lineNum">    2306 </span>            :      * changed state. */
<span class="lineNum">    2307 </span><span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp; role == SRI_SLAVE &amp;&amp;</span>
<span class="lineNum">    2308 </span><span class="lineNoCov">          0 :         (ri-&gt;flags &amp; (SRI_RECONF_SENT|SRI_RECONF_INPROG)))</span>
<span class="lineNum">    2309 </span>            :     {
<span class="lineNum">    2310 </span>            :         /* SRI_RECONF_SENT -&gt; SRI_RECONF_INPROG. */
<span class="lineNum">    2311 </span><span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_RECONF_SENT) &amp;&amp;</span>
<span class="lineNum">    2312 </span><span class="lineNoCov">          0 :             ri-&gt;slave_master_host &amp;&amp;</span>
<span class="lineNum">    2313 </span><span class="lineNoCov">          0 :             strcmp(ri-&gt;slave_master_host,</span>
<span class="lineNum">    2314 </span><span class="lineNoCov">          0 :                     ri-&gt;master-&gt;promoted_slave-&gt;addr-&gt;ip) == 0 &amp;&amp;</span>
<span class="lineNum">    2315 </span><span class="lineNoCov">          0 :             ri-&gt;slave_master_port == ri-&gt;master-&gt;promoted_slave-&gt;addr-&gt;port)</span>
<span class="lineNum">    2316 </span>            :         {
<span class="lineNum">    2317 </span><span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_RECONF_SENT;</span>
<span class="lineNum">    2318 </span><span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_RECONF_INPROG;</span>
<span class="lineNum">    2319 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_NOTICE,&quot;+slave-reconf-inprog&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2320 </span>            :         }
<span class="lineNum">    2321 </span>            : 
<span class="lineNum">    2322 </span>            :         /* SRI_RECONF_INPROG -&gt; SRI_RECONF_DONE */
<span class="lineNum">    2323 </span><span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_RECONF_INPROG) &amp;&amp;</span>
<span class="lineNum">    2324 </span><span class="lineNoCov">          0 :             ri-&gt;slave_master_link_status == SENTINEL_MASTER_LINK_STATUS_UP)</span>
<span class="lineNum">    2325 </span>            :         {
<span class="lineNum">    2326 </span><span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_RECONF_INPROG;</span>
<span class="lineNum">    2327 </span><span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_RECONF_DONE;</span>
<span class="lineNum">    2328 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_NOTICE,&quot;+slave-reconf-done&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    2329 </span>            :         }
<span class="lineNum">    2330 </span>            :     }
<a name="2331"><span class="lineNum">    2331 </span>            : }</a>
<span class="lineNum">    2332 </span>            : 
<span class="lineNum">    2333 </span><span class="lineNoCov">          0 : void sentinelInfoReplyCallback(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri = privdata;</span>
<span class="lineNum">    2335 </span><span class="lineNoCov">          0 :     instanceLink *link = c-&gt;data;</span>
<span class="lineNum">    2336 </span><span class="lineNoCov">          0 :     redisReply *r;</span>
<span class="lineNum">    2337 </span>            : 
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :     if (!reply || !link) return;</span>
<span class="lineNum">    2339 </span><span class="lineNoCov">          0 :     link-&gt;pending_commands--;</span>
<span class="lineNum">    2340 </span><span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    2341 </span>            : 
<span class="lineNum">    2342 </span><span class="lineNoCov">          0 :     if (r-&gt;type == REDIS_REPLY_STRING)</span>
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :         sentinelRefreshInstanceInfo(ri,r-&gt;str);</span>
<span class="lineNum">    2344 </span>            : }
<span class="lineNum">    2345 </span>            : 
<a name="2346"><span class="lineNum">    2346 </span>            : /* Just discard the reply. We use this when we are not monitoring the return</a>
<span class="lineNum">    2347 </span>            :  * value of the command but its effects directly. */
<span class="lineNum">    2348 </span><span class="lineNoCov">          0 : void sentinelDiscardReplyCallback(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    2349 </span><span class="lineNoCov">          0 :     instanceLink *link = c-&gt;data;</span>
<span class="lineNum">    2350 </span><span class="lineNoCov">          0 :     UNUSED(reply);</span>
<span class="lineNum">    2351 </span><span class="lineNoCov">          0 :     UNUSED(privdata);</span>
<span class="lineNum">    2352 </span>            : 
<span class="lineNum">    2353 </span><span class="lineNoCov">          0 :     if (link) link-&gt;pending_commands--;</span>
<a name="2354"><span class="lineNum">    2354 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2355 </span>            : 
<span class="lineNum">    2356 </span><span class="lineNoCov">          0 : void sentinelPingReplyCallback(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    2357 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri = privdata;</span>
<span class="lineNum">    2358 </span><span class="lineNoCov">          0 :     instanceLink *link = c-&gt;data;</span>
<span class="lineNum">    2359 </span><span class="lineNoCov">          0 :     redisReply *r;</span>
<span class="lineNum">    2360 </span>            : 
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :     if (!reply || !link) return;</span>
<span class="lineNum">    2362 </span><span class="lineNoCov">          0 :     link-&gt;pending_commands--;</span>
<span class="lineNum">    2363 </span><span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    2364 </span>            : 
<span class="lineNum">    2365 </span><span class="lineNoCov">          0 :     if (r-&gt;type == REDIS_REPLY_STATUS ||</span>
<span class="lineNum">    2366 </span>            :         r-&gt;type == REDIS_REPLY_ERROR) {
<span class="lineNum">    2367 </span>            :         /* Update the &quot;instance available&quot; field only if this is an
<span class="lineNum">    2368 </span>            :          * acceptable reply. */
<span class="lineNum">    2369 </span><span class="lineNoCov">          0 :         if (strncmp(r-&gt;str,&quot;PONG&quot;,4) == 0 ||</span>
<span class="lineNum">    2370 </span><span class="lineNoCov">          0 :             strncmp(r-&gt;str,&quot;LOADING&quot;,7) == 0 ||</span>
<span class="lineNum">    2371 </span><span class="lineNoCov">          0 :             strncmp(r-&gt;str,&quot;MASTERDOWN&quot;,10) == 0)</span>
<span class="lineNum">    2372 </span>            :         {
<span class="lineNum">    2373 </span><span class="lineNoCov">          0 :             link-&gt;last_avail_time = mstime();</span>
<span class="lineNum">    2374 </span><span class="lineNoCov">          0 :             link-&gt;act_ping_time = 0; /* Flag the pong as received. */</span>
<span class="lineNum">    2375 </span>            :         } else {
<span class="lineNum">    2376 </span>            :             /* Send a SCRIPT KILL command if the instance appears to be
<span class="lineNum">    2377 </span>            :              * down because of a busy script. */
<span class="lineNum">    2378 </span><span class="lineNoCov">          0 :             if (strncmp(r-&gt;str,&quot;BUSY&quot;,4) == 0 &amp;&amp;</span>
<span class="lineNum">    2379 </span><span class="lineNoCov">          0 :                 (ri-&gt;flags &amp; SRI_S_DOWN) &amp;&amp;</span>
<span class="lineNum">    2380 </span>            :                 !(ri-&gt;flags &amp; SRI_SCRIPT_KILL_SENT))
<span class="lineNum">    2381 </span>            :             {
<span class="lineNum">    2382 </span><span class="lineNoCov">          0 :                 if (redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    2383 </span>            :                         sentinelDiscardReplyCallback, ri,
<span class="lineNum">    2384 </span>            :                         &quot;%s KILL&quot;,
<span class="lineNum">    2385 </span>            :                         sentinelInstanceMapCommand(ri,&quot;SCRIPT&quot;)) == C_OK)
<span class="lineNum">    2386 </span>            :                 {
<span class="lineNum">    2387 </span><span class="lineNoCov">          0 :                     ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    2388 </span>            :                 }
<span class="lineNum">    2389 </span><span class="lineNoCov">          0 :                 ri-&gt;flags |= SRI_SCRIPT_KILL_SENT;</span>
<span class="lineNum">    2390 </span>            :             }
<span class="lineNum">    2391 </span>            :         }
<span class="lineNum">    2392 </span>            :     }
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :     link-&gt;last_pong_time = mstime();</span>
<span class="lineNum">    2394 </span>            : }
<span class="lineNum">    2395 </span>            : 
<a name="2396"><span class="lineNum">    2396 </span>            : /* This is called when we get the reply about the PUBLISH command we send</a>
<span class="lineNum">    2397 </span>            :  * to the master to advertise this sentinel. */
<span class="lineNum">    2398 </span><span class="lineNoCov">          0 : void sentinelPublishReplyCallback(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    2399 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri = privdata;</span>
<span class="lineNum">    2400 </span><span class="lineNoCov">          0 :     instanceLink *link = c-&gt;data;</span>
<span class="lineNum">    2401 </span><span class="lineNoCov">          0 :     redisReply *r;</span>
<span class="lineNum">    2402 </span>            : 
<span class="lineNum">    2403 </span><span class="lineNoCov">          0 :     if (!reply || !link) return;</span>
<span class="lineNum">    2404 </span><span class="lineNoCov">          0 :     link-&gt;pending_commands--;</span>
<span class="lineNum">    2405 </span><span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    2406 </span>            : 
<span class="lineNum">    2407 </span>            :     /* Only update pub_time if we actually published our message. Otherwise
<span class="lineNum">    2408 </span>            :      * we'll retry again in 100 milliseconds. */
<span class="lineNum">    2409 </span><span class="lineNoCov">          0 :     if (r-&gt;type != REDIS_REPLY_ERROR)</span>
<span class="lineNum">    2410 </span><span class="lineNoCov">          0 :         ri-&gt;last_pub_time = mstime();</span>
<span class="lineNum">    2411 </span>            : }
<span class="lineNum">    2412 </span>            : 
<span class="lineNum">    2413 </span>            : /* Process an hello message received via Pub/Sub in master or slave instance,
<span class="lineNum">    2414 </span>            :  * or sent directly to this sentinel via the (fake) PUBLISH command of Sentinel.
<span class="lineNum">    2415 </span>            :  *
<a name="2416"><span class="lineNum">    2416 </span>            :  * If the master name specified in the message is not known, the message is</a>
<span class="lineNum">    2417 </span>            :  * discarded. */
<span class="lineNum">    2418 </span><span class="lineNoCov">          0 : void sentinelProcessHelloMessage(char *hello, int hello_len) {</span>
<span class="lineNum">    2419 </span>            :     /* Format is composed of 8 tokens:
<span class="lineNum">    2420 </span>            :      * 0=ip,1=port,2=runid,3=current_epoch,4=master_name,
<span class="lineNum">    2421 </span>            :      * 5=master_ip,6=master_port,7=master_config_epoch. */
<span class="lineNum">    2422 </span><span class="lineNoCov">          0 :     int numtokens, port, removed, master_port;</span>
<span class="lineNum">    2423 </span><span class="lineNoCov">          0 :     uint64_t current_epoch, master_config_epoch;</span>
<span class="lineNum">    2424 </span><span class="lineNoCov">          0 :     char **token = sdssplitlen(hello, hello_len, &quot;,&quot;, 1, &amp;numtokens);</span>
<span class="lineNum">    2425 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *si, *master;</span>
<span class="lineNum">    2426 </span>            : 
<span class="lineNum">    2427 </span><span class="lineNoCov">          0 :     if (numtokens == 8) {</span>
<span class="lineNum">    2428 </span>            :         /* Obtain a reference to the master this hello message is about */
<span class="lineNum">    2429 </span><span class="lineNoCov">          0 :         master = sentinelGetMasterByName(token[4]);</span>
<span class="lineNum">    2430 </span><span class="lineNoCov">          0 :         if (!master) goto cleanup; /* Unknown master, skip the message. */</span>
<span class="lineNum">    2431 </span>            : 
<span class="lineNum">    2432 </span>            :         /* First, try to see if we already have this sentinel. */
<span class="lineNum">    2433 </span><span class="lineNoCov">          0 :         port = atoi(token[1]);</span>
<span class="lineNum">    2434 </span><span class="lineNoCov">          0 :         master_port = atoi(token[6]);</span>
<span class="lineNum">    2435 </span><span class="lineNoCov">          0 :         si = getSentinelRedisInstanceByAddrAndRunID(</span>
<span class="lineNum">    2436 </span>            :                         master-&gt;sentinels,token[0],port,token[2]);
<span class="lineNum">    2437 </span><span class="lineNoCov">          0 :         current_epoch = strtoull(token[3],NULL,10);</span>
<span class="lineNum">    2438 </span><span class="lineNoCov">          0 :         master_config_epoch = strtoull(token[7],NULL,10);</span>
<span class="lineNum">    2439 </span>            : 
<span class="lineNum">    2440 </span><span class="lineNoCov">          0 :         if (!si) {</span>
<span class="lineNum">    2441 </span>            :             /* If not, remove all the sentinels that have the same runid
<span class="lineNum">    2442 </span>            :              * because there was an address change, and add the same Sentinel
<span class="lineNum">    2443 </span>            :              * with the new address back. */
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 :             removed = removeMatchingSentinelFromMaster(master,token[2]);</span>
<span class="lineNum">    2445 </span><span class="lineNoCov">          0 :             if (removed) {</span>
<span class="lineNum">    2446 </span><span class="lineNoCov">          0 :                 sentinelEvent(LL_NOTICE,&quot;+sentinel-address-switch&quot;,master,</span>
<span class="lineNum">    2447 </span>            :                     &quot;%@ ip %s port %d for %s&quot;, token[0],port,token[2]);
<span class="lineNum">    2448 </span>            :             } else {
<span class="lineNum">    2449 </span>            :                 /* Check if there is another Sentinel with the same address this
<span class="lineNum">    2450 </span>            :                  * new one is reporting. What we do if this happens is to set its
<span class="lineNum">    2451 </span>            :                  * port to 0, to signal the address is invalid. We'll update it
<span class="lineNum">    2452 </span>            :                  * later if we get an HELLO message. */
<span class="lineNum">    2453 </span><span class="lineNoCov">          0 :                 sentinelRedisInstance *other =</span>
<span class="lineNum">    2454 </span><span class="lineNoCov">          0 :                     getSentinelRedisInstanceByAddrAndRunID(</span>
<span class="lineNum">    2455 </span>            :                         master-&gt;sentinels, token[0],port,NULL);
<span class="lineNum">    2456 </span><span class="lineNoCov">          0 :                 if (other) {</span>
<span class="lineNum">    2457 </span><span class="lineNoCov">          0 :                     sentinelEvent(LL_NOTICE,&quot;+sentinel-invalid-addr&quot;,other,&quot;%@&quot;);</span>
<span class="lineNum">    2458 </span><span class="lineNoCov">          0 :                     other-&gt;addr-&gt;port = 0; /* It means: invalid address. */</span>
<span class="lineNum">    2459 </span><span class="lineNoCov">          0 :                     sentinelUpdateSentinelAddressInAllMasters(other);</span>
<span class="lineNum">    2460 </span>            :                 }
<span class="lineNum">    2461 </span>            :             }
<span class="lineNum">    2462 </span>            : 
<span class="lineNum">    2463 </span>            :             /* Add the new sentinel. */
<span class="lineNum">    2464 </span><span class="lineNoCov">          0 :             si = createSentinelRedisInstance(token[2],SRI_SENTINEL,</span>
<span class="lineNum">    2465 </span><span class="lineNoCov">          0 :                             token[0],port,master-&gt;quorum,master);</span>
<span class="lineNum">    2466 </span>            : 
<span class="lineNum">    2467 </span><span class="lineNoCov">          0 :             if (si) {</span>
<span class="lineNum">    2468 </span><span class="lineNoCov">          0 :                 if (!removed) sentinelEvent(LL_NOTICE,&quot;+sentinel&quot;,si,&quot;%@&quot;);</span>
<span class="lineNum">    2469 </span>            :                 /* The runid is NULL after a new instance creation and
<span class="lineNum">    2470 </span>            :                  * for Sentinels we don't have a later chance to fill it,
<span class="lineNum">    2471 </span>            :                  * so do it now. */
<span class="lineNum">    2472 </span><span class="lineNoCov">          0 :                 si-&gt;runid = sdsnew(token[2]);</span>
<span class="lineNum">    2473 </span><span class="lineNoCov">          0 :                 sentinelTryConnectionSharing(si);</span>
<span class="lineNum">    2474 </span><span class="lineNoCov">          0 :                 if (removed) sentinelUpdateSentinelAddressInAllMasters(si);</span>
<span class="lineNum">    2475 </span><span class="lineNoCov">          0 :                 sentinelFlushConfig();</span>
<span class="lineNum">    2476 </span>            :             }
<span class="lineNum">    2477 </span>            :         }
<span class="lineNum">    2478 </span>            : 
<span class="lineNum">    2479 </span>            :         /* Update local current_epoch if received current_epoch is greater.*/
<span class="lineNum">    2480 </span><span class="lineNoCov">          0 :         if (current_epoch &gt; sentinel.current_epoch) {</span>
<span class="lineNum">    2481 </span><span class="lineNoCov">          0 :             sentinel.current_epoch = current_epoch;</span>
<span class="lineNum">    2482 </span><span class="lineNoCov">          0 :             sentinelFlushConfig();</span>
<span class="lineNum">    2483 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;+new-epoch&quot;,master,&quot;%llu&quot;,</span>
<span class="lineNum">    2484 </span><span class="lineNoCov">          0 :                 (unsigned long long) sentinel.current_epoch);</span>
<span class="lineNum">    2485 </span>            :         }
<span class="lineNum">    2486 </span>            : 
<span class="lineNum">    2487 </span>            :         /* Update master info if received configuration is newer. */
<span class="lineNum">    2488 </span><span class="lineNoCov">          0 :         if (si &amp;&amp; master-&gt;config_epoch &lt; master_config_epoch) {</span>
<span class="lineNum">    2489 </span><span class="lineNoCov">          0 :             master-&gt;config_epoch = master_config_epoch;</span>
<span class="lineNum">    2490 </span><span class="lineNoCov">          0 :             if (master_port != master-&gt;addr-&gt;port ||</span>
<span class="lineNum">    2491 </span><span class="lineNoCov">          0 :                 strcmp(master-&gt;addr-&gt;ip, token[5]))</span>
<span class="lineNum">    2492 </span>            :             {
<span class="lineNum">    2493 </span><span class="lineNoCov">          0 :                 sentinelAddr *old_addr;</span>
<span class="lineNum">    2494 </span>            : 
<span class="lineNum">    2495 </span><span class="lineNoCov">          0 :                 sentinelEvent(LL_WARNING,&quot;+config-update-from&quot;,si,&quot;%@&quot;);</span>
<span class="lineNum">    2496 </span><span class="lineNoCov">          0 :                 sentinelEvent(LL_WARNING,&quot;+switch-master&quot;,</span>
<span class="lineNum">    2497 </span>            :                     master,&quot;%s %s %d %s %d&quot;,
<span class="lineNum">    2498 </span>            :                     master-&gt;name,
<span class="lineNum">    2499 </span><span class="lineNoCov">          0 :                     master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port,</span>
<span class="lineNum">    2500 </span>            :                     token[5], master_port);
<span class="lineNum">    2501 </span>            : 
<span class="lineNum">    2502 </span><span class="lineNoCov">          0 :                 old_addr = dupSentinelAddr(master-&gt;addr);</span>
<span class="lineNum">    2503 </span><span class="lineNoCov">          0 :                 sentinelResetMasterAndChangeAddress(master, token[5], master_port);</span>
<span class="lineNum">    2504 </span><span class="lineNoCov">          0 :                 sentinelCallClientReconfScript(master,</span>
<span class="lineNum">    2505 </span>            :                     SENTINEL_OBSERVER,&quot;start&quot;,
<span class="lineNum">    2506 </span>            :                     old_addr,master-&gt;addr);
<span class="lineNum">    2507 </span><span class="lineNoCov">          0 :                 releaseSentinelAddr(old_addr);</span>
<span class="lineNum">    2508 </span>            :             }
<span class="lineNum">    2509 </span>            :         }
<span class="lineNum">    2510 </span>            : 
<span class="lineNum">    2511 </span>            :         /* Update the state of the Sentinel. */
<span class="lineNum">    2512 </span><span class="lineNoCov">          0 :         if (si) si-&gt;last_hello_time = mstime();</span>
<span class="lineNum">    2513 </span>            :     }
<span class="lineNum">    2514 </span>            : 
<span class="lineNum">    2515 </span><span class="lineNoCov">          0 : cleanup:</span>
<span class="lineNum">    2516 </span><span class="lineNoCov">          0 :     sdsfreesplitres(token,numtokens);</span>
<span class="lineNum">    2517 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2518 </span>            : 
<span class="lineNum">    2519 </span>            : 
<a name="2520"><span class="lineNum">    2520 </span>            : /* This is our Pub/Sub callback for the Hello channel. It's useful in order</a>
<span class="lineNum">    2521 </span>            :  * to discover other sentinels attached at the same master. */
<span class="lineNum">    2522 </span><span class="lineNoCov">          0 : void sentinelReceiveHelloMessages(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    2523 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri = privdata;</span>
<span class="lineNum">    2524 </span><span class="lineNoCov">          0 :     redisReply *r;</span>
<span class="lineNum">    2525 </span><span class="lineNoCov">          0 :     UNUSED(c);</span>
<span class="lineNum">    2526 </span>            : 
<span class="lineNum">    2527 </span><span class="lineNoCov">          0 :     if (!reply || !ri) return;</span>
<span class="lineNum">    2528 </span><span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    2529 </span>            : 
<span class="lineNum">    2530 </span>            :     /* Update the last activity in the pubsub channel. Note that since we
<span class="lineNum">    2531 </span>            :      * receive our messages as well this timestamp can be used to detect
<span class="lineNum">    2532 </span>            :      * if the link is probably disconnected even if it seems otherwise. */
<span class="lineNum">    2533 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;pc_last_activity = mstime();</span>
<span class="lineNum">    2534 </span>            : 
<span class="lineNum">    2535 </span>            :     /* Sanity check in the reply we expect, so that the code that follows
<span class="lineNum">    2536 </span>            :      * can avoid to check for details. */
<span class="lineNum">    2537 </span><span class="lineNoCov">          0 :     if (r-&gt;type != REDIS_REPLY_ARRAY ||</span>
<span class="lineNum">    2538 </span><span class="lineNoCov">          0 :         r-&gt;elements != 3 ||</span>
<span class="lineNum">    2539 </span><span class="lineNoCov">          0 :         r-&gt;element[0]-&gt;type != REDIS_REPLY_STRING ||</span>
<span class="lineNum">    2540 </span><span class="lineNoCov">          0 :         r-&gt;element[1]-&gt;type != REDIS_REPLY_STRING ||</span>
<span class="lineNum">    2541 </span><span class="lineNoCov">          0 :         r-&gt;element[2]-&gt;type != REDIS_REPLY_STRING ||</span>
<span class="lineNum">    2542 </span><span class="lineNoCov">          0 :         strcmp(r-&gt;element[0]-&gt;str,&quot;message&quot;) != 0) return;</span>
<span class="lineNum">    2543 </span>            : 
<span class="lineNum">    2544 </span>            :     /* We are not interested in meeting ourselves */
<span class="lineNum">    2545 </span><span class="lineNoCov">          0 :     if (strstr(r-&gt;element[2]-&gt;str,sentinel.myid) != NULL) return;</span>
<span class="lineNum">    2546 </span>            : 
<span class="lineNum">    2547 </span><span class="lineNoCov">          0 :     sentinelProcessHelloMessage(r-&gt;element[2]-&gt;str, r-&gt;element[2]-&gt;len);</span>
<span class="lineNum">    2548 </span>            : }
<span class="lineNum">    2549 </span>            : 
<span class="lineNum">    2550 </span>            : /* Send an &quot;Hello&quot; message via Pub/Sub to the specified 'ri' Redis
<span class="lineNum">    2551 </span>            :  * instance in order to broadcast the current configuration for this
<span class="lineNum">    2552 </span>            :  * master, and to advertise the existence of this Sentinel at the same time.
<span class="lineNum">    2553 </span>            :  *
<span class="lineNum">    2554 </span>            :  * The message has the following format:
<span class="lineNum">    2555 </span>            :  *
<span class="lineNum">    2556 </span>            :  * sentinel_ip,sentinel_port,sentinel_runid,current_epoch,
<span class="lineNum">    2557 </span>            :  * master_name,master_ip,master_port,master_config_epoch.
<span class="lineNum">    2558 </span>            :  *
<a name="2559"><span class="lineNum">    2559 </span>            :  * Returns C_OK if the PUBLISH was queued correctly, otherwise</a>
<span class="lineNum">    2560 </span>            :  * C_ERR is returned. */
<span class="lineNum">    2561 </span><span class="lineNoCov">          0 : int sentinelSendHello(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2562 </span><span class="lineNoCov">          0 :     char ip[NET_IP_STR_LEN];</span>
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 :     char payload[NET_IP_STR_LEN+1024];</span>
<span class="lineNum">    2564 </span><span class="lineNoCov">          0 :     int retval;</span>
<span class="lineNum">    2565 </span><span class="lineNoCov">          0 :     char *announce_ip;</span>
<span class="lineNum">    2566 </span><span class="lineNoCov">          0 :     int announce_port;</span>
<span class="lineNum">    2567 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *master = (ri-&gt;flags &amp; SRI_MASTER) ? ri : ri-&gt;master;</span>
<span class="lineNum">    2568 </span><span class="lineNoCov">          0 :     sentinelAddr *master_addr = sentinelGetCurrentMasterAddress(master);</span>
<span class="lineNum">    2569 </span>            : 
<span class="lineNum">    2570 </span><span class="lineNoCov">          0 :     if (ri-&gt;link-&gt;disconnected) return C_ERR;</span>
<span class="lineNum">    2571 </span>            : 
<span class="lineNum">    2572 </span>            :     /* Use the specified announce address if specified, otherwise try to
<span class="lineNum">    2573 </span>            :      * obtain our own IP address. */
<span class="lineNum">    2574 </span><span class="lineNoCov">          0 :     if (sentinel.announce_ip) {</span>
<span class="lineNum">    2575 </span>            :         announce_ip = sentinel.announce_ip;
<span class="lineNum">    2576 </span>            :     } else {
<span class="lineNum">    2577 </span><span class="lineNoCov">          0 :         if (anetSockName(ri-&gt;link-&gt;cc-&gt;c.fd,ip,sizeof(ip),NULL) == -1)</span>
<span class="lineNum">    2578 </span>            :             return C_ERR;
<span class="lineNum">    2579 </span>            :         announce_ip = ip;
<span class="lineNum">    2580 </span>            :     }
<span class="lineNum">    2581 </span><span class="lineNoCov">          0 :     announce_port = sentinel.announce_port ?</span>
<span class="lineNum">    2582 </span><span class="lineNoCov">          0 :                     sentinel.announce_port : server.port;</span>
<span class="lineNum">    2583 </span>            : 
<span class="lineNum">    2584 </span>            :     /* Format and send the Hello message. */
<span class="lineNum">    2585 </span><span class="lineNoCov">          0 :     snprintf(payload,sizeof(payload),</span>
<span class="lineNum">    2586 </span>            :         &quot;%s,%d,%s,%llu,&quot; /* Info about this sentinel. */
<span class="lineNum">    2587 </span>            :         &quot;%s,%s,%d,%llu&quot;, /* Info about current master. */
<span class="lineNum">    2588 </span>            :         announce_ip, announce_port, sentinel.myid,
<span class="lineNum">    2589 </span><span class="lineNoCov">          0 :         (unsigned long long) sentinel.current_epoch,</span>
<span class="lineNum">    2590 </span>            :         /* --- */
<span class="lineNum">    2591 </span>            :         master-&gt;name,master_addr-&gt;ip,master_addr-&gt;port,
<span class="lineNum">    2592 </span><span class="lineNoCov">          0 :         (unsigned long long) master-&gt;config_epoch);</span>
<span class="lineNum">    2593 </span><span class="lineNoCov">          0 :     retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    2594 </span>            :         sentinelPublishReplyCallback, ri, &quot;%s %s %s&quot;,
<span class="lineNum">    2595 </span>            :         sentinelInstanceMapCommand(ri,&quot;PUBLISH&quot;),
<span class="lineNum">    2596 </span>            :         SENTINEL_HELLO_CHANNEL,payload);
<span class="lineNum">    2597 </span><span class="lineNoCov">          0 :     if (retval != C_OK) return C_ERR;</span>
<span class="lineNum">    2598 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    2599 </span><span class="lineNoCov">          0 :     return C_OK;</span>
<span class="lineNum">    2600 </span>            : }
<span class="lineNum">    2601 </span>            : 
<a name="2602"><span class="lineNum">    2602 </span>            : /* Reset last_pub_time in all the instances in the specified dictionary</a>
<span class="lineNum">    2603 </span>            :  * in order to force the delivery of an Hello update ASAP. */
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 : void sentinelForceHelloUpdateDictOfRedisInstances(dict *instances) {</span>
<span class="lineNum">    2605 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    2606 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    2607 </span>            : 
<span class="lineNum">    2608 </span><span class="lineNoCov">          0 :     di = dictGetSafeIterator(instances);</span>
<span class="lineNum">    2609 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2610 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    2611 </span><span class="lineNoCov">          0 :         if (ri-&gt;last_pub_time &gt;= (SENTINEL_PUBLISH_PERIOD+1))</span>
<span class="lineNum">    2612 </span><span class="lineNoCov">          0 :             ri-&gt;last_pub_time -= (SENTINEL_PUBLISH_PERIOD+1);</span>
<span class="lineNum">    2613 </span>            :     }
<span class="lineNum">    2614 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2615 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2616 </span>            : 
<span class="lineNum">    2617 </span>            : /* This function forces the delivery of an &quot;Hello&quot; message (see
<span class="lineNum">    2618 </span>            :  * sentinelSendHello() top comment for further information) to all the Redis
<span class="lineNum">    2619 </span>            :  * and Sentinel instances related to the specified 'master'.
<span class="lineNum">    2620 </span>            :  *
<span class="lineNum">    2621 </span>            :  * It is technically not needed since we send an update to every instance
<span class="lineNum">    2622 </span>            :  * with a period of SENTINEL_PUBLISH_PERIOD milliseconds, however when a
<a name="2623"><span class="lineNum">    2623 </span>            :  * Sentinel upgrades a configuration it is a good idea to deliever an update</a>
<span class="lineNum">    2624 </span>            :  * to the other Sentinels ASAP. */
<span class="lineNum">    2625 </span><span class="lineNoCov">          0 : int sentinelForceHelloUpdateForMaster(sentinelRedisInstance *master) {</span>
<span class="lineNum">    2626 </span><span class="lineNoCov">          0 :     if (!(master-&gt;flags &amp; SRI_MASTER)) return C_ERR;</span>
<span class="lineNum">    2627 </span><span class="lineNoCov">          0 :     if (master-&gt;last_pub_time &gt;= (SENTINEL_PUBLISH_PERIOD+1))</span>
<span class="lineNum">    2628 </span><span class="lineNoCov">          0 :         master-&gt;last_pub_time -= (SENTINEL_PUBLISH_PERIOD+1);</span>
<span class="lineNum">    2629 </span><span class="lineNoCov">          0 :     sentinelForceHelloUpdateDictOfRedisInstances(master-&gt;sentinels);</span>
<span class="lineNum">    2630 </span><span class="lineNoCov">          0 :     sentinelForceHelloUpdateDictOfRedisInstances(master-&gt;slaves);</span>
<span class="lineNum">    2631 </span><span class="lineNoCov">          0 :     return C_OK;</span>
<span class="lineNum">    2632 </span>            : }
<span class="lineNum">    2633 </span>            : 
<span class="lineNum">    2634 </span>            : /* Send a PING to the specified instance and refresh the act_ping_time
<span class="lineNum">    2635 </span>            :  * if it is zero (that is, if we received a pong for the previous ping).
<span class="lineNum">    2636 </span>            :  *
<a name="2637"><span class="lineNum">    2637 </span>            :  * On error zero is returned, and we can't consider the PING command</a>
<span class="lineNum">    2638 </span>            :  * queued in the connection. */
<span class="lineNum">    2639 </span><span class="lineNoCov">          0 : int sentinelSendPing(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2640 </span><span class="lineNoCov">          0 :     int retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    2641 </span>            :         sentinelPingReplyCallback, ri, &quot;%s&quot;,
<span class="lineNum">    2642 </span>            :         sentinelInstanceMapCommand(ri,&quot;PING&quot;));
<span class="lineNum">    2643 </span><span class="lineNoCov">          0 :     if (retval == C_OK) {</span>
<span class="lineNum">    2644 </span><span class="lineNoCov">          0 :         ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    2645 </span><span class="lineNoCov">          0 :         ri-&gt;link-&gt;last_ping_time = mstime();</span>
<span class="lineNum">    2646 </span>            :         /* We update the active ping time only if we received the pong for
<span class="lineNum">    2647 </span>            :          * the previous ping, otherwise we are technically waiting since the
<span class="lineNum">    2648 </span>            :          * first ping that did not receive a reply. */
<span class="lineNum">    2649 </span><span class="lineNoCov">          0 :         if (ri-&gt;link-&gt;act_ping_time == 0)</span>
<span class="lineNum">    2650 </span><span class="lineNoCov">          0 :             ri-&gt;link-&gt;act_ping_time = ri-&gt;link-&gt;last_ping_time;</span>
<span class="lineNum">    2651 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">    2652 </span>            :     } else {
<span class="lineNum">    2653 </span>            :         return 0;
<span class="lineNum">    2654 </span>            :     }
<span class="lineNum">    2655 </span>            : }
<span class="lineNum">    2656 </span>            : 
<a name="2657"><span class="lineNum">    2657 </span>            : /* Send periodic PING, INFO, and PUBLISH to the Hello channel to</a>
<span class="lineNum">    2658 </span>            :  * the specified master or slave instance. */
<span class="lineNum">    2659 </span><span class="lineNoCov">          0 : void sentinelSendPeriodicCommands(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2660 </span><span class="lineNoCov">          0 :     mstime_t now = mstime();</span>
<span class="lineNum">    2661 </span><span class="lineNoCov">          0 :     mstime_t info_period, ping_period;</span>
<span class="lineNum">    2662 </span><span class="lineNoCov">          0 :     int retval;</span>
<span class="lineNum">    2663 </span>            : 
<span class="lineNum">    2664 </span>            :     /* Return ASAP if we have already a PING or INFO already pending, or
<span class="lineNum">    2665 </span>            :      * in the case the instance is not properly connected. */
<span class="lineNum">    2666 </span><span class="lineNoCov">          0 :     if (ri-&gt;link-&gt;disconnected) return;</span>
<span class="lineNum">    2667 </span>            : 
<span class="lineNum">    2668 </span>            :     /* For INFO, PING, PUBLISH that are not critical commands to send we
<span class="lineNum">    2669 </span>            :      * also have a limit of SENTINEL_MAX_PENDING_COMMANDS. We don't
<span class="lineNum">    2670 </span>            :      * want to use a lot of memory just because a link is not working
<span class="lineNum">    2671 </span>            :      * properly (note that anyway there is a redundant protection about this,
<span class="lineNum">    2672 </span>            :      * that is, the link will be disconnected and reconnected if a long
<span class="lineNum">    2673 </span>            :      * timeout condition is detected. */
<span class="lineNum">    2674 </span><span class="lineNoCov">          0 :     if (ri-&gt;link-&gt;pending_commands &gt;=</span>
<span class="lineNum">    2675 </span><span class="lineNoCov">          0 :         SENTINEL_MAX_PENDING_COMMANDS * ri-&gt;link-&gt;refcount) return;</span>
<span class="lineNum">    2676 </span>            : 
<span class="lineNum">    2677 </span>            :     /* If this is a slave of a master in O_DOWN condition we start sending
<span class="lineNum">    2678 </span>            :      * it INFO every second, instead of the usual SENTINEL_INFO_PERIOD
<span class="lineNum">    2679 </span>            :      * period. In this state we want to closely monitor slaves in case they
<span class="lineNum">    2680 </span>            :      * are turned into masters by another Sentinel, or by the sysadmin.
<span class="lineNum">    2681 </span>            :      *
<span class="lineNum">    2682 </span>            :      * Similarly we monitor the INFO output more often if the slave reports
<span class="lineNum">    2683 </span>            :      * to be disconnected from the master, so that we can have a fresh
<span class="lineNum">    2684 </span>            :      * disconnection time figure. */
<span class="lineNum">    2685 </span><span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp;</span>
<span class="lineNum">    2686 </span><span class="lineNoCov">          0 :         ((ri-&gt;master-&gt;flags &amp; (SRI_O_DOWN|SRI_FAILOVER_IN_PROGRESS)) ||</span>
<span class="lineNum">    2687 </span><span class="lineNoCov">          0 :          (ri-&gt;master_link_down_time != 0)))</span>
<span class="lineNum">    2688 </span>            :     {
<span class="lineNum">    2689 </span>            :         info_period = 1000;
<span class="lineNum">    2690 </span>            :     } else {
<span class="lineNum">    2691 </span><span class="lineNoCov">          0 :         info_period = SENTINEL_INFO_PERIOD;</span>
<span class="lineNum">    2692 </span>            :     }
<span class="lineNum">    2693 </span>            : 
<span class="lineNum">    2694 </span>            :     /* We ping instances every time the last received pong is older than
<span class="lineNum">    2695 </span>            :      * the configured 'down-after-milliseconds' time, but every second
<span class="lineNum">    2696 </span>            :      * anyway if 'down-after-milliseconds' is greater than 1 second. */
<span class="lineNum">    2697 </span><span class="lineNoCov">          0 :     ping_period = ri-&gt;down_after_period;</span>
<span class="lineNum">    2698 </span><span class="lineNoCov">          0 :     if (ping_period &gt; SENTINEL_PING_PERIOD) ping_period = SENTINEL_PING_PERIOD;</span>
<span class="lineNum">    2699 </span>            : 
<span class="lineNum">    2700 </span>            :     /* Send INFO to masters and slaves, not sentinels. */
<span class="lineNum">    2701 </span><span class="lineNoCov">          0 :     if ((ri-&gt;flags &amp; SRI_SENTINEL) == 0 &amp;&amp;</span>
<span class="lineNum">    2702 </span><span class="lineNoCov">          0 :         (ri-&gt;info_refresh == 0 ||</span>
<span class="lineNum">    2703 </span><span class="lineNoCov">          0 :         (now - ri-&gt;info_refresh) &gt; info_period))</span>
<span class="lineNum">    2704 </span>            :     {
<span class="lineNum">    2705 </span><span class="lineNoCov">          0 :         retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    2706 </span>            :             sentinelInfoReplyCallback, ri, &quot;%s&quot;,
<span class="lineNum">    2707 </span>            :             sentinelInstanceMapCommand(ri,&quot;INFO&quot;));
<span class="lineNum">    2708 </span><span class="lineNoCov">          0 :         if (retval == C_OK) ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    2709 </span>            :     }
<span class="lineNum">    2710 </span>            : 
<span class="lineNum">    2711 </span>            :     /* Send PING to all the three kinds of instances. */
<span class="lineNum">    2712 </span><span class="lineNoCov">          0 :     if ((now - ri-&gt;link-&gt;last_pong_time) &gt; ping_period &amp;&amp;</span>
<span class="lineNum">    2713 </span><span class="lineNoCov">          0 :                (now - ri-&gt;link-&gt;last_ping_time) &gt; ping_period/2) {</span>
<span class="lineNum">    2714 </span><span class="lineNoCov">          0 :         sentinelSendPing(ri);</span>
<span class="lineNum">    2715 </span>            :     }
<span class="lineNum">    2716 </span>            : 
<span class="lineNum">    2717 </span>            :     /* PUBLISH hello messages to all the three kinds of instances. */
<span class="lineNum">    2718 </span><span class="lineNoCov">          0 :     if ((now - ri-&gt;last_pub_time) &gt; SENTINEL_PUBLISH_PERIOD) {</span>
<span class="lineNum">    2719 </span><span class="lineNoCov">          0 :         sentinelSendHello(ri);</span>
<span class="lineNum">    2720 </span>            :     }
<span class="lineNum">    2721 </span>            : }
<span class="lineNum">    2722 </span>            : 
<a name="2723"><span class="lineNum">    2723 </span>            : /* =========================== SENTINEL command ============================= */</a>
<span class="lineNum">    2724 </span>            : 
<span class="lineNum">    2725 </span><span class="lineNoCov">          0 : const char *sentinelFailoverStateStr(int state) {</span>
<span class="lineNum">    2726 </span><span class="lineNoCov">          0 :     switch(state) {</span>
<span class="lineNum">    2727 </span>            :     case SENTINEL_FAILOVER_STATE_NONE: return &quot;none&quot;;
<span class="lineNum">    2728 </span><span class="lineNoCov">          0 :     case SENTINEL_FAILOVER_STATE_WAIT_START: return &quot;wait_start&quot;;</span>
<span class="lineNum">    2729 </span><span class="lineNoCov">          0 :     case SENTINEL_FAILOVER_STATE_SELECT_SLAVE: return &quot;select_slave&quot;;</span>
<span class="lineNum">    2730 </span><span class="lineNoCov">          0 :     case SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE: return &quot;send_slaveof_noone&quot;;</span>
<span class="lineNum">    2731 </span><span class="lineNoCov">          0 :     case SENTINEL_FAILOVER_STATE_WAIT_PROMOTION: return &quot;wait_promotion&quot;;</span>
<span class="lineNum">    2732 </span><span class="lineNoCov">          0 :     case SENTINEL_FAILOVER_STATE_RECONF_SLAVES: return &quot;reconf_slaves&quot;;</span>
<span class="lineNum">    2733 </span><span class="lineNoCov">          0 :     case SENTINEL_FAILOVER_STATE_UPDATE_CONFIG: return &quot;update_config&quot;;</span>
<span class="lineNum">    2734 </span><span class="lineNoCov">          0 :     default: return &quot;unknown&quot;;</span>
<span class="lineNum">    2735 </span>            :     }
<span class="lineNum">    2736 </span>            : }
<a name="2737"><span class="lineNum">    2737 </span>            : </a>
<span class="lineNum">    2738 </span>            : /* Redis instance to Redis protocol representation. */
<span class="lineNum">    2739 </span><span class="lineNoCov">          0 : void addReplySentinelRedisInstance(client *c, sentinelRedisInstance *ri) {</span>
<span class="lineNum">    2740 </span><span class="lineNoCov">          0 :     char *flags = sdsempty();</span>
<span class="lineNum">    2741 </span><span class="lineNoCov">          0 :     void *mbl;</span>
<span class="lineNum">    2742 </span><span class="lineNoCov">          0 :     int fields = 0;</span>
<span class="lineNum">    2743 </span>            : 
<span class="lineNum">    2744 </span><span class="lineNoCov">          0 :     mbl = addDeferredMultiBulkLength(c);</span>
<span class="lineNum">    2745 </span>            : 
<span class="lineNum">    2746 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;name&quot;);</span>
<span class="lineNum">    2747 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,ri-&gt;name);</span>
<span class="lineNum">    2748 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2749 </span>            : 
<span class="lineNum">    2750 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;ip&quot;);</span>
<span class="lineNum">    2751 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,ri-&gt;addr-&gt;ip);</span>
<span class="lineNum">    2752 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2753 </span>            : 
<span class="lineNum">    2754 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;port&quot;);</span>
<span class="lineNum">    2755 </span><span class="lineNoCov">          0 :     addReplyBulkLongLong(c,ri-&gt;addr-&gt;port);</span>
<span class="lineNum">    2756 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2757 </span>            : 
<span class="lineNum">    2758 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;runid&quot;);</span>
<span class="lineNum">    2759 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,ri-&gt;runid ? ri-&gt;runid : &quot;&quot;);</span>
<span class="lineNum">    2760 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2761 </span>            : 
<span class="lineNum">    2762 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;flags&quot;);</span>
<span class="lineNum">    2763 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_S_DOWN) flags = sdscat(flags,&quot;s_down,&quot;);</span>
<span class="lineNum">    2764 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_O_DOWN) flags = sdscat(flags,&quot;o_down,&quot;);</span>
<span class="lineNum">    2765 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) flags = sdscat(flags,&quot;master,&quot;);</span>
<span class="lineNum">    2766 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_SLAVE) flags = sdscat(flags,&quot;slave,&quot;);</span>
<span class="lineNum">    2767 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_SENTINEL) flags = sdscat(flags,&quot;sentinel,&quot;);</span>
<span class="lineNum">    2768 </span><span class="lineNoCov">          0 :     if (ri-&gt;link-&gt;disconnected) flags = sdscat(flags,&quot;disconnected,&quot;);</span>
<span class="lineNum">    2769 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER_DOWN) flags = sdscat(flags,&quot;master_down,&quot;);</span>
<span class="lineNum">    2770 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS)</span>
<span class="lineNum">    2771 </span><span class="lineNoCov">          0 :         flags = sdscat(flags,&quot;failover_in_progress,&quot;);</span>
<span class="lineNum">    2772 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_PROMOTED) flags = sdscat(flags,&quot;promoted,&quot;);</span>
<span class="lineNum">    2773 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_RECONF_SENT) flags = sdscat(flags,&quot;reconf_sent,&quot;);</span>
<span class="lineNum">    2774 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_RECONF_INPROG) flags = sdscat(flags,&quot;reconf_inprog,&quot;);</span>
<span class="lineNum">    2775 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_RECONF_DONE) flags = sdscat(flags,&quot;reconf_done,&quot;);</span>
<span class="lineNum">    2776 </span>            : 
<span class="lineNum">    2777 </span><span class="lineNoCov">          0 :     if (sdslen(flags) != 0) sdsrange(flags,0,-2); /* remove last &quot;,&quot; */</span>
<span class="lineNum">    2778 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,flags);</span>
<span class="lineNum">    2779 </span><span class="lineNoCov">          0 :     sdsfree(flags);</span>
<span class="lineNum">    2780 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2781 </span>            : 
<span class="lineNum">    2782 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;link-pending-commands&quot;);</span>
<span class="lineNum">    2783 </span><span class="lineNoCov">          0 :     addReplyBulkLongLong(c,ri-&gt;link-&gt;pending_commands);</span>
<span class="lineNum">    2784 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2785 </span>            : 
<span class="lineNum">    2786 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;link-refcount&quot;);</span>
<span class="lineNum">    2787 </span><span class="lineNoCov">          0 :     addReplyBulkLongLong(c,ri-&gt;link-&gt;refcount);</span>
<span class="lineNum">    2788 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2789 </span>            : 
<span class="lineNum">    2790 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) {</span>
<span class="lineNum">    2791 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;failover-state&quot;);</span>
<span class="lineNum">    2792 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,(char*)sentinelFailoverStateStr(ri-&gt;failover_state));</span>
<span class="lineNum">    2793 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2794 </span>            :     }
<span class="lineNum">    2795 </span>            : 
<span class="lineNum">    2796 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;last-ping-sent&quot;);</span>
<span class="lineNum">    2797 </span><span class="lineNoCov">          0 :     addReplyBulkLongLong(c,</span>
<span class="lineNum">    2798 </span><span class="lineNoCov">          0 :         ri-&gt;link-&gt;act_ping_time ? (mstime() - ri-&gt;link-&gt;act_ping_time) : 0);</span>
<span class="lineNum">    2799 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2800 </span>            : 
<span class="lineNum">    2801 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;last-ok-ping-reply&quot;);</span>
<span class="lineNum">    2802 </span><span class="lineNoCov">          0 :     addReplyBulkLongLong(c,mstime() - ri-&gt;link-&gt;last_avail_time);</span>
<span class="lineNum">    2803 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2804 </span>            : 
<span class="lineNum">    2805 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;last-ping-reply&quot;);</span>
<span class="lineNum">    2806 </span><span class="lineNoCov">          0 :     addReplyBulkLongLong(c,mstime() - ri-&gt;link-&gt;last_pong_time);</span>
<span class="lineNum">    2807 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2808 </span>            : 
<span class="lineNum">    2809 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_S_DOWN) {</span>
<span class="lineNum">    2810 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;s-down-time&quot;);</span>
<span class="lineNum">    2811 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,mstime()-ri-&gt;s_down_since_time);</span>
<span class="lineNum">    2812 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2813 </span>            :     }
<span class="lineNum">    2814 </span>            : 
<span class="lineNum">    2815 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_O_DOWN) {</span>
<span class="lineNum">    2816 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;o-down-time&quot;);</span>
<span class="lineNum">    2817 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,mstime()-ri-&gt;o_down_since_time);</span>
<span class="lineNum">    2818 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2819 </span>            :     }
<span class="lineNum">    2820 </span>            : 
<span class="lineNum">    2821 </span><span class="lineNoCov">          0 :     addReplyBulkCString(c,&quot;down-after-milliseconds&quot;);</span>
<span class="lineNum">    2822 </span><span class="lineNoCov">          0 :     addReplyBulkLongLong(c,ri-&gt;down_after_period);</span>
<span class="lineNum">    2823 </span><span class="lineNoCov">          0 :     fields++;</span>
<span class="lineNum">    2824 </span>            : 
<span class="lineNum">    2825 </span>            :     /* Masters and Slaves */
<span class="lineNum">    2826 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) {</span>
<span class="lineNum">    2827 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;info-refresh&quot;);</span>
<span class="lineNum">    2828 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,mstime() - ri-&gt;info_refresh);</span>
<span class="lineNum">    2829 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2830 </span>            : 
<span class="lineNum">    2831 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;role-reported&quot;);</span>
<span class="lineNum">    2832 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c, (ri-&gt;role_reported == SRI_MASTER) ? &quot;master&quot; :</span>
<span class="lineNum">    2833 </span>            :                                                                    &quot;slave&quot;);
<span class="lineNum">    2834 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2835 </span>            : 
<span class="lineNum">    2836 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;role-reported-time&quot;);</span>
<span class="lineNum">    2837 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,mstime() - ri-&gt;role_reported_time);</span>
<span class="lineNum">    2838 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2839 </span>            :     }
<span class="lineNum">    2840 </span>            : 
<span class="lineNum">    2841 </span>            :     /* Only masters */
<span class="lineNum">    2842 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) {</span>
<span class="lineNum">    2843 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;config-epoch&quot;);</span>
<span class="lineNum">    2844 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;config_epoch);</span>
<span class="lineNum">    2845 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2846 </span>            : 
<span class="lineNum">    2847 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;num-slaves&quot;);</span>
<span class="lineNum">    2848 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,dictSize(ri-&gt;slaves));</span>
<span class="lineNum">    2849 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2850 </span>            : 
<span class="lineNum">    2851 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;num-other-sentinels&quot;);</span>
<span class="lineNum">    2852 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,dictSize(ri-&gt;sentinels));</span>
<span class="lineNum">    2853 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2854 </span>            : 
<span class="lineNum">    2855 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;quorum&quot;);</span>
<span class="lineNum">    2856 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;quorum);</span>
<span class="lineNum">    2857 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2858 </span>            : 
<span class="lineNum">    2859 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;failover-timeout&quot;);</span>
<span class="lineNum">    2860 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;failover_timeout);</span>
<span class="lineNum">    2861 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2862 </span>            : 
<span class="lineNum">    2863 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;parallel-syncs&quot;);</span>
<span class="lineNum">    2864 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;parallel_syncs);</span>
<span class="lineNum">    2865 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2866 </span>            : 
<span class="lineNum">    2867 </span><span class="lineNoCov">          0 :         if (ri-&gt;notification_script) {</span>
<span class="lineNum">    2868 </span><span class="lineNoCov">          0 :             addReplyBulkCString(c,&quot;notification-script&quot;);</span>
<span class="lineNum">    2869 </span><span class="lineNoCov">          0 :             addReplyBulkCString(c,ri-&gt;notification_script);</span>
<span class="lineNum">    2870 </span><span class="lineNoCov">          0 :             fields++;</span>
<span class="lineNum">    2871 </span>            :         }
<span class="lineNum">    2872 </span>            : 
<span class="lineNum">    2873 </span><span class="lineNoCov">          0 :         if (ri-&gt;client_reconfig_script) {</span>
<span class="lineNum">    2874 </span><span class="lineNoCov">          0 :             addReplyBulkCString(c,&quot;client-reconfig-script&quot;);</span>
<span class="lineNum">    2875 </span><span class="lineNoCov">          0 :             addReplyBulkCString(c,ri-&gt;client_reconfig_script);</span>
<span class="lineNum">    2876 </span><span class="lineNoCov">          0 :             fields++;</span>
<span class="lineNum">    2877 </span>            :         }
<span class="lineNum">    2878 </span>            :     }
<span class="lineNum">    2879 </span>            : 
<span class="lineNum">    2880 </span>            :     /* Only slaves */
<span class="lineNum">    2881 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_SLAVE) {</span>
<span class="lineNum">    2882 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;master-link-down-time&quot;);</span>
<span class="lineNum">    2883 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;master_link_down_time);</span>
<span class="lineNum">    2884 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2885 </span>            : 
<span class="lineNum">    2886 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;master-link-status&quot;);</span>
<span class="lineNum">    2887 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,</span>
<span class="lineNum">    2888 </span><span class="lineNoCov">          0 :             (ri-&gt;slave_master_link_status == SENTINEL_MASTER_LINK_STATUS_UP) ?</span>
<span class="lineNum">    2889 </span>            :             &quot;ok&quot; : &quot;err&quot;);
<span class="lineNum">    2890 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2891 </span>            : 
<span class="lineNum">    2892 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;master-host&quot;);</span>
<span class="lineNum">    2893 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,</span>
<span class="lineNum">    2894 </span><span class="lineNoCov">          0 :             ri-&gt;slave_master_host ? ri-&gt;slave_master_host : &quot;?&quot;);</span>
<span class="lineNum">    2895 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2896 </span>            : 
<span class="lineNum">    2897 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;master-port&quot;);</span>
<span class="lineNum">    2898 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;slave_master_port);</span>
<span class="lineNum">    2899 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2900 </span>            : 
<span class="lineNum">    2901 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;slave-priority&quot;);</span>
<span class="lineNum">    2902 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;slave_priority);</span>
<span class="lineNum">    2903 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2904 </span>            : 
<span class="lineNum">    2905 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;slave-repl-offset&quot;);</span>
<span class="lineNum">    2906 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;slave_repl_offset);</span>
<span class="lineNum">    2907 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2908 </span>            :     }
<span class="lineNum">    2909 </span>            : 
<span class="lineNum">    2910 </span>            :     /* Only sentinels */
<span class="lineNum">    2911 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_SENTINEL) {</span>
<span class="lineNum">    2912 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;last-hello-message&quot;);</span>
<span class="lineNum">    2913 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,mstime() - ri-&gt;last_hello_time);</span>
<span class="lineNum">    2914 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2915 </span>            : 
<span class="lineNum">    2916 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;voted-leader&quot;);</span>
<span class="lineNum">    2917 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,ri-&gt;leader ? ri-&gt;leader : &quot;?&quot;);</span>
<span class="lineNum">    2918 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2919 </span>            : 
<span class="lineNum">    2920 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,&quot;voted-leader-epoch&quot;);</span>
<span class="lineNum">    2921 </span><span class="lineNoCov">          0 :         addReplyBulkLongLong(c,ri-&gt;leader_epoch);</span>
<span class="lineNum">    2922 </span><span class="lineNoCov">          0 :         fields++;</span>
<span class="lineNum">    2923 </span>            :     }
<span class="lineNum">    2924 </span>            : 
<span class="lineNum">    2925 </span><span class="lineNoCov">          0 :     setDeferredMultiBulkLength(c,mbl,fields*2);</span>
<span class="lineNum">    2926 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2927 </span>            : 
<a name="2928"><span class="lineNum">    2928 </span>            : /* Output a number of instances contained inside a dictionary as</a>
<span class="lineNum">    2929 </span>            :  * Redis protocol. */
<span class="lineNum">    2930 </span><span class="lineNoCov">          0 : void addReplyDictOfRedisInstances(client *c, dict *instances) {</span>
<span class="lineNum">    2931 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    2932 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    2933 </span>            : 
<span class="lineNum">    2934 </span><span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    2935 </span><span class="lineNoCov">          0 :     addReplyMultiBulkLen(c,dictSize(instances));</span>
<span class="lineNum">    2936 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2937 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    2938 </span>            : 
<span class="lineNum">    2939 </span><span class="lineNoCov">          0 :         addReplySentinelRedisInstance(c,ri);</span>
<span class="lineNum">    2940 </span>            :     }
<span class="lineNum">    2941 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2942 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2943 </span>            : 
<span class="lineNum">    2944 </span>            : /* Lookup the named master into sentinel.masters.
<a name="2945"><span class="lineNum">    2945 </span>            :  * If the master is not found reply to the client with an error and returns</a>
<span class="lineNum">    2946 </span>            :  * NULL. */
<span class="lineNum">    2947 </span><span class="lineNoCov">          0 : sentinelRedisInstance *sentinelGetMasterByNameOrReplyError(client *c,</span>
<span class="lineNum">    2948 </span>            :                         robj *name)
<span class="lineNum">    2949 </span>            : {
<span class="lineNum">    2950 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri;</span>
<span class="lineNum">    2951 </span>            : 
<span class="lineNum">    2952 </span><span class="lineNoCov">          0 :     ri = dictFetchValue(sentinel.masters,name-&gt;ptr);</span>
<span class="lineNum">    2953 </span><span class="lineNoCov">          0 :     if (!ri) {</span>
<span class="lineNum">    2954 </span><span class="lineNoCov">          0 :         addReplyError(c,&quot;No such master with that name&quot;);</span>
<span class="lineNum">    2955 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    2956 </span>            :     }
<span class="lineNum">    2957 </span>            :     return ri;
<span class="lineNum">    2958 </span>            : }
<span class="lineNum">    2959 </span>            : 
<span class="lineNum">    2960 </span>            : #define SENTINEL_ISQR_OK 0
<a name="2961"><span class="lineNum">    2961 </span>            : #define SENTINEL_ISQR_NOQUORUM (1&lt;&lt;0)</a>
<span class="lineNum">    2962 </span>            : #define SENTINEL_ISQR_NOAUTH (1&lt;&lt;1)
<span class="lineNum">    2963 </span><span class="lineNoCov">          0 : int sentinelIsQuorumReachable(sentinelRedisInstance *master, int *usableptr) {</span>
<span class="lineNum">    2964 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    2965 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    2966 </span><span class="lineNoCov">          0 :     int usable = 1; /* Number of usable Sentinels. Init to 1 to count myself. */</span>
<span class="lineNum">    2967 </span><span class="lineNoCov">          0 :     int result = SENTINEL_ISQR_OK;</span>
<span class="lineNum">    2968 </span><span class="lineNoCov">          0 :     int voters = dictSize(master-&gt;sentinels)+1; /* Known Sentinels + myself. */</span>
<span class="lineNum">    2969 </span>            : 
<span class="lineNum">    2970 </span><span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;sentinels);</span>
<span class="lineNum">    2971 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    2972 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    2973 </span>            : 
<span class="lineNum">    2974 </span><span class="lineNoCov">          0 :         if (ri-&gt;flags &amp; (SRI_S_DOWN|SRI_O_DOWN)) continue;</span>
<span class="lineNum">    2975 </span><span class="lineNoCov">          0 :         usable++;</span>
<span class="lineNum">    2976 </span>            :     }
<span class="lineNum">    2977 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    2978 </span>            : 
<span class="lineNum">    2979 </span><span class="lineNoCov">          0 :     if (usable &lt; (int)master-&gt;quorum) result |= SENTINEL_ISQR_NOQUORUM;</span>
<span class="lineNum">    2980 </span><span class="lineNoCov">          0 :     if (usable &lt; voters/2+1) result |= SENTINEL_ISQR_NOAUTH;</span>
<span class="lineNum">    2981 </span><span class="lineNoCov">          0 :     if (usableptr) *usableptr = usable;</span>
<span class="lineNum">    2982 </span><span class="lineNoCov">          0 :     return result;</span>
<a name="2983"><span class="lineNum">    2983 </span>            : }</a>
<span class="lineNum">    2984 </span>            : 
<span class="lineNum">    2985 </span><span class="lineNoCov">          0 : void sentinelCommand(client *c) {</span>
<span class="lineNum">    2986 </span><span class="lineNoCov">          0 :     if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;masters&quot;)) {</span>
<span class="lineNum">    2987 </span>            :         /* SENTINEL MASTERS */
<span class="lineNum">    2988 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 2) goto numargserr;</span>
<span class="lineNum">    2989 </span><span class="lineNoCov">          0 :         addReplyDictOfRedisInstances(c,sentinel.masters);</span>
<span class="lineNum">    2990 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;master&quot;)) {</span>
<span class="lineNum">    2991 </span>            :         /* SENTINEL MASTER &lt;name&gt; */
<span class="lineNum">    2992 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri;</span>
<span class="lineNum">    2993 </span>            : 
<span class="lineNum">    2994 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    2995 </span><span class="lineNoCov">          0 :         if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2]))</span>
<span class="lineNum">    2996 </span>            :             == NULL) return;
<span class="lineNum">    2997 </span><span class="lineNoCov">          0 :         addReplySentinelRedisInstance(c,ri);</span>
<span class="lineNum">    2998 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;slaves&quot;) ||</span>
<span class="lineNum">    2999 </span><span class="lineNoCov">          0 :                !strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;replicas&quot;))</span>
<span class="lineNum">    3000 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">    3001 </span>            :         /* SENTINEL REPLICAS &lt;master-name&gt; */
<span class="lineNum">    3002 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri;</span>
<span class="lineNum">    3003 </span>            : 
<span class="lineNum">    3004 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    3005 </span><span class="lineNoCov">          0 :         if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2])) == NULL)</span>
<span class="lineNum">    3006 </span>            :             return;
<span class="lineNum">    3007 </span><span class="lineNoCov">          0 :         addReplyDictOfRedisInstances(c,ri-&gt;slaves);</span>
<span class="lineNum">    3008 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;sentinels&quot;)) {</span>
<span class="lineNum">    3009 </span>            :         /* SENTINEL SENTINELS &lt;master-name&gt; */
<span class="lineNum">    3010 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri;</span>
<span class="lineNum">    3011 </span>            : 
<span class="lineNum">    3012 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    3013 </span><span class="lineNoCov">          0 :         if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2])) == NULL)</span>
<span class="lineNum">    3014 </span>            :             return;
<span class="lineNum">    3015 </span><span class="lineNoCov">          0 :         addReplyDictOfRedisInstances(c,ri-&gt;sentinels);</span>
<span class="lineNum">    3016 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;is-master-down-by-addr&quot;)) {</span>
<span class="lineNum">    3017 </span>            :         /* SENTINEL IS-MASTER-DOWN-BY-ADDR &lt;ip&gt; &lt;port&gt; &lt;current-epoch&gt; &lt;runid&gt;
<span class="lineNum">    3018 </span>            :          *
<span class="lineNum">    3019 </span>            :          * Arguments:
<span class="lineNum">    3020 </span>            :          *
<span class="lineNum">    3021 </span>            :          * ip and port are the ip and port of the master we want to be
<span class="lineNum">    3022 </span>            :          * checked by Sentinel. Note that the command will not check by
<span class="lineNum">    3023 </span>            :          * name but just by master, in theory different Sentinels may monitor
<span class="lineNum">    3024 </span>            :          * differnet masters with the same name.
<span class="lineNum">    3025 </span>            :          *
<span class="lineNum">    3026 </span>            :          * current-epoch is needed in order to understand if we are allowed
<span class="lineNum">    3027 </span>            :          * to vote for a failover leader or not. Each Sentinel can vote just
<span class="lineNum">    3028 </span>            :          * one time per epoch.
<span class="lineNum">    3029 </span>            :          *
<span class="lineNum">    3030 </span>            :          * runid is &quot;*&quot; if we are not seeking for a vote from the Sentinel
<span class="lineNum">    3031 </span>            :          * in order to elect the failover leader. Otherwise it is set to the
<span class="lineNum">    3032 </span>            :          * runid we want the Sentinel to vote if it did not already voted.
<span class="lineNum">    3033 </span>            :          */
<span class="lineNum">    3034 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri;</span>
<span class="lineNum">    3035 </span><span class="lineNoCov">          0 :         long long req_epoch;</span>
<span class="lineNum">    3036 </span><span class="lineNoCov">          0 :         uint64_t leader_epoch = 0;</span>
<span class="lineNum">    3037 </span><span class="lineNoCov">          0 :         char *leader = NULL;</span>
<span class="lineNum">    3038 </span><span class="lineNoCov">          0 :         long port;</span>
<span class="lineNum">    3039 </span><span class="lineNoCov">          0 :         int isdown = 0;</span>
<span class="lineNum">    3040 </span>            : 
<span class="lineNum">    3041 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 6) goto numargserr;</span>
<span class="lineNum">    3042 </span><span class="lineNoCov">          0 :         if (getLongFromObjectOrReply(c,c-&gt;argv[3],&amp;port,NULL) != C_OK ||</span>
<span class="lineNum">    3043 </span><span class="lineNoCov">          0 :             getLongLongFromObjectOrReply(c,c-&gt;argv[4],&amp;req_epoch,NULL)</span>
<span class="lineNum">    3044 </span>            :                                                               != C_OK)
<span class="lineNum">    3045 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    3046 </span><span class="lineNoCov">          0 :         ri = getSentinelRedisInstanceByAddrAndRunID(sentinel.masters,</span>
<span class="lineNum">    3047 </span><span class="lineNoCov">          0 :             c-&gt;argv[2]-&gt;ptr,port,NULL);</span>
<span class="lineNum">    3048 </span>            : 
<span class="lineNum">    3049 </span>            :         /* It exists? Is actually a master? Is subjectively down? It's down.
<span class="lineNum">    3050 </span>            :          * Note: if we are in tilt mode we always reply with &quot;0&quot;. */
<span class="lineNum">    3051 </span><span class="lineNoCov">          0 :         if (!sentinel.tilt &amp;&amp; ri &amp;&amp; (ri-&gt;flags &amp; SRI_S_DOWN) &amp;&amp;</span>
<span class="lineNum">    3052 </span>            :                                     (ri-&gt;flags &amp; SRI_MASTER))
<span class="lineNum">    3053 </span><span class="lineNoCov">          0 :             isdown = 1;</span>
<span class="lineNum">    3054 </span>            : 
<span class="lineNum">    3055 </span>            :         /* Vote for the master (or fetch the previous vote) if the request
<span class="lineNum">    3056 </span>            :          * includes a runid, otherwise the sender is not seeking for a vote. */
<span class="lineNum">    3057 </span><span class="lineNoCov">          0 :         if (ri &amp;&amp; ri-&gt;flags &amp; SRI_MASTER &amp;&amp; strcasecmp(c-&gt;argv[5]-&gt;ptr,&quot;*&quot;)) {</span>
<span class="lineNum">    3058 </span><span class="lineNoCov">          0 :             leader = sentinelVoteLeader(ri,(uint64_t)req_epoch,</span>
<span class="lineNum">    3059 </span>            :                                             c-&gt;argv[5]-&gt;ptr,
<span class="lineNum">    3060 </span>            :                                             &amp;leader_epoch);
<span class="lineNum">    3061 </span>            :         }
<span class="lineNum">    3062 </span>            : 
<span class="lineNum">    3063 </span>            :         /* Reply with a three-elements multi-bulk reply:
<span class="lineNum">    3064 </span>            :          * down state, leader, vote epoch. */
<span class="lineNum">    3065 </span><span class="lineNoCov">          0 :         addReplyMultiBulkLen(c,3);</span>
<span class="lineNum">    3066 </span><span class="lineNoCov">          0 :         addReply(c, isdown ? shared.cone : shared.czero);</span>
<span class="lineNum">    3067 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c, leader ? leader : &quot;*&quot;);</span>
<span class="lineNum">    3068 </span><span class="lineNoCov">          0 :         addReplyLongLong(c, (long long)leader_epoch);</span>
<span class="lineNum">    3069 </span><span class="lineNoCov">          0 :         if (leader) sdsfree(leader);</span>
<span class="lineNum">    3070 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;reset&quot;)) {</span>
<span class="lineNum">    3071 </span>            :         /* SENTINEL RESET &lt;pattern&gt; */
<span class="lineNum">    3072 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    3073 </span><span class="lineNoCov">          0 :         addReplyLongLong(c,sentinelResetMastersByPattern(c-&gt;argv[2]-&gt;ptr,SENTINEL_GENERATE_EVENT));</span>
<span class="lineNum">    3074 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;get-master-addr-by-name&quot;)) {</span>
<span class="lineNum">    3075 </span>            :         /* SENTINEL GET-MASTER-ADDR-BY-NAME &lt;master-name&gt; */
<span class="lineNum">    3076 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri;</span>
<span class="lineNum">    3077 </span>            : 
<span class="lineNum">    3078 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    3079 </span><span class="lineNoCov">          0 :         ri = sentinelGetMasterByName(c-&gt;argv[2]-&gt;ptr);</span>
<span class="lineNum">    3080 </span><span class="lineNoCov">          0 :         if (ri == NULL) {</span>
<span class="lineNum">    3081 </span><span class="lineNoCov">          0 :             addReply(c,shared.nullmultibulk);</span>
<span class="lineNum">    3082 </span>            :         } else {
<span class="lineNum">    3083 </span><span class="lineNoCov">          0 :             sentinelAddr *addr = sentinelGetCurrentMasterAddress(ri);</span>
<span class="lineNum">    3084 </span>            : 
<span class="lineNum">    3085 </span><span class="lineNoCov">          0 :             addReplyMultiBulkLen(c,2);</span>
<span class="lineNum">    3086 </span><span class="lineNoCov">          0 :             addReplyBulkCString(c,addr-&gt;ip);</span>
<span class="lineNum">    3087 </span><span class="lineNoCov">          0 :             addReplyBulkLongLong(c,addr-&gt;port);</span>
<span class="lineNum">    3088 </span>            :         }
<span class="lineNum">    3089 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;failover&quot;)) {</span>
<span class="lineNum">    3090 </span>            :         /* SENTINEL FAILOVER &lt;master-name&gt; */
<span class="lineNum">    3091 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri;</span>
<span class="lineNum">    3092 </span>            : 
<span class="lineNum">    3093 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    3094 </span><span class="lineNoCov">          0 :         if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2])) == NULL)</span>
<span class="lineNum">    3095 </span>            :             return;
<span class="lineNum">    3096 </span><span class="lineNoCov">          0 :         if (ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) {</span>
<span class="lineNum">    3097 </span><span class="lineNoCov">          0 :             addReplySds(c,sdsnew(&quot;-INPROG Failover already in progress\r\n&quot;));</span>
<span class="lineNum">    3098 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    3099 </span>            :         }
<span class="lineNum">    3100 </span><span class="lineNoCov">          0 :         if (sentinelSelectSlave(ri) == NULL) {</span>
<span class="lineNum">    3101 </span><span class="lineNoCov">          0 :             addReplySds(c,sdsnew(&quot;-NOGOODSLAVE No suitable replica to promote\r\n&quot;));</span>
<span class="lineNum">    3102 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    3103 </span>            :         }
<span class="lineNum">    3104 </span><span class="lineNoCov">          0 :         serverLog(LL_WARNING,&quot;Executing user requested FAILOVER of '%s'&quot;,</span>
<span class="lineNum">    3105 </span>            :             ri-&gt;name);
<span class="lineNum">    3106 </span><span class="lineNoCov">          0 :         sentinelStartFailover(ri);</span>
<span class="lineNum">    3107 </span><span class="lineNoCov">          0 :         ri-&gt;flags |= SRI_FORCE_FAILOVER;</span>
<span class="lineNum">    3108 </span><span class="lineNoCov">          0 :         addReply(c,shared.ok);</span>
<span class="lineNum">    3109 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;pending-scripts&quot;)) {</span>
<span class="lineNum">    3110 </span>            :         /* SENTINEL PENDING-SCRIPTS */
<span class="lineNum">    3111 </span>            : 
<span class="lineNum">    3112 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 2) goto numargserr;</span>
<span class="lineNum">    3113 </span><span class="lineNoCov">          0 :         sentinelPendingScriptsCommand(c);</span>
<span class="lineNum">    3114 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;monitor&quot;)) {</span>
<span class="lineNum">    3115 </span>            :         /* SENTINEL MONITOR &lt;name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt; */
<span class="lineNum">    3116 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri;</span>
<span class="lineNum">    3117 </span><span class="lineNoCov">          0 :         long quorum, port;</span>
<span class="lineNum">    3118 </span><span class="lineNoCov">          0 :         char ip[NET_IP_STR_LEN];</span>
<span class="lineNum">    3119 </span>            : 
<span class="lineNum">    3120 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 6) goto numargserr;</span>
<span class="lineNum">    3121 </span><span class="lineNoCov">          0 :         if (getLongFromObjectOrReply(c,c-&gt;argv[5],&amp;quorum,&quot;Invalid quorum&quot;)</span>
<span class="lineNum">    3122 </span><span class="lineNoCov">          0 :             != C_OK) return;</span>
<span class="lineNum">    3123 </span><span class="lineNoCov">          0 :         if (getLongFromObjectOrReply(c,c-&gt;argv[4],&amp;port,&quot;Invalid port&quot;)</span>
<span class="lineNum">    3124 </span>            :             != C_OK) return;
<span class="lineNum">    3125 </span>            : 
<span class="lineNum">    3126 </span><span class="lineNoCov">          0 :         if (quorum &lt;= 0) {</span>
<span class="lineNum">    3127 </span><span class="lineNoCov">          0 :             addReplyError(c, &quot;Quorum must be 1 or greater.&quot;);</span>
<span class="lineNum">    3128 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    3129 </span>            :         }
<span class="lineNum">    3130 </span>            : 
<span class="lineNum">    3131 </span>            :         /* Make sure the IP field is actually a valid IP before passing it
<span class="lineNum">    3132 </span>            :          * to createSentinelRedisInstance(), otherwise we may trigger a
<span class="lineNum">    3133 </span>            :          * DNS lookup at runtime. */
<span class="lineNum">    3134 </span><span class="lineNoCov">          0 :         if (anetResolveIP(NULL,c-&gt;argv[3]-&gt;ptr,ip,sizeof(ip)) == ANET_ERR) {</span>
<span class="lineNum">    3135 </span><span class="lineNoCov">          0 :             addReplyError(c,&quot;Invalid IP address specified&quot;);</span>
<span class="lineNum">    3136 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    3137 </span>            :         }
<span class="lineNum">    3138 </span>            : 
<span class="lineNum">    3139 </span>            :         /* Parameters are valid. Try to create the master instance. */
<span class="lineNum">    3140 </span><span class="lineNoCov">          0 :         ri = createSentinelRedisInstance(c-&gt;argv[2]-&gt;ptr,SRI_MASTER,</span>
<span class="lineNum">    3141 </span><span class="lineNoCov">          0 :                 c-&gt;argv[3]-&gt;ptr,port,quorum,NULL);</span>
<span class="lineNum">    3142 </span><span class="lineNoCov">          0 :         if (ri == NULL) {</span>
<span class="lineNum">    3143 </span><span class="lineNoCov">          0 :             switch(errno) {</span>
<span class="lineNum">    3144 </span><span class="lineNoCov">          0 :             case EBUSY:</span>
<span class="lineNum">    3145 </span><span class="lineNoCov">          0 :                 addReplyError(c,&quot;Duplicated master name&quot;);</span>
<span class="lineNum">    3146 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    3147 </span><span class="lineNoCov">          0 :             case EINVAL:</span>
<span class="lineNum">    3148 </span><span class="lineNoCov">          0 :                 addReplyError(c,&quot;Invalid port number&quot;);</span>
<span class="lineNum">    3149 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    3150 </span><span class="lineNoCov">          0 :             default:</span>
<span class="lineNum">    3151 </span><span class="lineNoCov">          0 :                 addReplyError(c,&quot;Unspecified error adding the instance&quot;);</span>
<span class="lineNum">    3152 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    3153 </span>            :             }
<span class="lineNum">    3154 </span>            :         } else {
<span class="lineNum">    3155 </span><span class="lineNoCov">          0 :             sentinelFlushConfig();</span>
<span class="lineNum">    3156 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;+monitor&quot;,ri,&quot;%@ quorum %d&quot;,ri-&gt;quorum);</span>
<span class="lineNum">    3157 </span><span class="lineNoCov">          0 :             addReply(c,shared.ok);</span>
<span class="lineNum">    3158 </span>            :         }
<span class="lineNum">    3159 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;flushconfig&quot;)) {</span>
<span class="lineNum">    3160 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 2) goto numargserr;</span>
<span class="lineNum">    3161 </span><span class="lineNoCov">          0 :         sentinelFlushConfig();</span>
<span class="lineNum">    3162 </span><span class="lineNoCov">          0 :         addReply(c,shared.ok);</span>
<span class="lineNum">    3163 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    3164 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;remove&quot;)) {</span>
<span class="lineNum">    3165 </span>            :         /* SENTINEL REMOVE &lt;name&gt; */
<span class="lineNum">    3166 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri;</span>
<span class="lineNum">    3167 </span>            : 
<span class="lineNum">    3168 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    3169 </span><span class="lineNoCov">          0 :         if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2]))</span>
<span class="lineNum">    3170 </span>            :             == NULL) return;
<span class="lineNum">    3171 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;-monitor&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    3172 </span><span class="lineNoCov">          0 :         dictDelete(sentinel.masters,c-&gt;argv[2]-&gt;ptr);</span>
<span class="lineNum">    3173 </span><span class="lineNoCov">          0 :         sentinelFlushConfig();</span>
<span class="lineNum">    3174 </span><span class="lineNoCov">          0 :         addReply(c,shared.ok);</span>
<span class="lineNum">    3175 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;ckquorum&quot;)) {</span>
<span class="lineNum">    3176 </span>            :         /* SENTINEL CKQUORUM &lt;name&gt; */
<span class="lineNum">    3177 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri;</span>
<span class="lineNum">    3178 </span><span class="lineNoCov">          0 :         int usable;</span>
<span class="lineNum">    3179 </span>            : 
<span class="lineNum">    3180 </span><span class="lineNoCov">          0 :         if (c-&gt;argc != 3) goto numargserr;</span>
<span class="lineNum">    3181 </span><span class="lineNoCov">          0 :         if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2]))</span>
<span class="lineNum">    3182 </span><span class="lineNoCov">          0 :             == NULL) return;</span>
<span class="lineNum">    3183 </span><span class="lineNoCov">          0 :         int result = sentinelIsQuorumReachable(ri,&amp;usable);</span>
<span class="lineNum">    3184 </span><span class="lineNoCov">          0 :         if (result == SENTINEL_ISQR_OK) {</span>
<span class="lineNum">    3185 </span><span class="lineNoCov">          0 :             addReplySds(c, sdscatfmt(sdsempty(),</span>
<span class="lineNum">    3186 </span>            :                 &quot;+OK %i usable Sentinels. Quorum and failover authorization &quot;
<span class="lineNum">    3187 </span>            :                 &quot;can be reached\r\n&quot;,usable));
<span class="lineNum">    3188 </span>            :         } else {
<span class="lineNum">    3189 </span><span class="lineNoCov">          0 :             sds e = sdscatfmt(sdsempty(),</span>
<span class="lineNum">    3190 </span>            :                 &quot;-NOQUORUM %i usable Sentinels. &quot;,usable);
<span class="lineNum">    3191 </span><span class="lineNoCov">          0 :             if (result &amp; SENTINEL_ISQR_NOQUORUM)</span>
<span class="lineNum">    3192 </span><span class="lineNoCov">          0 :                 e = sdscat(e,&quot;Not enough available Sentinels to reach the&quot;</span>
<span class="lineNum">    3193 </span>            :                              &quot; specified quorum for this master&quot;);
<span class="lineNum">    3194 </span><span class="lineNoCov">          0 :             if (result &amp; SENTINEL_ISQR_NOAUTH) {</span>
<span class="lineNum">    3195 </span><span class="lineNoCov">          0 :                 if (result &amp; SENTINEL_ISQR_NOQUORUM) e = sdscat(e,&quot;. &quot;);</span>
<span class="lineNum">    3196 </span><span class="lineNoCov">          0 :                 e = sdscat(e, &quot;Not enough available Sentinels to reach the&quot;</span>
<span class="lineNum">    3197 </span>            :                               &quot; majority and authorize a failover&quot;);
<span class="lineNum">    3198 </span>            :             }
<span class="lineNum">    3199 </span><span class="lineNoCov">          0 :             e = sdscat(e,&quot;\r\n&quot;);</span>
<span class="lineNum">    3200 </span><span class="lineNoCov">          0 :             addReplySds(c,e);</span>
<span class="lineNum">    3201 </span>            :         }
<span class="lineNum">    3202 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;set&quot;)) {</span>
<span class="lineNum">    3203 </span><span class="lineNoCov">          0 :         if (c-&gt;argc &lt; 3) goto numargserr;</span>
<span class="lineNum">    3204 </span><span class="lineNoCov">          0 :         sentinelSetCommand(c);</span>
<span class="lineNum">    3205 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;info-cache&quot;)) {</span>
<span class="lineNum">    3206 </span>            :         /* SENTINEL INFO-CACHE &lt;name&gt; */
<span class="lineNum">    3207 </span><span class="lineNoCov">          0 :         if (c-&gt;argc &lt; 2) goto numargserr;</span>
<span class="lineNum">    3208 </span><span class="lineNoCov">          0 :         mstime_t now = mstime();</span>
<span class="lineNum">    3209 </span>            : 
<span class="lineNum">    3210 </span>            :         /* Create an ad-hoc dictionary type so that we can iterate
<span class="lineNum">    3211 </span>            :          * a dictionary composed of just the master groups the user
<span class="lineNum">    3212 </span>            :          * requested. */
<span class="lineNum">    3213 </span><span class="lineNoCov">          0 :         dictType copy_keeper = instancesDictType;</span>
<span class="lineNum">    3214 </span><span class="lineNoCov">          0 :         copy_keeper.valDestructor = NULL;</span>
<span class="lineNum">    3215 </span><span class="lineNoCov">          0 :         dict *masters_local = sentinel.masters;</span>
<span class="lineNum">    3216 </span><span class="lineNoCov">          0 :         if (c-&gt;argc &gt; 2) {</span>
<span class="lineNum">    3217 </span><span class="lineNoCov">          0 :             masters_local = dictCreate(&amp;copy_keeper, NULL);</span>
<span class="lineNum">    3218 </span>            : 
<span class="lineNum">    3219 </span><span class="lineNoCov">          0 :             for (int i = 2; i &lt; c-&gt;argc; i++) {</span>
<span class="lineNum">    3220 </span><span class="lineNoCov">          0 :                 sentinelRedisInstance *ri;</span>
<span class="lineNum">    3221 </span><span class="lineNoCov">          0 :                 ri = sentinelGetMasterByName(c-&gt;argv[i]-&gt;ptr);</span>
<span class="lineNum">    3222 </span><span class="lineNoCov">          0 :                 if (!ri) continue; /* ignore non-existing names */</span>
<span class="lineNum">    3223 </span><span class="lineNoCov">          0 :                 dictAdd(masters_local, ri-&gt;name, ri);</span>
<span class="lineNum">    3224 </span>            :             }
<span class="lineNum">    3225 </span>            :         }
<span class="lineNum">    3226 </span>            : 
<span class="lineNum">    3227 </span>            :         /* Reply format:
<span class="lineNum">    3228 </span>            :          *   1.) master name
<span class="lineNum">    3229 </span>            :          *   2.) 1.) info from master
<span class="lineNum">    3230 </span>            :          *       2.) info from replica
<span class="lineNum">    3231 </span>            :          *       ...
<span class="lineNum">    3232 </span>            :          *   3.) other master name
<span class="lineNum">    3233 </span>            :          *   ...
<span class="lineNum">    3234 </span>            :          */
<span class="lineNum">    3235 </span><span class="lineNoCov">          0 :         addReplyMultiBulkLen(c,dictSize(masters_local) * 2);</span>
<span class="lineNum">    3236 </span>            : 
<span class="lineNum">    3237 </span><span class="lineNoCov">          0 :         dictIterator  *di;</span>
<span class="lineNum">    3238 </span><span class="lineNoCov">          0 :         dictEntry *de;</span>
<span class="lineNum">    3239 </span><span class="lineNoCov">          0 :         di = dictGetIterator(masters_local);</span>
<span class="lineNum">    3240 </span><span class="lineNoCov">          0 :         while ((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    3241 </span><span class="lineNoCov">          0 :             sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    3242 </span><span class="lineNoCov">          0 :             addReplyBulkCBuffer(c,ri-&gt;name,strlen(ri-&gt;name));</span>
<span class="lineNum">    3243 </span><span class="lineNoCov">          0 :             addReplyMultiBulkLen(c,dictSize(ri-&gt;slaves) + 1); /* +1 for self */</span>
<span class="lineNum">    3244 </span><span class="lineNoCov">          0 :             addReplyMultiBulkLen(c,2);</span>
<span class="lineNum">    3245 </span><span class="lineNoCov">          0 :             addReplyLongLong(c, now - ri-&gt;info_refresh);</span>
<span class="lineNum">    3246 </span><span class="lineNoCov">          0 :             if (ri-&gt;info)</span>
<span class="lineNum">    3247 </span><span class="lineNoCov">          0 :                 addReplyBulkCBuffer(c,ri-&gt;info,sdslen(ri-&gt;info));</span>
<span class="lineNum">    3248 </span>            :             else
<span class="lineNum">    3249 </span><span class="lineNoCov">          0 :                 addReply(c,shared.nullbulk);</span>
<span class="lineNum">    3250 </span>            : 
<span class="lineNum">    3251 </span><span class="lineNoCov">          0 :             dictIterator *sdi;</span>
<span class="lineNum">    3252 </span><span class="lineNoCov">          0 :             dictEntry *sde;</span>
<span class="lineNum">    3253 </span><span class="lineNoCov">          0 :             sdi = dictGetIterator(ri-&gt;slaves);</span>
<span class="lineNum">    3254 </span><span class="lineNoCov">          0 :             while ((sde = dictNext(sdi)) != NULL) {</span>
<span class="lineNum">    3255 </span><span class="lineNoCov">          0 :                 sentinelRedisInstance *sri = dictGetVal(sde);</span>
<span class="lineNum">    3256 </span><span class="lineNoCov">          0 :                 addReplyMultiBulkLen(c,2);</span>
<span class="lineNum">    3257 </span><span class="lineNoCov">          0 :                 addReplyLongLong(c, now - sri-&gt;info_refresh);</span>
<span class="lineNum">    3258 </span><span class="lineNoCov">          0 :                 if (sri-&gt;info)</span>
<span class="lineNum">    3259 </span><span class="lineNoCov">          0 :                     addReplyBulkCBuffer(c,sri-&gt;info,sdslen(sri-&gt;info));</span>
<span class="lineNum">    3260 </span>            :                 else
<span class="lineNum">    3261 </span><span class="lineNoCov">          0 :                     addReply(c,shared.nullbulk);</span>
<span class="lineNum">    3262 </span>            :             }
<span class="lineNum">    3263 </span><span class="lineNoCov">          0 :             dictReleaseIterator(sdi);</span>
<span class="lineNum">    3264 </span>            :         }
<span class="lineNum">    3265 </span><span class="lineNoCov">          0 :         dictReleaseIterator(di);</span>
<span class="lineNum">    3266 </span><span class="lineNoCov">          0 :         if (masters_local != sentinel.masters) dictRelease(masters_local);</span>
<span class="lineNum">    3267 </span><span class="lineNoCov">          0 :     } else if (!strcasecmp(c-&gt;argv[1]-&gt;ptr,&quot;simulate-failure&quot;)) {</span>
<span class="lineNum">    3268 </span>            :         /* SENTINEL SIMULATE-FAILURE &lt;flag&gt; &lt;flag&gt; ... &lt;flag&gt; */
<span class="lineNum">    3269 </span><span class="lineNoCov">          0 :         int j;</span>
<span class="lineNum">    3270 </span>            : 
<span class="lineNum">    3271 </span><span class="lineNoCov">          0 :         sentinel.simfailure_flags = SENTINEL_SIMFAILURE_NONE;</span>
<span class="lineNum">    3272 </span><span class="lineNoCov">          0 :         for (j = 2; j &lt; c-&gt;argc; j++) {</span>
<span class="lineNum">    3273 </span><span class="lineNoCov">          0 :             if (!strcasecmp(c-&gt;argv[j]-&gt;ptr,&quot;crash-after-election&quot;)) {</span>
<span class="lineNum">    3274 </span><span class="lineNoCov">          0 :                 sentinel.simfailure_flags |=</span>
<span class="lineNum">    3275 </span>            :                     SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION;
<span class="lineNum">    3276 </span><span class="lineNoCov">          0 :                 serverLog(LL_WARNING,&quot;Failure simulation: this Sentinel &quot;</span>
<span class="lineNum">    3277 </span>            :                     &quot;will crash after being successfully elected as failover &quot;
<span class="lineNum">    3278 </span>            :                     &quot;leader&quot;);
<span class="lineNum">    3279 </span><span class="lineNoCov">          0 :             } else if (!strcasecmp(c-&gt;argv[j]-&gt;ptr,&quot;crash-after-promotion&quot;)) {</span>
<span class="lineNum">    3280 </span><span class="lineNoCov">          0 :                 sentinel.simfailure_flags |=</span>
<span class="lineNum">    3281 </span>            :                     SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION;
<span class="lineNum">    3282 </span><span class="lineNoCov">          0 :                 serverLog(LL_WARNING,&quot;Failure simulation: this Sentinel &quot;</span>
<span class="lineNum">    3283 </span>            :                     &quot;will crash after promoting the selected replica to master&quot;);
<span class="lineNum">    3284 </span><span class="lineNoCov">          0 :             } else if (!strcasecmp(c-&gt;argv[j]-&gt;ptr,&quot;help&quot;)) {</span>
<span class="lineNum">    3285 </span><span class="lineNoCov">          0 :                 addReplyMultiBulkLen(c,2);</span>
<span class="lineNum">    3286 </span><span class="lineNoCov">          0 :                 addReplyBulkCString(c,&quot;crash-after-election&quot;);</span>
<span class="lineNum">    3287 </span><span class="lineNoCov">          0 :                 addReplyBulkCString(c,&quot;crash-after-promotion&quot;);</span>
<span class="lineNum">    3288 </span>            :             } else {
<span class="lineNum">    3289 </span><span class="lineNoCov">          0 :                 addReplyError(c,&quot;Unknown failure simulation specified&quot;);</span>
<span class="lineNum">    3290 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3291 </span>            :             }
<span class="lineNum">    3292 </span>            :         }
<span class="lineNum">    3293 </span><span class="lineNoCov">          0 :         addReply(c,shared.ok);</span>
<span class="lineNum">    3294 </span>            :     } else {
<span class="lineNum">    3295 </span><span class="lineNoCov">          0 :         addReplyErrorFormat(c,&quot;Unknown sentinel subcommand '%s'&quot;,</span>
<span class="lineNum">    3296 </span>            :                                (char*)c-&gt;argv[1]-&gt;ptr);
<span class="lineNum">    3297 </span>            :     }
<span class="lineNum">    3298 </span>            :     return;
<span class="lineNum">    3299 </span>            : 
<span class="lineNum">    3300 </span><span class="lineNoCov">          0 : numargserr:</span>
<span class="lineNum">    3301 </span><span class="lineNoCov">          0 :     addReplyErrorFormat(c,&quot;Wrong number of arguments for 'sentinel %s'&quot;,</span>
<span class="lineNum">    3302 </span><span class="lineNoCov">          0 :                           (char*)c-&gt;argv[1]-&gt;ptr);</span>
<span class="lineNum">    3303 </span>            : }
<span class="lineNum">    3304 </span>            : 
<span class="lineNum">    3305 </span>            : #define info_section_from_redis(section_name) do { \
<span class="lineNum">    3306 </span>            :     if (defsections || allsections || !strcasecmp(section,section_name)) { \
<span class="lineNum">    3307 </span>            :         sds redissection; \
<span class="lineNum">    3308 </span>            :         if (sections++) info = sdscat(info,&quot;\r\n&quot;); \
<span class="lineNum">    3309 </span>            :         redissection = genRedisInfoString(section_name); \
<span class="lineNum">    3310 </span>            :         info = sdscatlen(info,redissection,sdslen(redissection)); \
<span class="lineNum">    3311 </span>            :         sdsfree(redissection); \
<span class="lineNum">    3312 </span>            :     } \
<span class="lineNum">    3313 </span>            : } while(0)
<a name="3314"><span class="lineNum">    3314 </span>            : </a>
<span class="lineNum">    3315 </span>            : /* SENTINEL INFO [section] */
<span class="lineNum">    3316 </span><span class="lineNoCov">          0 : void sentinelInfoCommand(client *c) {</span>
<span class="lineNum">    3317 </span><span class="lineNoCov">          0 :     if (c-&gt;argc &gt; 2) {</span>
<span class="lineNum">    3318 </span><span class="lineNoCov">          0 :         addReply(c,shared.syntaxerr);</span>
<span class="lineNum">    3319 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    3320 </span>            :     }
<span class="lineNum">    3321 </span>            : 
<span class="lineNum">    3322 </span><span class="lineNoCov">          0 :     int defsections = 0, allsections = 0;</span>
<span class="lineNum">    3323 </span><span class="lineNoCov">          0 :     char *section = c-&gt;argc == 2 ? c-&gt;argv[1]-&gt;ptr : NULL;</span>
<span class="lineNum">    3324 </span><span class="lineNoCov">          0 :     if (section) {</span>
<span class="lineNum">    3325 </span><span class="lineNoCov">          0 :         allsections = !strcasecmp(section,&quot;all&quot;);</span>
<span class="lineNum">    3326 </span><span class="lineNoCov">          0 :         defsections = !strcasecmp(section,&quot;default&quot;);</span>
<span class="lineNum">    3327 </span>            :     } else {
<span class="lineNum">    3328 </span>            :         defsections = 1;
<span class="lineNum">    3329 </span>            :     }
<span class="lineNum">    3330 </span>            : 
<span class="lineNum">    3331 </span><span class="lineNoCov">          0 :     int sections = 0;</span>
<span class="lineNum">    3332 </span><span class="lineNoCov">          0 :     sds info = sdsempty();</span>
<span class="lineNum">    3333 </span>            : 
<span class="lineNum">    3334 </span><span class="lineNoCov">          0 :     info_section_from_redis(&quot;server&quot;);</span>
<span class="lineNum">    3335 </span><span class="lineNoCov">          0 :     info_section_from_redis(&quot;clients&quot;);</span>
<span class="lineNum">    3336 </span><span class="lineNoCov">          0 :     info_section_from_redis(&quot;cpu&quot;);</span>
<span class="lineNum">    3337 </span><span class="lineNoCov">          0 :     info_section_from_redis(&quot;stats&quot;);</span>
<span class="lineNum">    3338 </span>            : 
<span class="lineNum">    3339 </span><span class="lineNoCov">          0 :     if (defsections || allsections || !strcasecmp(section,&quot;sentinel&quot;)) {</span>
<span class="lineNum">    3340 </span><span class="lineNoCov">          0 :         dictIterator *di;</span>
<span class="lineNum">    3341 </span><span class="lineNoCov">          0 :         dictEntry *de;</span>
<span class="lineNum">    3342 </span><span class="lineNoCov">          0 :         int master_id = 0;</span>
<span class="lineNum">    3343 </span>            : 
<span class="lineNum">    3344 </span><span class="lineNoCov">          0 :         if (sections++) info = sdscat(info,&quot;\r\n&quot;);</span>
<span class="lineNum">    3345 </span><span class="lineNoCov">          0 :         info = sdscatprintf(info,</span>
<span class="lineNum">    3346 </span>            :             &quot;# Sentinel\r\n&quot;
<span class="lineNum">    3347 </span>            :             &quot;sentinel_masters:%lu\r\n&quot;
<span class="lineNum">    3348 </span>            :             &quot;sentinel_tilt:%d\r\n&quot;
<span class="lineNum">    3349 </span>            :             &quot;sentinel_running_scripts:%d\r\n&quot;
<span class="lineNum">    3350 </span>            :             &quot;sentinel_scripts_queue_length:%ld\r\n&quot;
<span class="lineNum">    3351 </span>            :             &quot;sentinel_simulate_failure_flags:%lu\r\n&quot;,
<span class="lineNum">    3352 </span><span class="lineNoCov">          0 :             dictSize(sentinel.masters),</span>
<span class="lineNum">    3353 </span>            :             sentinel.tilt,
<span class="lineNum">    3354 </span>            :             sentinel.running_scripts,
<span class="lineNum">    3355 </span><span class="lineNoCov">          0 :             listLength(sentinel.scripts_queue),</span>
<span class="lineNum">    3356 </span>            :             sentinel.simfailure_flags);
<span class="lineNum">    3357 </span>            : 
<span class="lineNum">    3358 </span><span class="lineNoCov">          0 :         di = dictGetIterator(sentinel.masters);</span>
<span class="lineNum">    3359 </span><span class="lineNoCov">          0 :         while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    3360 </span><span class="lineNoCov">          0 :             sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    3361 </span><span class="lineNoCov">          0 :             char *status = &quot;ok&quot;;</span>
<span class="lineNum">    3362 </span>            : 
<span class="lineNum">    3363 </span><span class="lineNoCov">          0 :             if (ri-&gt;flags &amp; SRI_O_DOWN) status = &quot;odown&quot;;</span>
<span class="lineNum">    3364 </span><span class="lineNoCov">          0 :             else if (ri-&gt;flags &amp; SRI_S_DOWN) status = &quot;sdown&quot;;</span>
<span class="lineNum">    3365 </span><span class="lineNoCov">          0 :             info = sdscatprintf(info,</span>
<span class="lineNum">    3366 </span>            :                 &quot;master%d:name=%s,status=%s,address=%s:%d,&quot;
<span class="lineNum">    3367 </span>            :                 &quot;slaves=%lu,sentinels=%lu\r\n&quot;,
<span class="lineNum">    3368 </span>            :                 master_id++, ri-&gt;name, status,
<span class="lineNum">    3369 </span><span class="lineNoCov">          0 :                 ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,</span>
<span class="lineNum">    3370 </span><span class="lineNoCov">          0 :                 dictSize(ri-&gt;slaves),</span>
<span class="lineNum">    3371 </span><span class="lineNoCov">          0 :                 dictSize(ri-&gt;sentinels)+1);</span>
<span class="lineNum">    3372 </span>            :         }
<span class="lineNum">    3373 </span><span class="lineNoCov">          0 :         dictReleaseIterator(di);</span>
<span class="lineNum">    3374 </span>            :     }
<span class="lineNum">    3375 </span>            : 
<span class="lineNum">    3376 </span><span class="lineNoCov">          0 :     addReplyBulkSds(c, info);</span>
<span class="lineNum">    3377 </span>            : }
<span class="lineNum">    3378 </span>            : 
<a name="3379"><span class="lineNum">    3379 </span>            : /* Implements Sentinel version of the ROLE command. The output is</a>
<span class="lineNum">    3380 </span>            :  * &quot;sentinel&quot; and the list of currently monitored master names. */
<span class="lineNum">    3381 </span><span class="lineNoCov">          0 : void sentinelRoleCommand(client *c) {</span>
<span class="lineNum">    3382 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    3383 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    3384 </span>            : 
<span class="lineNum">    3385 </span><span class="lineNoCov">          0 :     addReplyMultiBulkLen(c,2);</span>
<span class="lineNum">    3386 </span><span class="lineNoCov">          0 :     addReplyBulkCBuffer(c,&quot;sentinel&quot;,8);</span>
<span class="lineNum">    3387 </span><span class="lineNoCov">          0 :     addReplyMultiBulkLen(c,dictSize(sentinel.masters));</span>
<span class="lineNum">    3388 </span>            : 
<span class="lineNum">    3389 </span><span class="lineNoCov">          0 :     di = dictGetIterator(sentinel.masters);</span>
<span class="lineNum">    3390 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    3391 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    3392 </span>            : 
<span class="lineNum">    3393 </span><span class="lineNoCov">          0 :         addReplyBulkCString(c,ri-&gt;name);</span>
<span class="lineNum">    3394 </span>            :     }
<span class="lineNum">    3395 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    3396 </span><span class="lineNoCov">          0 : }</span>
<a name="3397"><span class="lineNum">    3397 </span>            : </a>
<span class="lineNum">    3398 </span>            : /* SENTINEL SET &lt;mastername&gt; [&lt;option&gt; &lt;value&gt; ...] */
<span class="lineNum">    3399 </span><span class="lineNoCov">          0 : void sentinelSetCommand(client *c) {</span>
<span class="lineNum">    3400 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri;</span>
<span class="lineNum">    3401 </span><span class="lineNoCov">          0 :     int j, changes = 0;</span>
<span class="lineNum">    3402 </span><span class="lineNoCov">          0 :     int badarg = 0; /* Bad argument position for error reporting. */</span>
<span class="lineNum">    3403 </span><span class="lineNoCov">          0 :     char *option;</span>
<span class="lineNum">    3404 </span>            : 
<span class="lineNum">    3405 </span><span class="lineNoCov">          0 :     if ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[2]))</span>
<span class="lineNum">    3406 </span>            :         == NULL) return;
<span class="lineNum">    3407 </span>            : 
<span class="lineNum">    3408 </span>            :     /* Process option - value pairs. */
<span class="lineNum">    3409 </span><span class="lineNoCov">          0 :     for (j = 3; j &lt; c-&gt;argc; j++) {</span>
<span class="lineNum">    3410 </span><span class="lineNoCov">          0 :         int moreargs = (c-&gt;argc-1) - j;</span>
<span class="lineNum">    3411 </span><span class="lineNoCov">          0 :         option = c-&gt;argv[j]-&gt;ptr;</span>
<span class="lineNum">    3412 </span><span class="lineNoCov">          0 :         long long ll;</span>
<span class="lineNum">    3413 </span><span class="lineNoCov">          0 :         int old_j = j; /* Used to know what to log as an event. */</span>
<span class="lineNum">    3414 </span>            : 
<span class="lineNum">    3415 </span><span class="lineNoCov">          0 :         if (!strcasecmp(option,&quot;down-after-milliseconds&quot;) &amp;&amp; moreargs &gt; 0) {</span>
<span class="lineNum">    3416 </span>            :             /* down-after-millisecodns &lt;milliseconds&gt; */
<span class="lineNum">    3417 </span><span class="lineNoCov">          0 :             robj *o = c-&gt;argv[++j];</span>
<span class="lineNum">    3418 </span><span class="lineNoCov">          0 :             if (getLongLongFromObject(o,&amp;ll) == C_ERR || ll &lt;= 0) {</span>
<span class="lineNum">    3419 </span><span class="lineNoCov">          0 :                 badarg = j;</span>
<span class="lineNum">    3420 </span><span class="lineNoCov">          0 :                 goto badfmt;</span>
<span class="lineNum">    3421 </span>            :             }
<span class="lineNum">    3422 </span><span class="lineNoCov">          0 :             ri-&gt;down_after_period = ll;</span>
<span class="lineNum">    3423 </span><span class="lineNoCov">          0 :             sentinelPropagateDownAfterPeriod(ri);</span>
<span class="lineNum">    3424 </span><span class="lineNoCov">          0 :             changes++;</span>
<span class="lineNum">    3425 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(option,&quot;failover-timeout&quot;) &amp;&amp; moreargs &gt; 0) {</span>
<span class="lineNum">    3426 </span>            :             /* failover-timeout &lt;milliseconds&gt; */
<span class="lineNum">    3427 </span><span class="lineNoCov">          0 :             robj *o = c-&gt;argv[++j];</span>
<span class="lineNum">    3428 </span><span class="lineNoCov">          0 :             if (getLongLongFromObject(o,&amp;ll) == C_ERR || ll &lt;= 0) {</span>
<span class="lineNum">    3429 </span><span class="lineNoCov">          0 :                 badarg = j;</span>
<span class="lineNum">    3430 </span><span class="lineNoCov">          0 :                 goto badfmt;</span>
<span class="lineNum">    3431 </span>            :             }
<span class="lineNum">    3432 </span><span class="lineNoCov">          0 :             ri-&gt;failover_timeout = ll;</span>
<span class="lineNum">    3433 </span><span class="lineNoCov">          0 :             changes++;</span>
<span class="lineNum">    3434 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(option,&quot;parallel-syncs&quot;) &amp;&amp; moreargs &gt; 0) {</span>
<span class="lineNum">    3435 </span>            :             /* parallel-syncs &lt;milliseconds&gt; */
<span class="lineNum">    3436 </span><span class="lineNoCov">          0 :             robj *o = c-&gt;argv[++j];</span>
<span class="lineNum">    3437 </span><span class="lineNoCov">          0 :             if (getLongLongFromObject(o,&amp;ll) == C_ERR || ll &lt;= 0) {</span>
<span class="lineNum">    3438 </span><span class="lineNoCov">          0 :                 badarg = j;</span>
<span class="lineNum">    3439 </span><span class="lineNoCov">          0 :                 goto badfmt;</span>
<span class="lineNum">    3440 </span>            :             }
<span class="lineNum">    3441 </span><span class="lineNoCov">          0 :             ri-&gt;parallel_syncs = ll;</span>
<span class="lineNum">    3442 </span><span class="lineNoCov">          0 :             changes++;</span>
<span class="lineNum">    3443 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(option,&quot;notification-script&quot;) &amp;&amp; moreargs &gt; 0) {</span>
<span class="lineNum">    3444 </span>            :             /* notification-script &lt;path&gt; */
<span class="lineNum">    3445 </span><span class="lineNoCov">          0 :             char *value = c-&gt;argv[++j]-&gt;ptr;</span>
<span class="lineNum">    3446 </span><span class="lineNoCov">          0 :             if (sentinel.deny_scripts_reconfig) {</span>
<span class="lineNum">    3447 </span><span class="lineNoCov">          0 :                 addReplyError(c,</span>
<span class="lineNum">    3448 </span>            :                     &quot;Reconfiguration of scripts path is denied for &quot;
<span class="lineNum">    3449 </span>            :                     &quot;security reasons. Check the deny-scripts-reconfig &quot;
<span class="lineNum">    3450 </span>            :                     &quot;configuration directive in your Sentinel configuration&quot;);
<span class="lineNum">    3451 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3452 </span>            :             }
<span class="lineNum">    3453 </span>            : 
<span class="lineNum">    3454 </span><span class="lineNoCov">          0 :             if (strlen(value) &amp;&amp; access(value,X_OK) == -1) {</span>
<span class="lineNum">    3455 </span><span class="lineNoCov">          0 :                 addReplyError(c,</span>
<span class="lineNum">    3456 </span>            :                     &quot;Notification script seems non existing or non executable&quot;);
<span class="lineNum">    3457 </span><span class="lineNoCov">          0 :                 if (changes) sentinelFlushConfig();</span>
<span class="lineNum">    3458 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3459 </span>            :             }
<span class="lineNum">    3460 </span><span class="lineNoCov">          0 :             sdsfree(ri-&gt;notification_script);</span>
<span class="lineNum">    3461 </span><span class="lineNoCov">          0 :             ri-&gt;notification_script = strlen(value) ? sdsnew(value) : NULL;</span>
<span class="lineNum">    3462 </span><span class="lineNoCov">          0 :             changes++;</span>
<span class="lineNum">    3463 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(option,&quot;client-reconfig-script&quot;) &amp;&amp; moreargs &gt; 0) {</span>
<span class="lineNum">    3464 </span>            :             /* client-reconfig-script &lt;path&gt; */
<span class="lineNum">    3465 </span><span class="lineNoCov">          0 :             char *value = c-&gt;argv[++j]-&gt;ptr;</span>
<span class="lineNum">    3466 </span><span class="lineNoCov">          0 :             if (sentinel.deny_scripts_reconfig) {</span>
<span class="lineNum">    3467 </span><span class="lineNoCov">          0 :                 addReplyError(c,</span>
<span class="lineNum">    3468 </span>            :                     &quot;Reconfiguration of scripts path is denied for &quot;
<span class="lineNum">    3469 </span>            :                     &quot;security reasons. Check the deny-scripts-reconfig &quot;
<span class="lineNum">    3470 </span>            :                     &quot;configuration directive in your Sentinel configuration&quot;);
<span class="lineNum">    3471 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3472 </span>            :             }
<span class="lineNum">    3473 </span>            : 
<span class="lineNum">    3474 </span><span class="lineNoCov">          0 :             if (strlen(value) &amp;&amp; access(value,X_OK) == -1) {</span>
<span class="lineNum">    3475 </span><span class="lineNoCov">          0 :                 addReplyError(c,</span>
<span class="lineNum">    3476 </span>            :                     &quot;Client reconfiguration script seems non existing or &quot;
<span class="lineNum">    3477 </span>            :                     &quot;non executable&quot;);
<span class="lineNum">    3478 </span><span class="lineNoCov">          0 :                 if (changes) sentinelFlushConfig();</span>
<span class="lineNum">    3479 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3480 </span>            :             }
<span class="lineNum">    3481 </span><span class="lineNoCov">          0 :             sdsfree(ri-&gt;client_reconfig_script);</span>
<span class="lineNum">    3482 </span><span class="lineNoCov">          0 :             ri-&gt;client_reconfig_script = strlen(value) ? sdsnew(value) : NULL;</span>
<span class="lineNum">    3483 </span><span class="lineNoCov">          0 :             changes++;</span>
<span class="lineNum">    3484 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(option,&quot;auth-pass&quot;) &amp;&amp; moreargs &gt; 0) {</span>
<span class="lineNum">    3485 </span>            :             /* auth-pass &lt;password&gt; */
<span class="lineNum">    3486 </span><span class="lineNoCov">          0 :             char *value = c-&gt;argv[++j]-&gt;ptr;</span>
<span class="lineNum">    3487 </span><span class="lineNoCov">          0 :             sdsfree(ri-&gt;auth_pass);</span>
<span class="lineNum">    3488 </span><span class="lineNoCov">          0 :             ri-&gt;auth_pass = strlen(value) ? sdsnew(value) : NULL;</span>
<span class="lineNum">    3489 </span><span class="lineNoCov">          0 :             changes++;</span>
<span class="lineNum">    3490 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(option,&quot;quorum&quot;) &amp;&amp; moreargs &gt; 0) {</span>
<span class="lineNum">    3491 </span>            :             /* quorum &lt;count&gt; */
<span class="lineNum">    3492 </span><span class="lineNoCov">          0 :             robj *o = c-&gt;argv[++j];</span>
<span class="lineNum">    3493 </span><span class="lineNoCov">          0 :             if (getLongLongFromObject(o,&amp;ll) == C_ERR || ll &lt;= 0) {</span>
<span class="lineNum">    3494 </span><span class="lineNoCov">          0 :                 badarg = j;</span>
<span class="lineNum">    3495 </span><span class="lineNoCov">          0 :                 goto badfmt;</span>
<span class="lineNum">    3496 </span>            :             }
<span class="lineNum">    3497 </span><span class="lineNoCov">          0 :             ri-&gt;quorum = ll;</span>
<span class="lineNum">    3498 </span><span class="lineNoCov">          0 :             changes++;</span>
<span class="lineNum">    3499 </span><span class="lineNoCov">          0 :         } else if (!strcasecmp(option,&quot;rename-command&quot;) &amp;&amp; moreargs &gt; 1) {</span>
<span class="lineNum">    3500 </span>            :             /* rename-command &lt;oldname&gt; &lt;newname&gt; */
<span class="lineNum">    3501 </span><span class="lineNoCov">          0 :             sds oldname = c-&gt;argv[++j]-&gt;ptr;</span>
<span class="lineNum">    3502 </span><span class="lineNoCov">          0 :             sds newname = c-&gt;argv[++j]-&gt;ptr;</span>
<span class="lineNum">    3503 </span>            : 
<span class="lineNum">    3504 </span><span class="lineNoCov">          0 :             if ((sdslen(oldname) == 0) || (sdslen(newname) == 0)) {</span>
<span class="lineNum">    3505 </span><span class="lineNoCov">          0 :                 badarg = sdslen(newname) ? j-1 : j;</span>
<span class="lineNum">    3506 </span><span class="lineNoCov">          0 :                 goto badfmt;</span>
<span class="lineNum">    3507 </span>            :             }
<span class="lineNum">    3508 </span>            : 
<span class="lineNum">    3509 </span>            :             /* Remove any older renaming for this command. */
<span class="lineNum">    3510 </span><span class="lineNoCov">          0 :             dictDelete(ri-&gt;renamed_commands,oldname);</span>
<span class="lineNum">    3511 </span>            : 
<span class="lineNum">    3512 </span>            :             /* If the target name is the same as the source name there
<span class="lineNum">    3513 </span>            :              * is no need to add an entry mapping to itself. */
<span class="lineNum">    3514 </span><span class="lineNoCov">          0 :             if (!dictSdsKeyCaseCompare(NULL,oldname,newname)) {</span>
<span class="lineNum">    3515 </span><span class="lineNoCov">          0 :                 oldname = sdsdup(oldname);</span>
<span class="lineNum">    3516 </span><span class="lineNoCov">          0 :                 newname = sdsdup(newname);</span>
<span class="lineNum">    3517 </span><span class="lineNoCov">          0 :                 dictAdd(ri-&gt;renamed_commands,oldname,newname);</span>
<span class="lineNum">    3518 </span>            :             }
<span class="lineNum">    3519 </span><span class="lineNoCov">          0 :             changes++;</span>
<span class="lineNum">    3520 </span>            :         } else {
<span class="lineNum">    3521 </span><span class="lineNoCov">          0 :             addReplyErrorFormat(c,&quot;Unknown option or number of arguments for &quot;</span>
<span class="lineNum">    3522 </span>            :                                   &quot;SENTINEL SET '%s'&quot;, option);
<span class="lineNum">    3523 </span><span class="lineNoCov">          0 :             if (changes) sentinelFlushConfig();</span>
<span class="lineNum">    3524 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    3525 </span>            :         }
<span class="lineNum">    3526 </span>            : 
<span class="lineNum">    3527 </span>            :         /* Log the event. */
<span class="lineNum">    3528 </span><span class="lineNoCov">          0 :         int numargs = j-old_j+1;</span>
<span class="lineNum">    3529 </span><span class="lineNoCov">          0 :         switch(numargs) {</span>
<span class="lineNum">    3530 </span><span class="lineNoCov">          0 :         case 2:</span>
<span class="lineNum">    3531 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;+set&quot;,ri,&quot;%@ %s %s&quot;,c-&gt;argv[old_j]-&gt;ptr,</span>
<span class="lineNum">    3532 </span><span class="lineNoCov">          0 :                                                           c-&gt;argv[old_j+1]-&gt;ptr);</span>
<span class="lineNum">    3533 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    3534 </span><span class="lineNoCov">          0 :         case 3:</span>
<span class="lineNum">    3535 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;+set&quot;,ri,&quot;%@ %s %s %s&quot;,c-&gt;argv[old_j]-&gt;ptr,</span>
<span class="lineNum">    3536 </span><span class="lineNoCov">          0 :                                                              c-&gt;argv[old_j+1]-&gt;ptr,</span>
<span class="lineNum">    3537 </span><span class="lineNoCov">          0 :                                                              c-&gt;argv[old_j+2]-&gt;ptr);</span>
<span class="lineNum">    3538 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    3539 </span><span class="lineNoCov">          0 :         default:</span>
<span class="lineNum">    3540 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;+set&quot;,ri,&quot;%@ %s&quot;,c-&gt;argv[old_j]-&gt;ptr);</span>
<span class="lineNum">    3541 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    3542 </span>            :         }
<span class="lineNum">    3543 </span>            :     }
<span class="lineNum">    3544 </span>            : 
<span class="lineNum">    3545 </span><span class="lineNoCov">          0 :     if (changes) sentinelFlushConfig();</span>
<span class="lineNum">    3546 </span><span class="lineNoCov">          0 :     addReply(c,shared.ok);</span>
<span class="lineNum">    3547 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    3548 </span>            : 
<span class="lineNum">    3549 </span><span class="lineNoCov">          0 : badfmt: /* Bad format errors */</span>
<span class="lineNum">    3550 </span><span class="lineNoCov">          0 :     if (changes) sentinelFlushConfig();</span>
<span class="lineNum">    3551 </span><span class="lineNoCov">          0 :     addReplyErrorFormat(c,&quot;Invalid argument '%s' for SENTINEL SET '%s'&quot;,</span>
<span class="lineNum">    3552 </span><span class="lineNoCov">          0 :         (char*)c-&gt;argv[badarg]-&gt;ptr,option);</span>
<span class="lineNum">    3553 </span>            : }
<span class="lineNum">    3554 </span>            : 
<span class="lineNum">    3555 </span>            : /* Our fake PUBLISH command: it is actually useful only to receive hello messages
<span class="lineNum">    3556 </span>            :  * from the other sentinel instances, and publishing to a channel other than
<span class="lineNum">    3557 </span>            :  * SENTINEL_HELLO_CHANNEL is forbidden.
<span class="lineNum">    3558 </span>            :  *
<a name="3559"><span class="lineNum">    3559 </span>            :  * Because we have a Sentinel PUBLISH, the code to send hello messages is the same</a>
<span class="lineNum">    3560 </span>            :  * for all the three kind of instances: masters, slaves, sentinels. */
<span class="lineNum">    3561 </span><span class="lineNoCov">          0 : void sentinelPublishCommand(client *c) {</span>
<span class="lineNum">    3562 </span><span class="lineNoCov">          0 :     if (strcmp(c-&gt;argv[1]-&gt;ptr,SENTINEL_HELLO_CHANNEL)) {</span>
<span class="lineNum">    3563 </span><span class="lineNoCov">          0 :         addReplyError(c, &quot;Only HELLO messages are accepted by Sentinel instances.&quot;);</span>
<span class="lineNum">    3564 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    3565 </span>            :     }
<span class="lineNum">    3566 </span><span class="lineNoCov">          0 :     sentinelProcessHelloMessage(c-&gt;argv[2]-&gt;ptr,sdslen(c-&gt;argv[2]-&gt;ptr));</span>
<span class="lineNum">    3567 </span><span class="lineNoCov">          0 :     addReplyLongLong(c,1);</span>
<span class="lineNum">    3568 </span>            : }
<span class="lineNum">    3569 </span>            : 
<span class="lineNum">    3570 </span>            : /* ===================== SENTINEL availability checks ======================= */
<a name="3571"><span class="lineNum">    3571 </span>            : </a>
<span class="lineNum">    3572 </span>            : /* Is this instance down from our point of view? */
<span class="lineNum">    3573 </span><span class="lineNoCov">          0 : void sentinelCheckSubjectivelyDown(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    3574 </span><span class="lineNoCov">          0 :     mstime_t elapsed = 0;</span>
<span class="lineNum">    3575 </span>            : 
<span class="lineNum">    3576 </span><span class="lineNoCov">          0 :     if (ri-&gt;link-&gt;act_ping_time)</span>
<span class="lineNum">    3577 </span><span class="lineNoCov">          0 :         elapsed = mstime() - ri-&gt;link-&gt;act_ping_time;</span>
<span class="lineNum">    3578 </span><span class="lineNoCov">          0 :     else if (ri-&gt;link-&gt;disconnected)</span>
<span class="lineNum">    3579 </span><span class="lineNoCov">          0 :         elapsed = mstime() - ri-&gt;link-&gt;last_avail_time;</span>
<span class="lineNum">    3580 </span>            : 
<span class="lineNum">    3581 </span>            :     /* Check if we are in need for a reconnection of one of the
<span class="lineNum">    3582 </span>            :      * links, because we are detecting low activity.
<span class="lineNum">    3583 </span>            :      *
<span class="lineNum">    3584 </span>            :      * 1) Check if the command link seems connected, was connected not less
<span class="lineNum">    3585 </span>            :      *    than SENTINEL_MIN_LINK_RECONNECT_PERIOD, but still we have a
<span class="lineNum">    3586 </span>            :      *    pending ping for more than half the timeout. */
<span class="lineNum">    3587 </span><span class="lineNoCov">          0 :     if (ri-&gt;link-&gt;cc &amp;&amp;</span>
<span class="lineNum">    3588 </span><span class="lineNoCov">          0 :         (mstime() - ri-&gt;link-&gt;cc_conn_time) &gt;</span>
<span class="lineNum">    3589 </span><span class="lineNoCov">          0 :         SENTINEL_MIN_LINK_RECONNECT_PERIOD &amp;&amp;</span>
<span class="lineNum">    3590 </span><span class="lineNoCov">          0 :         ri-&gt;link-&gt;act_ping_time != 0 &amp;&amp; /* There is a pending ping... */</span>
<span class="lineNum">    3591 </span>            :         /* The pending ping is delayed, and we did not receive
<span class="lineNum">    3592 </span>            :          * error replies as well. */
<span class="lineNum">    3593 </span><span class="lineNoCov">          0 :         (mstime() - ri-&gt;link-&gt;act_ping_time) &gt; (ri-&gt;down_after_period/2) &amp;&amp;</span>
<span class="lineNum">    3594 </span><span class="lineNoCov">          0 :         (mstime() - ri-&gt;link-&gt;last_pong_time) &gt; (ri-&gt;down_after_period/2))</span>
<span class="lineNum">    3595 </span>            :     {
<span class="lineNum">    3596 </span><span class="lineNoCov">          0 :         instanceLinkCloseConnection(ri-&gt;link,ri-&gt;link-&gt;cc);</span>
<span class="lineNum">    3597 </span>            :     }
<span class="lineNum">    3598 </span>            : 
<span class="lineNum">    3599 </span>            :     /* 2) Check if the pubsub link seems connected, was connected not less
<span class="lineNum">    3600 </span>            :      *    than SENTINEL_MIN_LINK_RECONNECT_PERIOD, but still we have no
<span class="lineNum">    3601 </span>            :      *    activity in the Pub/Sub channel for more than
<span class="lineNum">    3602 </span>            :      *    SENTINEL_PUBLISH_PERIOD * 3.
<span class="lineNum">    3603 </span>            :      */
<span class="lineNum">    3604 </span><span class="lineNoCov">          0 :     if (ri-&gt;link-&gt;pc &amp;&amp;</span>
<span class="lineNum">    3605 </span><span class="lineNoCov">          0 :         (mstime() - ri-&gt;link-&gt;pc_conn_time) &gt;</span>
<span class="lineNum">    3606 </span><span class="lineNoCov">          0 :          SENTINEL_MIN_LINK_RECONNECT_PERIOD &amp;&amp;</span>
<span class="lineNum">    3607 </span><span class="lineNoCov">          0 :         (mstime() - ri-&gt;link-&gt;pc_last_activity) &gt; (SENTINEL_PUBLISH_PERIOD*3))</span>
<span class="lineNum">    3608 </span>            :     {
<span class="lineNum">    3609 </span><span class="lineNoCov">          0 :         instanceLinkCloseConnection(ri-&gt;link,ri-&gt;link-&gt;pc);</span>
<span class="lineNum">    3610 </span>            :     }
<span class="lineNum">    3611 </span>            : 
<span class="lineNum">    3612 </span>            :     /* Update the SDOWN flag. We believe the instance is SDOWN if:
<span class="lineNum">    3613 </span>            :      *
<span class="lineNum">    3614 </span>            :      * 1) It is not replying.
<span class="lineNum">    3615 </span>            :      * 2) We believe it is a master, it reports to be a slave for enough time
<span class="lineNum">    3616 </span>            :      *    to meet the down_after_period, plus enough time to get two times
<span class="lineNum">    3617 </span>            :      *    INFO report from the instance. */
<span class="lineNum">    3618 </span><span class="lineNoCov">          0 :     if (elapsed &gt; ri-&gt;down_after_period ||</span>
<span class="lineNum">    3619 </span><span class="lineNoCov">          0 :         (ri-&gt;flags &amp; SRI_MASTER &amp;&amp;</span>
<span class="lineNum">    3620 </span><span class="lineNoCov">          0 :          ri-&gt;role_reported == SRI_SLAVE &amp;&amp;</span>
<span class="lineNum">    3621 </span><span class="lineNoCov">          0 :          mstime() - ri-&gt;role_reported_time &gt;</span>
<span class="lineNum">    3622 </span><span class="lineNoCov">          0 :           (ri-&gt;down_after_period+SENTINEL_INFO_PERIOD*2)))</span>
<span class="lineNum">    3623 </span>            :     {
<span class="lineNum">    3624 </span>            :         /* Is subjectively down */
<span class="lineNum">    3625 </span><span class="lineNoCov">          0 :         if ((ri-&gt;flags &amp; SRI_S_DOWN) == 0) {</span>
<span class="lineNum">    3626 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;+sdown&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    3627 </span><span class="lineNoCov">          0 :             ri-&gt;s_down_since_time = mstime();</span>
<span class="lineNum">    3628 </span><span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_S_DOWN;</span>
<span class="lineNum">    3629 </span>            :         }
<span class="lineNum">    3630 </span>            :     } else {
<span class="lineNum">    3631 </span>            :         /* Is subjectively up */
<span class="lineNum">    3632 </span><span class="lineNoCov">          0 :         if (ri-&gt;flags &amp; SRI_S_DOWN) {</span>
<span class="lineNum">    3633 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;-sdown&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    3634 </span><span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~(SRI_S_DOWN|SRI_SCRIPT_KILL_SENT);</span>
<span class="lineNum">    3635 </span>            :         }
<span class="lineNum">    3636 </span>            :     }
<span class="lineNum">    3637 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3638 </span>            : 
<span class="lineNum">    3639 </span>            : /* Is this instance down according to the configured quorum?
<span class="lineNum">    3640 </span>            :  *
<span class="lineNum">    3641 </span>            :  * Note that ODOWN is a weak quorum, it only means that enough Sentinels
<span class="lineNum">    3642 </span>            :  * reported in a given time range that the instance was not reachable.
<a name="3643"><span class="lineNum">    3643 </span>            :  * However messages can be delayed so there are no strong guarantees about</a>
<span class="lineNum">    3644 </span>            :  * N instances agreeing at the same time about the down state. */
<span class="lineNum">    3645 </span><span class="lineNoCov">          0 : void sentinelCheckObjectivelyDown(sentinelRedisInstance *master) {</span>
<span class="lineNum">    3646 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    3647 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    3648 </span><span class="lineNoCov">          0 :     unsigned int quorum = 0, odown = 0;</span>
<span class="lineNum">    3649 </span>            : 
<span class="lineNum">    3650 </span><span class="lineNoCov">          0 :     if (master-&gt;flags &amp; SRI_S_DOWN) {</span>
<span class="lineNum">    3651 </span>            :         /* Is down for enough sentinels? */
<span class="lineNum">    3652 </span><span class="lineNoCov">          0 :         quorum = 1; /* the current sentinel. */</span>
<span class="lineNum">    3653 </span>            :         /* Count all the other sentinels. */
<span class="lineNum">    3654 </span><span class="lineNoCov">          0 :         di = dictGetIterator(master-&gt;sentinels);</span>
<span class="lineNum">    3655 </span><span class="lineNoCov">          0 :         while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    3656 </span><span class="lineNoCov">          0 :             sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    3657 </span>            : 
<span class="lineNum">    3658 </span><span class="lineNoCov">          0 :             if (ri-&gt;flags &amp; SRI_MASTER_DOWN) quorum++;</span>
<span class="lineNum">    3659 </span>            :         }
<span class="lineNum">    3660 </span><span class="lineNoCov">          0 :         dictReleaseIterator(di);</span>
<span class="lineNum">    3661 </span><span class="lineNoCov">          0 :         if (quorum &gt;= master-&gt;quorum) odown = 1;</span>
<span class="lineNum">    3662 </span>            :     }
<span class="lineNum">    3663 </span>            : 
<span class="lineNum">    3664 </span>            :     /* Set the flag accordingly to the outcome. */
<span class="lineNum">    3665 </span><span class="lineNoCov">          0 :     if (odown) {</span>
<span class="lineNum">    3666 </span><span class="lineNoCov">          0 :         if ((master-&gt;flags &amp; SRI_O_DOWN) == 0) {</span>
<span class="lineNum">    3667 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;+odown&quot;,master,&quot;%@ #quorum %d/%d&quot;,</span>
<span class="lineNum">    3668 </span>            :                 quorum, master-&gt;quorum);
<span class="lineNum">    3669 </span><span class="lineNoCov">          0 :             master-&gt;flags |= SRI_O_DOWN;</span>
<span class="lineNum">    3670 </span><span class="lineNoCov">          0 :             master-&gt;o_down_since_time = mstime();</span>
<span class="lineNum">    3671 </span>            :         }
<span class="lineNum">    3672 </span>            :     } else {
<span class="lineNum">    3673 </span><span class="lineNoCov">          0 :         if (master-&gt;flags &amp; SRI_O_DOWN) {</span>
<span class="lineNum">    3674 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;-odown&quot;,master,&quot;%@&quot;);</span>
<span class="lineNum">    3675 </span><span class="lineNoCov">          0 :             master-&gt;flags &amp;= ~SRI_O_DOWN;</span>
<span class="lineNum">    3676 </span>            :         }
<span class="lineNum">    3677 </span>            :     }
<span class="lineNum">    3678 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3679 </span>            : 
<a name="3680"><span class="lineNum">    3680 </span>            : /* Receive the SENTINEL is-master-down-by-addr reply, see the</a>
<span class="lineNum">    3681 </span>            :  * sentinelAskMasterStateToOtherSentinels() function for more information. */
<span class="lineNum">    3682 </span><span class="lineNoCov">          0 : void sentinelReceiveIsMasterDownReply(redisAsyncContext *c, void *reply, void *privdata) {</span>
<span class="lineNum">    3683 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ri = privdata;</span>
<span class="lineNum">    3684 </span><span class="lineNoCov">          0 :     instanceLink *link = c-&gt;data;</span>
<span class="lineNum">    3685 </span><span class="lineNoCov">          0 :     redisReply *r;</span>
<span class="lineNum">    3686 </span>            : 
<span class="lineNum">    3687 </span><span class="lineNoCov">          0 :     if (!reply || !link) return;</span>
<span class="lineNum">    3688 </span><span class="lineNoCov">          0 :     link-&gt;pending_commands--;</span>
<span class="lineNum">    3689 </span><span class="lineNoCov">          0 :     r = reply;</span>
<span class="lineNum">    3690 </span>            : 
<span class="lineNum">    3691 </span>            :     /* Ignore every error or unexpected reply.
<span class="lineNum">    3692 </span>            :      * Note that if the command returns an error for any reason we'll
<span class="lineNum">    3693 </span>            :      * end clearing the SRI_MASTER_DOWN flag for timeout anyway. */
<span class="lineNum">    3694 </span><span class="lineNoCov">          0 :     if (r-&gt;type == REDIS_REPLY_ARRAY &amp;&amp; r-&gt;elements == 3 &amp;&amp;</span>
<span class="lineNum">    3695 </span><span class="lineNoCov">          0 :         r-&gt;element[0]-&gt;type == REDIS_REPLY_INTEGER &amp;&amp;</span>
<span class="lineNum">    3696 </span><span class="lineNoCov">          0 :         r-&gt;element[1]-&gt;type == REDIS_REPLY_STRING &amp;&amp;</span>
<span class="lineNum">    3697 </span><span class="lineNoCov">          0 :         r-&gt;element[2]-&gt;type == REDIS_REPLY_INTEGER)</span>
<span class="lineNum">    3698 </span>            :     {
<span class="lineNum">    3699 </span><span class="lineNoCov">          0 :         ri-&gt;last_master_down_reply_time = mstime();</span>
<span class="lineNum">    3700 </span><span class="lineNoCov">          0 :         if (r-&gt;element[0]-&gt;integer == 1) {</span>
<span class="lineNum">    3701 </span><span class="lineNoCov">          0 :             ri-&gt;flags |= SRI_MASTER_DOWN;</span>
<span class="lineNum">    3702 </span>            :         } else {
<span class="lineNum">    3703 </span><span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_MASTER_DOWN;</span>
<span class="lineNum">    3704 </span>            :         }
<span class="lineNum">    3705 </span><span class="lineNoCov">          0 :         if (strcmp(r-&gt;element[1]-&gt;str,&quot;*&quot;)) {</span>
<span class="lineNum">    3706 </span>            :             /* If the runid in the reply is not &quot;*&quot; the Sentinel actually
<span class="lineNum">    3707 </span>            :              * replied with a vote. */
<span class="lineNum">    3708 </span><span class="lineNoCov">          0 :             sdsfree(ri-&gt;leader);</span>
<span class="lineNum">    3709 </span><span class="lineNoCov">          0 :             if ((long long)ri-&gt;leader_epoch != r-&gt;element[2]-&gt;integer)</span>
<span class="lineNum">    3710 </span><span class="lineNoCov">          0 :                 serverLog(LL_WARNING,</span>
<span class="lineNum">    3711 </span>            :                     &quot;%s voted for %s %llu&quot;, ri-&gt;name,
<span class="lineNum">    3712 </span><span class="lineNoCov">          0 :                     r-&gt;element[1]-&gt;str,</span>
<span class="lineNum">    3713 </span>            :                     (unsigned long long) r-&gt;element[2]-&gt;integer);
<span class="lineNum">    3714 </span><span class="lineNoCov">          0 :             ri-&gt;leader = sdsnew(r-&gt;element[1]-&gt;str);</span>
<span class="lineNum">    3715 </span><span class="lineNoCov">          0 :             ri-&gt;leader_epoch = r-&gt;element[2]-&gt;integer;</span>
<span class="lineNum">    3716 </span>            :         }
<span class="lineNum">    3717 </span>            :     }
<span class="lineNum">    3718 </span>            : }
<span class="lineNum">    3719 </span>            : 
<span class="lineNum">    3720 </span>            : /* If we think the master is down, we start sending
<span class="lineNum">    3721 </span>            :  * SENTINEL IS-MASTER-DOWN-BY-ADDR requests to other sentinels
<span class="lineNum">    3722 </span>            :  * in order to get the replies that allow to reach the quorum
<a name="3723"><span class="lineNum">    3723 </span>            :  * needed to mark the master in ODOWN state and trigger a failover. */</a>
<span class="lineNum">    3724 </span>            : #define SENTINEL_ASK_FORCED (1&lt;&lt;0)
<span class="lineNum">    3725 </span><span class="lineNoCov">          0 : void sentinelAskMasterStateToOtherSentinels(sentinelRedisInstance *master, int flags) {</span>
<span class="lineNum">    3726 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    3727 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    3728 </span>            : 
<span class="lineNum">    3729 </span><span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;sentinels);</span>
<span class="lineNum">    3730 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    3731 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    3732 </span><span class="lineNoCov">          0 :         mstime_t elapsed = mstime() - ri-&gt;last_master_down_reply_time;</span>
<span class="lineNum">    3733 </span><span class="lineNoCov">          0 :         char port[32];</span>
<span class="lineNum">    3734 </span><span class="lineNoCov">          0 :         int retval;</span>
<span class="lineNum">    3735 </span>            : 
<span class="lineNum">    3736 </span>            :         /* If the master state from other sentinel is too old, we clear it. */
<span class="lineNum">    3737 </span><span class="lineNoCov">          0 :         if (elapsed &gt; SENTINEL_ASK_PERIOD*5) {</span>
<span class="lineNum">    3738 </span><span class="lineNoCov">          0 :             ri-&gt;flags &amp;= ~SRI_MASTER_DOWN;</span>
<span class="lineNum">    3739 </span><span class="lineNoCov">          0 :             sdsfree(ri-&gt;leader);</span>
<span class="lineNum">    3740 </span><span class="lineNoCov">          0 :             ri-&gt;leader = NULL;</span>
<span class="lineNum">    3741 </span>            :         }
<span class="lineNum">    3742 </span>            : 
<span class="lineNum">    3743 </span>            :         /* Only ask if master is down to other sentinels if:
<span class="lineNum">    3744 </span>            :          *
<span class="lineNum">    3745 </span>            :          * 1) We believe it is down, or there is a failover in progress.
<span class="lineNum">    3746 </span>            :          * 2) Sentinel is connected.
<span class="lineNum">    3747 </span>            :          * 3) We did not receive the info within SENTINEL_ASK_PERIOD ms. */
<span class="lineNum">    3748 </span><span class="lineNoCov">          0 :         if ((master-&gt;flags &amp; SRI_S_DOWN) == 0) continue;</span>
<span class="lineNum">    3749 </span><span class="lineNoCov">          0 :         if (ri-&gt;link-&gt;disconnected) continue;</span>
<span class="lineNum">    3750 </span><span class="lineNoCov">          0 :         if (!(flags &amp; SENTINEL_ASK_FORCED) &amp;&amp;</span>
<span class="lineNum">    3751 </span><span class="lineNoCov">          0 :             mstime() - ri-&gt;last_master_down_reply_time &lt; SENTINEL_ASK_PERIOD)</span>
<span class="lineNum">    3752 </span>            :             continue;
<span class="lineNum">    3753 </span>            : 
<span class="lineNum">    3754 </span>            :         /* Ask */
<span class="lineNum">    3755 </span><span class="lineNoCov">          0 :         ll2string(port,sizeof(port),master-&gt;addr-&gt;port);</span>
<span class="lineNum">    3756 </span><span class="lineNoCov">          0 :         retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    3757 </span>            :                     sentinelReceiveIsMasterDownReply, ri,
<span class="lineNum">    3758 </span>            :                     &quot;%s is-master-down-by-addr %s %s %llu %s&quot;,
<span class="lineNum">    3759 </span>            :                     sentinelInstanceMapCommand(ri,&quot;SENTINEL&quot;),
<span class="lineNum">    3760 </span><span class="lineNoCov">          0 :                     master-&gt;addr-&gt;ip, port,</span>
<span class="lineNum">    3761 </span>            :                     sentinel.current_epoch,
<span class="lineNum">    3762 </span><span class="lineNoCov">          0 :                     (master-&gt;failover_state &gt; SENTINEL_FAILOVER_STATE_NONE) ?</span>
<span class="lineNum">    3763 </span>            :                     sentinel.myid : &quot;*&quot;);
<span class="lineNum">    3764 </span><span class="lineNoCov">          0 :         if (retval == C_OK) ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    3765 </span>            :     }
<span class="lineNum">    3766 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    3767 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3768 </span>            : 
<span class="lineNum">    3769 </span>            : /* =============================== FAILOVER ================================= */
<a name="3770"><span class="lineNum">    3770 </span>            : </a>
<span class="lineNum">    3771 </span>            : /* Crash because of user request via SENTINEL simulate-failure command. */
<span class="lineNum">    3772 </span><span class="lineNoCov">          0 : void sentinelSimFailureCrash(void) {</span>
<span class="lineNum">    3773 </span><span class="lineNoCov">          0 :     serverLog(LL_WARNING,</span>
<span class="lineNum">    3774 </span>            :         &quot;Sentinel CRASH because of SENTINEL simulate-failure&quot;);
<span class="lineNum">    3775 </span><span class="lineNoCov">          0 :     exit(99);</span>
<span class="lineNum">    3776 </span>            : }
<span class="lineNum">    3777 </span>            : 
<span class="lineNum">    3778 </span>            : /* Vote for the sentinel with 'req_runid' or return the old vote if already
<span class="lineNum">    3779 </span>            :  * voted for the specified 'req_epoch' or one greater.
<span class="lineNum">    3780 </span>            :  *
<a name="3781"><span class="lineNum">    3781 </span>            :  * If a vote is not available returns NULL, otherwise return the Sentinel</a>
<span class="lineNum">    3782 </span>            :  * runid and populate the leader_epoch with the epoch of the vote. */
<span class="lineNum">    3783 </span><span class="lineNoCov">          0 : char *sentinelVoteLeader(sentinelRedisInstance *master, uint64_t req_epoch, char *req_runid, uint64_t *leader_epoch) {</span>
<span class="lineNum">    3784 </span><span class="lineNoCov">          0 :     if (req_epoch &gt; sentinel.current_epoch) {</span>
<span class="lineNum">    3785 </span><span class="lineNoCov">          0 :         sentinel.current_epoch = req_epoch;</span>
<span class="lineNum">    3786 </span><span class="lineNoCov">          0 :         sentinelFlushConfig();</span>
<span class="lineNum">    3787 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;+new-epoch&quot;,master,&quot;%llu&quot;,</span>
<span class="lineNum">    3788 </span><span class="lineNoCov">          0 :             (unsigned long long) sentinel.current_epoch);</span>
<span class="lineNum">    3789 </span>            :     }
<span class="lineNum">    3790 </span>            : 
<span class="lineNum">    3791 </span><span class="lineNoCov">          0 :     if (master-&gt;leader_epoch &lt; req_epoch &amp;&amp; sentinel.current_epoch &lt;= req_epoch)</span>
<span class="lineNum">    3792 </span>            :     {
<span class="lineNum">    3793 </span><span class="lineNoCov">          0 :         sdsfree(master-&gt;leader);</span>
<span class="lineNum">    3794 </span><span class="lineNoCov">          0 :         master-&gt;leader = sdsnew(req_runid);</span>
<span class="lineNum">    3795 </span><span class="lineNoCov">          0 :         master-&gt;leader_epoch = sentinel.current_epoch;</span>
<span class="lineNum">    3796 </span><span class="lineNoCov">          0 :         sentinelFlushConfig();</span>
<span class="lineNum">    3797 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;+vote-for-leader&quot;,master,&quot;%s %llu&quot;,</span>
<span class="lineNum">    3798 </span><span class="lineNoCov">          0 :             master-&gt;leader, (unsigned long long) master-&gt;leader_epoch);</span>
<span class="lineNum">    3799 </span>            :         /* If we did not voted for ourselves, set the master failover start
<span class="lineNum">    3800 </span>            :          * time to now, in order to force a delay before we can start a
<span class="lineNum">    3801 </span>            :          * failover for the same master. */
<span class="lineNum">    3802 </span><span class="lineNoCov">          0 :         if (strcasecmp(master-&gt;leader,sentinel.myid))</span>
<span class="lineNum">    3803 </span><span class="lineNoCov">          0 :             master-&gt;failover_start_time = mstime()+rand()%SENTINEL_MAX_DESYNC;</span>
<span class="lineNum">    3804 </span>            :     }
<span class="lineNum">    3805 </span>            : 
<span class="lineNum">    3806 </span><span class="lineNoCov">          0 :     *leader_epoch = master-&gt;leader_epoch;</span>
<span class="lineNum">    3807 </span><span class="lineNoCov">          0 :     return master-&gt;leader ? sdsnew(master-&gt;leader) : NULL;</span>
<span class="lineNum">    3808 </span>            : }
<span class="lineNum">    3809 </span>            : 
<span class="lineNum">    3810 </span>            : struct sentinelLeader {
<span class="lineNum">    3811 </span>            :     char *runid;
<span class="lineNum">    3812 </span>            :     unsigned long votes;
<span class="lineNum">    3813 </span>            : };
<span class="lineNum">    3814 </span>            : 
<a name="3815"><span class="lineNum">    3815 </span>            : /* Helper function for sentinelGetLeader, increment the counter</a>
<span class="lineNum">    3816 </span>            :  * relative to the specified runid. */
<span class="lineNum">    3817 </span><span class="lineNoCov">          0 : int sentinelLeaderIncr(dict *counters, char *runid) {</span>
<span class="lineNum">    3818 </span><span class="lineNoCov">          0 :     dictEntry *existing, *de;</span>
<span class="lineNum">    3819 </span><span class="lineNoCov">          0 :     uint64_t oldval;</span>
<span class="lineNum">    3820 </span>            : 
<span class="lineNum">    3821 </span><span class="lineNoCov">          0 :     de = dictAddRaw(counters,runid,&amp;existing);</span>
<span class="lineNum">    3822 </span><span class="lineNoCov">          0 :     if (existing) {</span>
<span class="lineNum">    3823 </span><span class="lineNoCov">          0 :         oldval = dictGetUnsignedIntegerVal(existing);</span>
<span class="lineNum">    3824 </span><span class="lineNoCov">          0 :         dictSetUnsignedIntegerVal(existing,oldval+1);</span>
<span class="lineNum">    3825 </span><span class="lineNoCov">          0 :         return oldval+1;</span>
<span class="lineNum">    3826 </span>            :     } else {
<span class="lineNum">    3827 </span><span class="lineNoCov">          0 :         serverAssert(de != NULL);</span>
<span class="lineNum">    3828 </span><span class="lineNoCov">          0 :         dictSetUnsignedIntegerVal(de,1);</span>
<span class="lineNum">    3829 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">    3830 </span>            :     }
<span class="lineNum">    3831 </span>            : }
<span class="lineNum">    3832 </span>            : 
<span class="lineNum">    3833 </span>            : /* Scan all the Sentinels attached to this master to check if there
<span class="lineNum">    3834 </span>            :  * is a leader for the specified epoch.
<span class="lineNum">    3835 </span>            :  *
<span class="lineNum">    3836 </span>            :  * To be a leader for a given epoch, we should have the majority of
<a name="3837"><span class="lineNum">    3837 </span>            :  * the Sentinels we know (ever seen since the last SENTINEL RESET) that</a>
<span class="lineNum">    3838 </span>            :  * reported the same instance as leader for the same epoch. */
<span class="lineNum">    3839 </span><span class="lineNoCov">          0 : char *sentinelGetLeader(sentinelRedisInstance *master, uint64_t epoch) {</span>
<span class="lineNum">    3840 </span><span class="lineNoCov">          0 :     dict *counters;</span>
<span class="lineNum">    3841 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    3842 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    3843 </span><span class="lineNoCov">          0 :     unsigned int voters = 0, voters_quorum;</span>
<span class="lineNum">    3844 </span><span class="lineNoCov">          0 :     char *myvote;</span>
<span class="lineNum">    3845 </span><span class="lineNoCov">          0 :     char *winner = NULL;</span>
<span class="lineNum">    3846 </span><span class="lineNoCov">          0 :     uint64_t leader_epoch;</span>
<span class="lineNum">    3847 </span><span class="lineNoCov">          0 :     uint64_t max_votes = 0;</span>
<span class="lineNum">    3848 </span>            : 
<span class="lineNum">    3849 </span><span class="lineNoCov">          0 :     serverAssert(master-&gt;flags &amp; (SRI_O_DOWN|SRI_FAILOVER_IN_PROGRESS));</span>
<span class="lineNum">    3850 </span><span class="lineNoCov">          0 :     counters = dictCreate(&amp;leaderVotesDictType,NULL);</span>
<span class="lineNum">    3851 </span>            : 
<span class="lineNum">    3852 </span><span class="lineNoCov">          0 :     voters = dictSize(master-&gt;sentinels)+1; /* All the other sentinels and me.*/</span>
<span class="lineNum">    3853 </span>            : 
<span class="lineNum">    3854 </span>            :     /* Count other sentinels votes */
<span class="lineNum">    3855 </span><span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;sentinels);</span>
<span class="lineNum">    3856 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    3857 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    3858 </span><span class="lineNoCov">          0 :         if (ri-&gt;leader != NULL &amp;&amp; ri-&gt;leader_epoch == sentinel.current_epoch)</span>
<span class="lineNum">    3859 </span><span class="lineNoCov">          0 :             sentinelLeaderIncr(counters,ri-&gt;leader);</span>
<span class="lineNum">    3860 </span>            :     }
<span class="lineNum">    3861 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    3862 </span>            : 
<span class="lineNum">    3863 </span>            :     /* Check what's the winner. For the winner to win, it needs two conditions:
<span class="lineNum">    3864 </span>            :      * 1) Absolute majority between voters (50% + 1).
<span class="lineNum">    3865 </span>            :      * 2) And anyway at least master-&gt;quorum votes. */
<span class="lineNum">    3866 </span><span class="lineNoCov">          0 :     di = dictGetIterator(counters);</span>
<span class="lineNum">    3867 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    3868 </span><span class="lineNoCov">          0 :         uint64_t votes = dictGetUnsignedIntegerVal(de);</span>
<span class="lineNum">    3869 </span>            : 
<span class="lineNum">    3870 </span><span class="lineNoCov">          0 :         if (votes &gt; max_votes) {</span>
<span class="lineNum">    3871 </span><span class="lineNoCov">          0 :             max_votes = votes;</span>
<span class="lineNum">    3872 </span><span class="lineNoCov">          0 :             winner = dictGetKey(de);</span>
<span class="lineNum">    3873 </span>            :         }
<span class="lineNum">    3874 </span>            :     }
<span class="lineNum">    3875 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    3876 </span>            : 
<span class="lineNum">    3877 </span>            :     /* Count this Sentinel vote:
<span class="lineNum">    3878 </span>            :      * if this Sentinel did not voted yet, either vote for the most
<span class="lineNum">    3879 </span>            :      * common voted sentinel, or for itself if no vote exists at all. */
<span class="lineNum">    3880 </span><span class="lineNoCov">          0 :     if (winner)</span>
<span class="lineNum">    3881 </span><span class="lineNoCov">          0 :         myvote = sentinelVoteLeader(master,epoch,winner,&amp;leader_epoch);</span>
<span class="lineNum">    3882 </span>            :     else
<span class="lineNum">    3883 </span><span class="lineNoCov">          0 :         myvote = sentinelVoteLeader(master,epoch,sentinel.myid,&amp;leader_epoch);</span>
<span class="lineNum">    3884 </span>            : 
<span class="lineNum">    3885 </span><span class="lineNoCov">          0 :     if (myvote &amp;&amp; leader_epoch == epoch) {</span>
<span class="lineNum">    3886 </span><span class="lineNoCov">          0 :         uint64_t votes = sentinelLeaderIncr(counters,myvote);</span>
<span class="lineNum">    3887 </span>            : 
<span class="lineNum">    3888 </span><span class="lineNoCov">          0 :         if (votes &gt; max_votes) {</span>
<span class="lineNum">    3889 </span><span class="lineNoCov">          0 :             max_votes = votes;</span>
<span class="lineNum">    3890 </span><span class="lineNoCov">          0 :             winner = myvote;</span>
<span class="lineNum">    3891 </span>            :         }
<span class="lineNum">    3892 </span>            :     }
<span class="lineNum">    3893 </span>            : 
<span class="lineNum">    3894 </span><span class="lineNoCov">          0 :     voters_quorum = voters/2+1;</span>
<span class="lineNum">    3895 </span><span class="lineNoCov">          0 :     if (winner &amp;&amp; (max_votes &lt; voters_quorum || max_votes &lt; master-&gt;quorum))</span>
<span class="lineNum">    3896 </span>            :         winner = NULL;
<span class="lineNum">    3897 </span>            : 
<span class="lineNum">    3898 </span><span class="lineNoCov">          0 :     winner = winner ? sdsnew(winner) : NULL;</span>
<span class="lineNum">    3899 </span><span class="lineNoCov">          0 :     sdsfree(myvote);</span>
<span class="lineNum">    3900 </span><span class="lineNoCov">          0 :     dictRelease(counters);</span>
<span class="lineNum">    3901 </span><span class="lineNoCov">          0 :     return winner;</span>
<span class="lineNum">    3902 </span>            : }
<span class="lineNum">    3903 </span>            : 
<span class="lineNum">    3904 </span>            : /* Send SLAVEOF to the specified instance, always followed by a
<span class="lineNum">    3905 </span>            :  * CONFIG REWRITE command in order to store the new configuration on disk
<span class="lineNum">    3906 </span>            :  * when possible (that is, if the Redis instance is recent enough to support
<span class="lineNum">    3907 </span>            :  * config rewriting, and if the server was started with a configuration file).
<span class="lineNum">    3908 </span>            :  *
<span class="lineNum">    3909 </span>            :  * If Host is NULL the function sends &quot;SLAVEOF NO ONE&quot;.
<span class="lineNum">    3910 </span>            :  *
<span class="lineNum">    3911 </span>            :  * The command returns C_OK if the SLAVEOF command was accepted for
<a name="3912"><span class="lineNum">    3912 </span>            :  * (later) delivery otherwise C_ERR. The command replies are just</a>
<span class="lineNum">    3913 </span>            :  * discarded. */
<span class="lineNum">    3914 </span><span class="lineNoCov">          0 : int sentinelSendSlaveOf(sentinelRedisInstance *ri, char *host, int port) {</span>
<span class="lineNum">    3915 </span><span class="lineNoCov">          0 :     char portstr[32];</span>
<span class="lineNum">    3916 </span><span class="lineNoCov">          0 :     int retval;</span>
<span class="lineNum">    3917 </span>            : 
<span class="lineNum">    3918 </span><span class="lineNoCov">          0 :     ll2string(portstr,sizeof(portstr),port);</span>
<span class="lineNum">    3919 </span>            : 
<span class="lineNum">    3920 </span>            :     /* If host is NULL we send SLAVEOF NO ONE that will turn the instance
<span class="lineNum">    3921 </span>            :      * into a master. */
<span class="lineNum">    3922 </span><span class="lineNoCov">          0 :     if (host == NULL) {</span>
<span class="lineNum">    3923 </span><span class="lineNoCov">          0 :         host = &quot;NO&quot;;</span>
<span class="lineNum">    3924 </span><span class="lineNoCov">          0 :         memcpy(portstr,&quot;ONE&quot;,4);</span>
<span class="lineNum">    3925 </span>            :     }
<span class="lineNum">    3926 </span>            : 
<span class="lineNum">    3927 </span>            :     /* In order to send SLAVEOF in a safe way, we send a transaction performing
<span class="lineNum">    3928 </span>            :      * the following tasks:
<span class="lineNum">    3929 </span>            :      * 1) Reconfigure the instance according to the specified host/port params.
<span class="lineNum">    3930 </span>            :      * 2) Rewrite the configuration.
<span class="lineNum">    3931 </span>            :      * 3) Disconnect all clients (but this one sending the commnad) in order
<span class="lineNum">    3932 </span>            :      *    to trigger the ask-master-on-reconnection protocol for connected
<span class="lineNum">    3933 </span>            :      *    clients.
<span class="lineNum">    3934 </span>            :      *
<span class="lineNum">    3935 </span>            :      * Note that we don't check the replies returned by commands, since we
<span class="lineNum">    3936 </span>            :      * will observe instead the effects in the next INFO output. */
<span class="lineNum">    3937 </span><span class="lineNoCov">          0 :     retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    3938 </span>            :         sentinelDiscardReplyCallback, ri, &quot;%s&quot;,
<span class="lineNum">    3939 </span>            :         sentinelInstanceMapCommand(ri,&quot;MULTI&quot;));
<span class="lineNum">    3940 </span><span class="lineNoCov">          0 :     if (retval == C_ERR) return retval;</span>
<span class="lineNum">    3941 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    3942 </span>            : 
<span class="lineNum">    3943 </span><span class="lineNoCov">          0 :     retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    3944 </span>            :         sentinelDiscardReplyCallback, ri, &quot;%s %s %s&quot;,
<span class="lineNum">    3945 </span>            :         sentinelInstanceMapCommand(ri,&quot;SLAVEOF&quot;),
<span class="lineNum">    3946 </span>            :         host, portstr);
<span class="lineNum">    3947 </span><span class="lineNoCov">          0 :     if (retval == C_ERR) return retval;</span>
<span class="lineNum">    3948 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    3949 </span>            : 
<span class="lineNum">    3950 </span><span class="lineNoCov">          0 :     retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    3951 </span>            :         sentinelDiscardReplyCallback, ri, &quot;%s REWRITE&quot;,
<span class="lineNum">    3952 </span>            :         sentinelInstanceMapCommand(ri,&quot;CONFIG&quot;));
<span class="lineNum">    3953 </span><span class="lineNoCov">          0 :     if (retval == C_ERR) return retval;</span>
<span class="lineNum">    3954 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    3955 </span>            : 
<span class="lineNum">    3956 </span>            :     /* CLIENT KILL TYPE &lt;type&gt; is only supported starting from Redis 2.8.12,
<span class="lineNum">    3957 </span>            :      * however sending it to an instance not understanding this command is not
<span class="lineNum">    3958 </span>            :      * an issue because CLIENT is variadic command, so Redis will not
<span class="lineNum">    3959 </span>            :      * recognized as a syntax error, and the transaction will not fail (but
<span class="lineNum">    3960 </span>            :      * only the unsupported command will fail). */
<span class="lineNum">    3961 </span><span class="lineNoCov">          0 :     retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    3962 </span>            :         sentinelDiscardReplyCallback, ri, &quot;%s KILL TYPE normal&quot;,
<span class="lineNum">    3963 </span>            :         sentinelInstanceMapCommand(ri,&quot;CLIENT&quot;));
<span class="lineNum">    3964 </span><span class="lineNoCov">          0 :     if (retval == C_ERR) return retval;</span>
<span class="lineNum">    3965 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    3966 </span>            : 
<span class="lineNum">    3967 </span><span class="lineNoCov">          0 :     retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span>
<span class="lineNum">    3968 </span>            :         sentinelDiscardReplyCallback, ri, &quot;%s&quot;,
<span class="lineNum">    3969 </span>            :         sentinelInstanceMapCommand(ri,&quot;EXEC&quot;));
<span class="lineNum">    3970 </span><span class="lineNoCov">          0 :     if (retval == C_ERR) return retval;</span>
<span class="lineNum">    3971 </span><span class="lineNoCov">          0 :     ri-&gt;link-&gt;pending_commands++;</span>
<span class="lineNum">    3972 </span>            : 
<span class="lineNum">    3973 </span><span class="lineNoCov">          0 :     return C_OK;</span>
<span class="lineNum">    3974 </span>            : }
<a name="3975"><span class="lineNum">    3975 </span>            : </a>
<span class="lineNum">    3976 </span>            : /* Setup the master state to start a failover. */
<span class="lineNum">    3977 </span><span class="lineNoCov">          0 : void sentinelStartFailover(sentinelRedisInstance *master) {</span>
<span class="lineNum">    3978 </span><span class="lineNoCov">          0 :     serverAssert(master-&gt;flags &amp; SRI_MASTER);</span>
<span class="lineNum">    3979 </span>            : 
<span class="lineNum">    3980 </span><span class="lineNoCov">          0 :     master-&gt;failover_state = SENTINEL_FAILOVER_STATE_WAIT_START;</span>
<span class="lineNum">    3981 </span><span class="lineNoCov">          0 :     master-&gt;flags |= SRI_FAILOVER_IN_PROGRESS;</span>
<span class="lineNum">    3982 </span><span class="lineNoCov">          0 :     master-&gt;failover_epoch = ++sentinel.current_epoch;</span>
<span class="lineNum">    3983 </span><span class="lineNoCov">          0 :     sentinelEvent(LL_WARNING,&quot;+new-epoch&quot;,master,&quot;%llu&quot;,</span>
<span class="lineNum">    3984 </span>            :         (unsigned long long) sentinel.current_epoch);
<span class="lineNum">    3985 </span><span class="lineNoCov">          0 :     sentinelEvent(LL_WARNING,&quot;+try-failover&quot;,master,&quot;%@&quot;);</span>
<span class="lineNum">    3986 </span><span class="lineNoCov">          0 :     master-&gt;failover_start_time = mstime()+rand()%SENTINEL_MAX_DESYNC;</span>
<span class="lineNum">    3987 </span><span class="lineNoCov">          0 :     master-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    3988 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3989 </span>            : 
<span class="lineNum">    3990 </span>            : /* This function checks if there are the conditions to start the failover,
<span class="lineNum">    3991 </span>            :  * that is:
<span class="lineNum">    3992 </span>            :  *
<span class="lineNum">    3993 </span>            :  * 1) Master must be in ODOWN condition.
<span class="lineNum">    3994 </span>            :  * 2) No failover already in progress.
<span class="lineNum">    3995 </span>            :  * 3) No failover already attempted recently.
<span class="lineNum">    3996 </span>            :  *
<span class="lineNum">    3997 </span>            :  * We still don't know if we'll win the election so it is possible that we
<span class="lineNum">    3998 </span>            :  * start the failover but that we'll not be able to act.
<a name="3999"><span class="lineNum">    3999 </span>            :  *</a>
<span class="lineNum">    4000 </span>            :  * Return non-zero if a failover was started. */
<span class="lineNum">    4001 </span><span class="lineNoCov">          0 : int sentinelStartFailoverIfNeeded(sentinelRedisInstance *master) {</span>
<span class="lineNum">    4002 </span>            :     /* We can't failover if the master is not in O_DOWN state. */
<span class="lineNum">    4003 </span><span class="lineNoCov">          0 :     if (!(master-&gt;flags &amp; SRI_O_DOWN)) return 0;</span>
<span class="lineNum">    4004 </span>            : 
<span class="lineNum">    4005 </span>            :     /* Failover already in progress? */
<span class="lineNum">    4006 </span><span class="lineNoCov">          0 :     if (master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) return 0;</span>
<span class="lineNum">    4007 </span>            : 
<span class="lineNum">    4008 </span>            :     /* Last failover attempt started too little time ago? */
<span class="lineNum">    4009 </span><span class="lineNoCov">          0 :     if (mstime() - master-&gt;failover_start_time &lt;</span>
<span class="lineNum">    4010 </span><span class="lineNoCov">          0 :         master-&gt;failover_timeout*2)</span>
<span class="lineNum">    4011 </span>            :     {
<span class="lineNum">    4012 </span><span class="lineNoCov">          0 :         if (master-&gt;failover_delay_logged != master-&gt;failover_start_time) {</span>
<span class="lineNum">    4013 </span><span class="lineNoCov">          0 :             time_t clock = (master-&gt;failover_start_time +</span>
<span class="lineNum">    4014 </span><span class="lineNoCov">          0 :                             master-&gt;failover_timeout*2) / 1000;</span>
<span class="lineNum">    4015 </span><span class="lineNoCov">          0 :             char ctimebuf[26];</span>
<span class="lineNum">    4016 </span>            : 
<span class="lineNum">    4017 </span><span class="lineNoCov">          0 :             ctime_r(&amp;clock,ctimebuf);</span>
<span class="lineNum">    4018 </span><span class="lineNoCov">          0 :             ctimebuf[24] = '\0'; /* Remove newline. */</span>
<span class="lineNum">    4019 </span><span class="lineNoCov">          0 :             master-&gt;failover_delay_logged = master-&gt;failover_start_time;</span>
<span class="lineNum">    4020 </span><span class="lineNoCov">          0 :             serverLog(LL_WARNING,</span>
<span class="lineNum">    4021 </span>            :                 &quot;Next failover delay: I will not start a failover before %s&quot;,
<span class="lineNum">    4022 </span>            :                 ctimebuf);
<span class="lineNum">    4023 </span>            :         }
<span class="lineNum">    4024 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    4025 </span>            :     }
<span class="lineNum">    4026 </span>            : 
<span class="lineNum">    4027 </span><span class="lineNoCov">          0 :     sentinelStartFailover(master);</span>
<span class="lineNum">    4028 </span><span class="lineNoCov">          0 :     return 1;</span>
<span class="lineNum">    4029 </span>            : }
<span class="lineNum">    4030 </span>            : 
<span class="lineNum">    4031 </span>            : /* Select a suitable slave to promote. The current algorithm only uses
<span class="lineNum">    4032 </span>            :  * the following parameters:
<span class="lineNum">    4033 </span>            :  *
<span class="lineNum">    4034 </span>            :  * 1) None of the following conditions: S_DOWN, O_DOWN, DISCONNECTED.
<span class="lineNum">    4035 </span>            :  * 2) Last time the slave replied to ping no more than 5 times the PING period.
<span class="lineNum">    4036 </span>            :  * 3) info_refresh not older than 3 times the INFO refresh period.
<span class="lineNum">    4037 </span>            :  * 4) master_link_down_time no more than:
<span class="lineNum">    4038 </span>            :  *     (now - master-&gt;s_down_since_time) + (master-&gt;down_after_period * 10).
<span class="lineNum">    4039 </span>            :  *    Basically since the master is down from our POV, the slave reports
<span class="lineNum">    4040 </span>            :  *    to be disconnected no more than 10 times the configured down-after-period.
<span class="lineNum">    4041 </span>            :  *    This is pretty much black magic but the idea is, the master was not
<span class="lineNum">    4042 </span>            :  *    available so the slave may be lagging, but not over a certain time.
<span class="lineNum">    4043 </span>            :  *    Anyway we'll select the best slave according to replication offset.
<span class="lineNum">    4044 </span>            :  * 5) Slave priority can't be zero, otherwise the slave is discarded.
<span class="lineNum">    4045 </span>            :  *
<span class="lineNum">    4046 </span>            :  * Among all the slaves matching the above conditions we select the slave
<span class="lineNum">    4047 </span>            :  * with, in order of sorting key:
<span class="lineNum">    4048 </span>            :  *
<span class="lineNum">    4049 </span>            :  * - lower slave_priority.
<span class="lineNum">    4050 </span>            :  * - bigger processed replication offset.
<span class="lineNum">    4051 </span>            :  * - lexicographically smaller runid.
<span class="lineNum">    4052 </span>            :  *
<span class="lineNum">    4053 </span>            :  * Basically if runid is the same, the slave that processed more commands
<span class="lineNum">    4054 </span>            :  * from the master is selected.
<span class="lineNum">    4055 </span>            :  *
<span class="lineNum">    4056 </span>            :  * The function returns the pointer to the selected slave, otherwise
<span class="lineNum">    4057 </span>            :  * NULL if no suitable slave was found.
<span class="lineNum">    4058 </span>            :  */
<span class="lineNum">    4059 </span>            : 
<span class="lineNum">    4060 </span>            : /* Helper for sentinelSelectSlave(). This is used by qsort() in order to
<a name="4061"><span class="lineNum">    4061 </span>            :  * sort suitable slaves in a &quot;better first&quot; order, to take the first of</a>
<span class="lineNum">    4062 </span>            :  * the list. */
<span class="lineNum">    4063 </span><span class="lineNoCov">          0 : int compareSlavesForPromotion(const void *a, const void *b) {</span>
<span class="lineNum">    4064 </span><span class="lineNoCov">          0 :     sentinelRedisInstance **sa = (sentinelRedisInstance **)a,</span>
<span class="lineNum">    4065 </span><span class="lineNoCov">          0 :                           **sb = (sentinelRedisInstance **)b;</span>
<span class="lineNum">    4066 </span><span class="lineNoCov">          0 :     char *sa_runid, *sb_runid;</span>
<span class="lineNum">    4067 </span>            : 
<span class="lineNum">    4068 </span><span class="lineNoCov">          0 :     if ((*sa)-&gt;slave_priority != (*sb)-&gt;slave_priority)</span>
<span class="lineNum">    4069 </span><span class="lineNoCov">          0 :         return (*sa)-&gt;slave_priority - (*sb)-&gt;slave_priority;</span>
<span class="lineNum">    4070 </span>            : 
<span class="lineNum">    4071 </span>            :     /* If priority is the same, select the slave with greater replication
<span class="lineNum">    4072 </span>            :      * offset (processed more data from the master). */
<span class="lineNum">    4073 </span><span class="lineNoCov">          0 :     if ((*sa)-&gt;slave_repl_offset &gt; (*sb)-&gt;slave_repl_offset) {</span>
<span class="lineNum">    4074 </span>            :         return -1; /* a &lt; b */
<span class="lineNum">    4075 </span><span class="lineNoCov">          0 :     } else if ((*sa)-&gt;slave_repl_offset &lt; (*sb)-&gt;slave_repl_offset) {</span>
<span class="lineNum">    4076 </span>            :         return 1; /* a &gt; b */
<span class="lineNum">    4077 </span>            :     }
<span class="lineNum">    4078 </span>            : 
<span class="lineNum">    4079 </span>            :     /* If the replication offset is the same select the slave with that has
<span class="lineNum">    4080 </span>            :      * the lexicographically smaller runid. Note that we try to handle runid
<span class="lineNum">    4081 </span>            :      * == NULL as there are old Redis versions that don't publish runid in
<span class="lineNum">    4082 </span>            :      * INFO. A NULL runid is considered bigger than any other runid. */
<span class="lineNum">    4083 </span><span class="lineNoCov">          0 :     sa_runid = (*sa)-&gt;runid;</span>
<span class="lineNum">    4084 </span><span class="lineNoCov">          0 :     sb_runid = (*sb)-&gt;runid;</span>
<span class="lineNum">    4085 </span><span class="lineNoCov">          0 :     if (sa_runid == NULL &amp;&amp; sb_runid == NULL) return 0;</span>
<span class="lineNum">    4086 </span><span class="lineNoCov">          0 :     else if (sa_runid == NULL) return 1;  /* a &gt; b */</span>
<span class="lineNum">    4087 </span><span class="lineNoCov">          0 :     else if (sb_runid == NULL) return -1; /* a &lt; b */</span>
<span class="lineNum">    4088 </span><span class="lineNoCov">          0 :     return strcasecmp(sa_runid, sb_runid);</span>
<a name="4089"><span class="lineNum">    4089 </span>            : }</a>
<span class="lineNum">    4090 </span>            : 
<span class="lineNum">    4091 </span><span class="lineNoCov">          0 : sentinelRedisInstance *sentinelSelectSlave(sentinelRedisInstance *master) {</span>
<span class="lineNum">    4092 </span><span class="lineNoCov">          0 :     sentinelRedisInstance **instance =</span>
<span class="lineNum">    4093 </span><span class="lineNoCov">          0 :         zmalloc(sizeof(instance[0])*dictSize(master-&gt;slaves));</span>
<span class="lineNum">    4094 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *selected = NULL;</span>
<span class="lineNum">    4095 </span><span class="lineNoCov">          0 :     int instances = 0;</span>
<span class="lineNum">    4096 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    4097 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    4098 </span><span class="lineNoCov">          0 :     mstime_t max_master_down_time = 0;</span>
<span class="lineNum">    4099 </span>            : 
<span class="lineNum">    4100 </span><span class="lineNoCov">          0 :     if (master-&gt;flags &amp; SRI_S_DOWN)</span>
<span class="lineNum">    4101 </span><span class="lineNoCov">          0 :         max_master_down_time += mstime() - master-&gt;s_down_since_time;</span>
<span class="lineNum">    4102 </span><span class="lineNoCov">          0 :     max_master_down_time += master-&gt;down_after_period * 10;</span>
<span class="lineNum">    4103 </span>            : 
<span class="lineNum">    4104 </span><span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    4105 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    4106 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    4107 </span><span class="lineNoCov">          0 :         mstime_t info_validity_time;</span>
<span class="lineNum">    4108 </span>            : 
<span class="lineNum">    4109 </span><span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_S_DOWN|SRI_O_DOWN)) continue;</span>
<span class="lineNum">    4110 </span><span class="lineNoCov">          0 :         if (slave-&gt;link-&gt;disconnected) continue;</span>
<span class="lineNum">    4111 </span><span class="lineNoCov">          0 :         if (mstime() - slave-&gt;link-&gt;last_avail_time &gt; SENTINEL_PING_PERIOD*5) continue;</span>
<span class="lineNum">    4112 </span><span class="lineNoCov">          0 :         if (slave-&gt;slave_priority == 0) continue;</span>
<span class="lineNum">    4113 </span>            : 
<span class="lineNum">    4114 </span>            :         /* If the master is in SDOWN state we get INFO for slaves every second.
<span class="lineNum">    4115 </span>            :          * Otherwise we get it with the usual period so we need to account for
<span class="lineNum">    4116 </span>            :          * a larger delay. */
<span class="lineNum">    4117 </span><span class="lineNoCov">          0 :         if (master-&gt;flags &amp; SRI_S_DOWN)</span>
<span class="lineNum">    4118 </span>            :             info_validity_time = SENTINEL_PING_PERIOD*5;
<span class="lineNum">    4119 </span>            :         else
<span class="lineNum">    4120 </span><span class="lineNoCov">          0 :             info_validity_time = SENTINEL_INFO_PERIOD*3;</span>
<span class="lineNum">    4121 </span><span class="lineNoCov">          0 :         if (mstime() - slave-&gt;info_refresh &gt; info_validity_time) continue;</span>
<span class="lineNum">    4122 </span><span class="lineNoCov">          0 :         if (slave-&gt;master_link_down_time &gt; max_master_down_time) continue;</span>
<span class="lineNum">    4123 </span><span class="lineNoCov">          0 :         instance[instances++] = slave;</span>
<span class="lineNum">    4124 </span>            :     }
<span class="lineNum">    4125 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    4126 </span><span class="lineNoCov">          0 :     if (instances) {</span>
<span class="lineNum">    4127 </span><span class="lineNoCov">          0 :         qsort(instance,instances,sizeof(sentinelRedisInstance*),</span>
<span class="lineNum">    4128 </span>            :             compareSlavesForPromotion);
<span class="lineNum">    4129 </span><span class="lineNoCov">          0 :         selected = instance[0];</span>
<span class="lineNum">    4130 </span>            :     }
<span class="lineNum">    4131 </span><span class="lineNoCov">          0 :     zfree(instance);</span>
<span class="lineNum">    4132 </span><span class="lineNoCov">          0 :     return selected;</span>
<span class="lineNum">    4133 </span>            : }
<a name="4134"><span class="lineNum">    4134 </span>            : </a>
<span class="lineNum">    4135 </span>            : /* ---------------- Failover state machine implementation ------------------- */
<span class="lineNum">    4136 </span><span class="lineNoCov">          0 : void sentinelFailoverWaitStart(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    4137 </span><span class="lineNoCov">          0 :     char *leader;</span>
<span class="lineNum">    4138 </span><span class="lineNoCov">          0 :     int isleader;</span>
<span class="lineNum">    4139 </span>            : 
<span class="lineNum">    4140 </span>            :     /* Check if we are the leader for the failover epoch. */
<span class="lineNum">    4141 </span><span class="lineNoCov">          0 :     leader = sentinelGetLeader(ri, ri-&gt;failover_epoch);</span>
<span class="lineNum">    4142 </span><span class="lineNoCov">          0 :     isleader = leader &amp;&amp; strcasecmp(leader,sentinel.myid) == 0;</span>
<span class="lineNum">    4143 </span><span class="lineNoCov">          0 :     sdsfree(leader);</span>
<span class="lineNum">    4144 </span>            : 
<span class="lineNum">    4145 </span>            :     /* If I'm not the leader, and it is not a forced failover via
<span class="lineNum">    4146 </span>            :      * SENTINEL FAILOVER, then I can't continue with the failover. */
<span class="lineNum">    4147 </span><span class="lineNoCov">          0 :     if (!isleader &amp;&amp; !(ri-&gt;flags &amp; SRI_FORCE_FAILOVER)) {</span>
<span class="lineNum">    4148 </span><span class="lineNoCov">          0 :         int election_timeout = SENTINEL_ELECTION_TIMEOUT;</span>
<span class="lineNum">    4149 </span>            : 
<span class="lineNum">    4150 </span>            :         /* The election timeout is the MIN between SENTINEL_ELECTION_TIMEOUT
<span class="lineNum">    4151 </span>            :          * and the configured failover timeout. */
<span class="lineNum">    4152 </span><span class="lineNoCov">          0 :         if (election_timeout &gt; ri-&gt;failover_timeout)</span>
<span class="lineNum">    4153 </span><span class="lineNoCov">          0 :             election_timeout = ri-&gt;failover_timeout;</span>
<span class="lineNum">    4154 </span>            :         /* Abort the failover if I'm not the leader after some time. */
<span class="lineNum">    4155 </span><span class="lineNoCov">          0 :         if (mstime() - ri-&gt;failover_start_time &gt; election_timeout) {</span>
<span class="lineNum">    4156 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;-failover-abort-not-elected&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    4157 </span><span class="lineNoCov">          0 :             sentinelAbortFailover(ri);</span>
<span class="lineNum">    4158 </span>            :         }
<span class="lineNum">    4159 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    4160 </span>            :     }
<span class="lineNum">    4161 </span><span class="lineNoCov">          0 :     sentinelEvent(LL_WARNING,&quot;+elected-leader&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    4162 </span><span class="lineNoCov">          0 :     if (sentinel.simfailure_flags &amp; SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION)</span>
<span class="lineNum">    4163 </span><span class="lineNoCov">          0 :         sentinelSimFailureCrash();</span>
<span class="lineNum">    4164 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_SELECT_SLAVE;</span>
<span class="lineNum">    4165 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    4166 </span><span class="lineNoCov">          0 :     sentinelEvent(LL_WARNING,&quot;+failover-state-select-slave&quot;,ri,&quot;%@&quot;);</span>
<a name="4167"><span class="lineNum">    4167 </span>            : }</a>
<span class="lineNum">    4168 </span>            : 
<span class="lineNum">    4169 </span><span class="lineNoCov">          0 : void sentinelFailoverSelectSlave(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    4170 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *slave = sentinelSelectSlave(ri);</span>
<span class="lineNum">    4171 </span>            : 
<span class="lineNum">    4172 </span>            :     /* We don't handle the timeout in this state as the function aborts
<span class="lineNum">    4173 </span>            :      * the failover or go forward in the next state. */
<span class="lineNum">    4174 </span><span class="lineNoCov">          0 :     if (slave == NULL) {</span>
<span class="lineNum">    4175 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;-failover-abort-no-good-slave&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    4176 </span><span class="lineNoCov">          0 :         sentinelAbortFailover(ri);</span>
<span class="lineNum">    4177 </span>            :     } else {
<span class="lineNum">    4178 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;+selected-slave&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    4179 </span><span class="lineNoCov">          0 :         slave-&gt;flags |= SRI_PROMOTED;</span>
<span class="lineNum">    4180 </span><span class="lineNoCov">          0 :         ri-&gt;promoted_slave = slave;</span>
<span class="lineNum">    4181 </span><span class="lineNoCov">          0 :         ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE;</span>
<span class="lineNum">    4182 </span><span class="lineNoCov">          0 :         ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    4183 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_NOTICE,&quot;+failover-state-send-slaveof-noone&quot;,</span>
<span class="lineNum">    4184 </span>            :             slave, &quot;%@&quot;);
<span class="lineNum">    4185 </span>            :     }
<a name="4186"><span class="lineNum">    4186 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    4187 </span>            : 
<span class="lineNum">    4188 </span><span class="lineNoCov">          0 : void sentinelFailoverSendSlaveOfNoOne(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    4189 </span><span class="lineNoCov">          0 :     int retval;</span>
<span class="lineNum">    4190 </span>            : 
<span class="lineNum">    4191 </span>            :     /* We can't send the command to the promoted slave if it is now
<span class="lineNum">    4192 </span>            :      * disconnected. Retry again and again with this state until the timeout
<span class="lineNum">    4193 </span>            :      * is reached, then abort the failover. */
<span class="lineNum">    4194 </span><span class="lineNoCov">          0 :     if (ri-&gt;promoted_slave-&gt;link-&gt;disconnected) {</span>
<span class="lineNum">    4195 </span><span class="lineNoCov">          0 :         if (mstime() - ri-&gt;failover_state_change_time &gt; ri-&gt;failover_timeout) {</span>
<span class="lineNum">    4196 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_WARNING,&quot;-failover-abort-slave-timeout&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    4197 </span><span class="lineNoCov">          0 :             sentinelAbortFailover(ri);</span>
<span class="lineNum">    4198 </span>            :         }
<span class="lineNum">    4199 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    4200 </span>            :     }
<span class="lineNum">    4201 </span>            : 
<span class="lineNum">    4202 </span>            :     /* Send SLAVEOF NO ONE command to turn the slave into a master.
<span class="lineNum">    4203 </span>            :      * We actually register a generic callback for this command as we don't
<span class="lineNum">    4204 </span>            :      * really care about the reply. We check if it worked indirectly observing
<span class="lineNum">    4205 </span>            :      * if INFO returns a different role (master instead of slave). */
<span class="lineNum">    4206 </span><span class="lineNoCov">          0 :     retval = sentinelSendSlaveOf(ri-&gt;promoted_slave,NULL,0);</span>
<span class="lineNum">    4207 </span><span class="lineNoCov">          0 :     if (retval != C_OK) return;</span>
<span class="lineNum">    4208 </span><span class="lineNoCov">          0 :     sentinelEvent(LL_NOTICE, &quot;+failover-state-wait-promotion&quot;,</span>
<span class="lineNum">    4209 </span><span class="lineNoCov">          0 :         ri-&gt;promoted_slave,&quot;%@&quot;);</span>
<span class="lineNum">    4210 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_WAIT_PROMOTION;</span>
<span class="lineNum">    4211 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    4212 </span>            : }
<span class="lineNum">    4213 </span>            : 
<a name="4214"><span class="lineNum">    4214 </span>            : /* We actually wait for promotion indirectly checking with INFO when the</a>
<span class="lineNum">    4215 </span>            :  * slave turns into a master. */
<span class="lineNum">    4216 </span><span class="lineNoCov">          0 : void sentinelFailoverWaitPromotion(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    4217 </span>            :     /* Just handle the timeout. Switching to the next state is handled
<span class="lineNum">    4218 </span>            :      * by the function parsing the INFO command of the promoted slave. */
<span class="lineNum">    4219 </span><span class="lineNoCov">          0 :     if (mstime() - ri-&gt;failover_state_change_time &gt; ri-&gt;failover_timeout) {</span>
<span class="lineNum">    4220 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;-failover-abort-slave-timeout&quot;,ri,&quot;%@&quot;);</span>
<span class="lineNum">    4221 </span><span class="lineNoCov">          0 :         sentinelAbortFailover(ri);</span>
<span class="lineNum">    4222 </span>            :     }
<a name="4223"><span class="lineNum">    4223 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    4224 </span>            : 
<span class="lineNum">    4225 </span><span class="lineNoCov">          0 : void sentinelFailoverDetectEnd(sentinelRedisInstance *master) {</span>
<span class="lineNum">    4226 </span><span class="lineNoCov">          0 :     int not_reconfigured = 0, timeout = 0;</span>
<span class="lineNum">    4227 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    4228 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    4229 </span><span class="lineNoCov">          0 :     mstime_t elapsed = mstime() - master-&gt;failover_state_change_time;</span>
<span class="lineNum">    4230 </span>            : 
<span class="lineNum">    4231 </span>            :     /* We can't consider failover finished if the promoted slave is
<span class="lineNum">    4232 </span>            :      * not reachable. */
<span class="lineNum">    4233 </span><span class="lineNoCov">          0 :     if (master-&gt;promoted_slave == NULL ||</span>
<span class="lineNum">    4234 </span><span class="lineNoCov">          0 :         master-&gt;promoted_slave-&gt;flags &amp; SRI_S_DOWN) return;</span>
<span class="lineNum">    4235 </span>            : 
<span class="lineNum">    4236 </span>            :     /* The failover terminates once all the reachable slaves are properly
<span class="lineNum">    4237 </span>            :      * configured. */
<span class="lineNum">    4238 </span><span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    4239 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    4240 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    4241 </span>            : 
<span class="lineNum">    4242 </span><span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_PROMOTED|SRI_RECONF_DONE)) continue;</span>
<span class="lineNum">    4243 </span><span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; SRI_S_DOWN) continue;</span>
<span class="lineNum">    4244 </span><span class="lineNoCov">          0 :         not_reconfigured++;</span>
<span class="lineNum">    4245 </span>            :     }
<span class="lineNum">    4246 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    4247 </span>            : 
<span class="lineNum">    4248 </span>            :     /* Force end of failover on timeout. */
<span class="lineNum">    4249 </span><span class="lineNoCov">          0 :     if (elapsed &gt; master-&gt;failover_timeout) {</span>
<span class="lineNum">    4250 </span><span class="lineNoCov">          0 :         not_reconfigured = 0;</span>
<span class="lineNum">    4251 </span><span class="lineNoCov">          0 :         timeout = 1;</span>
<span class="lineNum">    4252 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;+failover-end-for-timeout&quot;,master,&quot;%@&quot;);</span>
<span class="lineNum">    4253 </span>            :     }
<span class="lineNum">    4254 </span>            : 
<span class="lineNum">    4255 </span><span class="lineNoCov">          0 :     if (not_reconfigured == 0) {</span>
<span class="lineNum">    4256 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;+failover-end&quot;,master,&quot;%@&quot;);</span>
<span class="lineNum">    4257 </span><span class="lineNoCov">          0 :         master-&gt;failover_state = SENTINEL_FAILOVER_STATE_UPDATE_CONFIG;</span>
<span class="lineNum">    4258 </span><span class="lineNoCov">          0 :         master-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    4259 </span>            :     }
<span class="lineNum">    4260 </span>            : 
<span class="lineNum">    4261 </span>            :     /* If I'm the leader it is a good idea to send a best effort SLAVEOF
<span class="lineNum">    4262 </span>            :      * command to all the slaves still not reconfigured to replicate with
<span class="lineNum">    4263 </span>            :      * the new master. */
<span class="lineNum">    4264 </span><span class="lineNoCov">          0 :     if (timeout) {</span>
<span class="lineNum">    4265 </span><span class="lineNoCov">          0 :         dictIterator *di;</span>
<span class="lineNum">    4266 </span><span class="lineNoCov">          0 :         dictEntry *de;</span>
<span class="lineNum">    4267 </span>            : 
<span class="lineNum">    4268 </span><span class="lineNoCov">          0 :         di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    4269 </span><span class="lineNoCov">          0 :         while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    4270 </span><span class="lineNoCov">          0 :             sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    4271 </span><span class="lineNoCov">          0 :             int retval;</span>
<span class="lineNum">    4272 </span>            : 
<span class="lineNum">    4273 </span><span class="lineNoCov">          0 :             if (slave-&gt;flags &amp; (SRI_RECONF_DONE|SRI_RECONF_SENT)) continue;</span>
<span class="lineNum">    4274 </span><span class="lineNoCov">          0 :             if (slave-&gt;link-&gt;disconnected) continue;</span>
<span class="lineNum">    4275 </span>            : 
<span class="lineNum">    4276 </span><span class="lineNoCov">          0 :             retval = sentinelSendSlaveOf(slave,</span>
<span class="lineNum">    4277 </span>            :                     master-&gt;promoted_slave-&gt;addr-&gt;ip,
<span class="lineNum">    4278 </span><span class="lineNoCov">          0 :                     master-&gt;promoted_slave-&gt;addr-&gt;port);</span>
<span class="lineNum">    4279 </span><span class="lineNoCov">          0 :             if (retval == C_OK) {</span>
<span class="lineNum">    4280 </span><span class="lineNoCov">          0 :                 sentinelEvent(LL_NOTICE,&quot;+slave-reconf-sent-be&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    4281 </span><span class="lineNoCov">          0 :                 slave-&gt;flags |= SRI_RECONF_SENT;</span>
<span class="lineNum">    4282 </span>            :             }
<span class="lineNum">    4283 </span>            :         }
<span class="lineNum">    4284 </span><span class="lineNoCov">          0 :         dictReleaseIterator(di);</span>
<span class="lineNum">    4285 </span>            :     }
<span class="lineNum">    4286 </span>            : }
<span class="lineNum">    4287 </span>            : 
<a name="4288"><span class="lineNum">    4288 </span>            : /* Send SLAVE OF &lt;new master address&gt; to all the remaining slaves that</a>
<span class="lineNum">    4289 </span>            :  * still don't appear to have the configuration updated. */
<span class="lineNum">    4290 </span><span class="lineNoCov">          0 : void sentinelFailoverReconfNextSlave(sentinelRedisInstance *master) {</span>
<span class="lineNum">    4291 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    4292 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    4293 </span><span class="lineNoCov">          0 :     int in_progress = 0;</span>
<span class="lineNum">    4294 </span>            : 
<span class="lineNum">    4295 </span><span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    4296 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    4297 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    4298 </span>            : 
<span class="lineNum">    4299 </span><span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_RECONF_SENT|SRI_RECONF_INPROG))</span>
<span class="lineNum">    4300 </span><span class="lineNoCov">          0 :             in_progress++;</span>
<span class="lineNum">    4301 </span>            :     }
<span class="lineNum">    4302 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    4303 </span>            : 
<span class="lineNum">    4304 </span><span class="lineNoCov">          0 :     di = dictGetIterator(master-&gt;slaves);</span>
<span class="lineNum">    4305 </span><span class="lineNoCov">          0 :     while(in_progress &lt; master-&gt;parallel_syncs &amp;&amp;</span>
<span class="lineNum">    4306 </span><span class="lineNoCov">          0 :           (de = dictNext(di)) != NULL)</span>
<span class="lineNum">    4307 </span>            :     {
<span class="lineNum">    4308 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *slave = dictGetVal(de);</span>
<span class="lineNum">    4309 </span><span class="lineNoCov">          0 :         int retval;</span>
<span class="lineNum">    4310 </span>            : 
<span class="lineNum">    4311 </span>            :         /* Skip the promoted slave, and already configured slaves. */
<span class="lineNum">    4312 </span><span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_PROMOTED|SRI_RECONF_DONE)) continue;</span>
<span class="lineNum">    4313 </span>            : 
<span class="lineNum">    4314 </span>            :         /* If too much time elapsed without the slave moving forward to
<span class="lineNum">    4315 </span>            :          * the next state, consider it reconfigured even if it is not.
<span class="lineNum">    4316 </span>            :          * Sentinels will detect the slave as misconfigured and fix its
<span class="lineNum">    4317 </span>            :          * configuration later. */
<span class="lineNum">    4318 </span><span class="lineNoCov">          0 :         if ((slave-&gt;flags &amp; SRI_RECONF_SENT) &amp;&amp;</span>
<span class="lineNum">    4319 </span><span class="lineNoCov">          0 :             (mstime() - slave-&gt;slave_reconf_sent_time) &gt;</span>
<span class="lineNum">    4320 </span>            :             SENTINEL_SLAVE_RECONF_TIMEOUT)
<span class="lineNum">    4321 </span>            :         {
<span class="lineNum">    4322 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_NOTICE,&quot;-slave-reconf-sent-timeout&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    4323 </span><span class="lineNoCov">          0 :             slave-&gt;flags &amp;= ~SRI_RECONF_SENT;</span>
<span class="lineNum">    4324 </span><span class="lineNoCov">          0 :             slave-&gt;flags |= SRI_RECONF_DONE;</span>
<span class="lineNum">    4325 </span>            :         }
<span class="lineNum">    4326 </span>            : 
<span class="lineNum">    4327 </span>            :         /* Nothing to do for instances that are disconnected or already
<span class="lineNum">    4328 </span>            :          * in RECONF_SENT state. */
<span class="lineNum">    4329 </span><span class="lineNoCov">          0 :         if (slave-&gt;flags &amp; (SRI_RECONF_SENT|SRI_RECONF_INPROG)) continue;</span>
<span class="lineNum">    4330 </span><span class="lineNoCov">          0 :         if (slave-&gt;link-&gt;disconnected) continue;</span>
<span class="lineNum">    4331 </span>            : 
<span class="lineNum">    4332 </span>            :         /* Send SLAVEOF &lt;new master&gt;. */
<span class="lineNum">    4333 </span><span class="lineNoCov">          0 :         retval = sentinelSendSlaveOf(slave,</span>
<span class="lineNum">    4334 </span>            :                 master-&gt;promoted_slave-&gt;addr-&gt;ip,
<span class="lineNum">    4335 </span><span class="lineNoCov">          0 :                 master-&gt;promoted_slave-&gt;addr-&gt;port);</span>
<span class="lineNum">    4336 </span><span class="lineNoCov">          0 :         if (retval == C_OK) {</span>
<span class="lineNum">    4337 </span><span class="lineNoCov">          0 :             slave-&gt;flags |= SRI_RECONF_SENT;</span>
<span class="lineNum">    4338 </span><span class="lineNoCov">          0 :             slave-&gt;slave_reconf_sent_time = mstime();</span>
<span class="lineNum">    4339 </span><span class="lineNoCov">          0 :             sentinelEvent(LL_NOTICE,&quot;+slave-reconf-sent&quot;,slave,&quot;%@&quot;);</span>
<span class="lineNum">    4340 </span><span class="lineNoCov">          0 :             in_progress++;</span>
<span class="lineNum">    4341 </span>            :         }
<span class="lineNum">    4342 </span>            :     }
<span class="lineNum">    4343 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    4344 </span>            : 
<span class="lineNum">    4345 </span>            :     /* Check if all the slaves are reconfigured and handle timeout. */
<span class="lineNum">    4346 </span><span class="lineNoCov">          0 :     sentinelFailoverDetectEnd(master);</span>
<span class="lineNum">    4347 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4348 </span>            : 
<span class="lineNum">    4349 </span>            : /* This function is called when the slave is in
<a name="4350"><span class="lineNum">    4350 </span>            :  * SENTINEL_FAILOVER_STATE_UPDATE_CONFIG state. In this state we need</a>
<span class="lineNum">    4351 </span>            :  * to remove it from the master table and add the promoted slave instead. */
<span class="lineNum">    4352 </span><span class="lineNoCov">          0 : void sentinelFailoverSwitchToPromotedSlave(sentinelRedisInstance *master) {</span>
<span class="lineNum">    4353 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *ref = master-&gt;promoted_slave ?</span>
<span class="lineNum">    4354 </span><span class="lineNoCov">          0 :                                  master-&gt;promoted_slave : master;</span>
<span class="lineNum">    4355 </span>            : 
<span class="lineNum">    4356 </span><span class="lineNoCov">          0 :     sentinelEvent(LL_WARNING,&quot;+switch-master&quot;,master,&quot;%s %s %d %s %d&quot;,</span>
<span class="lineNum">    4357 </span><span class="lineNoCov">          0 :         master-&gt;name, master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port,</span>
<span class="lineNum">    4358 </span><span class="lineNoCov">          0 :         ref-&gt;addr-&gt;ip, ref-&gt;addr-&gt;port);</span>
<span class="lineNum">    4359 </span>            : 
<span class="lineNum">    4360 </span><span class="lineNoCov">          0 :     sentinelResetMasterAndChangeAddress(master,ref-&gt;addr-&gt;ip,ref-&gt;addr-&gt;port);</span>
<a name="4361"><span class="lineNum">    4361 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    4362 </span>            : 
<span class="lineNum">    4363 </span><span class="lineNoCov">          0 : void sentinelFailoverStateMachine(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    4364 </span><span class="lineNoCov">          0 :     serverAssert(ri-&gt;flags &amp; SRI_MASTER);</span>
<span class="lineNum">    4365 </span>            : 
<span class="lineNum">    4366 </span><span class="lineNoCov">          0 :     if (!(ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS)) return;</span>
<span class="lineNum">    4367 </span>            : 
<span class="lineNum">    4368 </span><span class="lineNoCov">          0 :     switch(ri-&gt;failover_state) {</span>
<span class="lineNum">    4369 </span><span class="lineNoCov">          0 :         case SENTINEL_FAILOVER_STATE_WAIT_START:</span>
<span class="lineNum">    4370 </span><span class="lineNoCov">          0 :             sentinelFailoverWaitStart(ri);</span>
<span class="lineNum">    4371 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    4372 </span><span class="lineNoCov">          0 :         case SENTINEL_FAILOVER_STATE_SELECT_SLAVE:</span>
<span class="lineNum">    4373 </span><span class="lineNoCov">          0 :             sentinelFailoverSelectSlave(ri);</span>
<span class="lineNum">    4374 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    4375 </span><span class="lineNoCov">          0 :         case SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE:</span>
<span class="lineNum">    4376 </span><span class="lineNoCov">          0 :             sentinelFailoverSendSlaveOfNoOne(ri);</span>
<span class="lineNum">    4377 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    4378 </span><span class="lineNoCov">          0 :         case SENTINEL_FAILOVER_STATE_WAIT_PROMOTION:</span>
<span class="lineNum">    4379 </span><span class="lineNoCov">          0 :             sentinelFailoverWaitPromotion(ri);</span>
<span class="lineNum">    4380 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    4381 </span><span class="lineNoCov">          0 :         case SENTINEL_FAILOVER_STATE_RECONF_SLAVES:</span>
<span class="lineNum">    4382 </span><span class="lineNoCov">          0 :             sentinelFailoverReconfNextSlave(ri);</span>
<span class="lineNum">    4383 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    4384 </span>            :     }
<span class="lineNum">    4385 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4386 </span>            : 
<span class="lineNum">    4387 </span>            : /* Abort a failover in progress:
<span class="lineNum">    4388 </span>            :  *
<span class="lineNum">    4389 </span>            :  * This function can only be called before the promoted slave acknowledged
<a name="4390"><span class="lineNum">    4390 </span>            :  * the slave -&gt; master switch. Otherwise the failover can't be aborted and</a>
<span class="lineNum">    4391 </span>            :  * will reach its end (possibly by timeout). */
<span class="lineNum">    4392 </span><span class="lineNoCov">          0 : void sentinelAbortFailover(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    4393 </span><span class="lineNoCov">          0 :     serverAssert(ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS);</span>
<span class="lineNum">    4394 </span><span class="lineNoCov">          0 :     serverAssert(ri-&gt;failover_state &lt;= SENTINEL_FAILOVER_STATE_WAIT_PROMOTION);</span>
<span class="lineNum">    4395 </span>            : 
<span class="lineNum">    4396 </span><span class="lineNoCov">          0 :     ri-&gt;flags &amp;= ~(SRI_FAILOVER_IN_PROGRESS|SRI_FORCE_FAILOVER);</span>
<span class="lineNum">    4397 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_NONE;</span>
<span class="lineNum">    4398 </span><span class="lineNoCov">          0 :     ri-&gt;failover_state_change_time = mstime();</span>
<span class="lineNum">    4399 </span><span class="lineNoCov">          0 :     if (ri-&gt;promoted_slave) {</span>
<span class="lineNum">    4400 </span><span class="lineNoCov">          0 :         ri-&gt;promoted_slave-&gt;flags &amp;= ~SRI_PROMOTED;</span>
<span class="lineNum">    4401 </span><span class="lineNoCov">          0 :         ri-&gt;promoted_slave = NULL;</span>
<span class="lineNum">    4402 </span>            :     }
<span class="lineNum">    4403 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4404 </span>            : 
<span class="lineNum">    4405 </span>            : /* ======================== SENTINEL timer handler ==========================
<span class="lineNum">    4406 </span>            :  * This is the &quot;main&quot; our Sentinel, being sentinel completely non blocking
<span class="lineNum">    4407 </span>            :  * in design. The function is called every second.
<span class="lineNum">    4408 </span>            :  * -------------------------------------------------------------------------- */
<a name="4409"><span class="lineNum">    4409 </span>            : </a>
<span class="lineNum">    4410 </span>            : /* Perform scheduled operations for the specified Redis instance. */
<span class="lineNum">    4411 </span><span class="lineNoCov">          0 : void sentinelHandleRedisInstance(sentinelRedisInstance *ri) {</span>
<span class="lineNum">    4412 </span>            :     /* ========== MONITORING HALF ============ */
<span class="lineNum">    4413 </span>            :     /* Every kind of instance */
<span class="lineNum">    4414 </span><span class="lineNoCov">          0 :     sentinelReconnectInstance(ri);</span>
<span class="lineNum">    4415 </span><span class="lineNoCov">          0 :     sentinelSendPeriodicCommands(ri);</span>
<span class="lineNum">    4416 </span>            : 
<span class="lineNum">    4417 </span>            :     /* ============== ACTING HALF ============= */
<span class="lineNum">    4418 </span>            :     /* We don't proceed with the acting half if we are in TILT mode.
<span class="lineNum">    4419 </span>            :      * TILT happens when we find something odd with the time, like a
<span class="lineNum">    4420 </span>            :      * sudden change in the clock. */
<span class="lineNum">    4421 </span><span class="lineNoCov">          0 :     if (sentinel.tilt) {</span>
<span class="lineNum">    4422 </span><span class="lineNoCov">          0 :         if (mstime()-sentinel.tilt_start_time &lt; SENTINEL_TILT_PERIOD) return;</span>
<span class="lineNum">    4423 </span><span class="lineNoCov">          0 :         sentinel.tilt = 0;</span>
<span class="lineNum">    4424 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;-tilt&quot;,NULL,&quot;#tilt mode exited&quot;);</span>
<span class="lineNum">    4425 </span>            :     }
<span class="lineNum">    4426 </span>            : 
<span class="lineNum">    4427 </span>            :     /* Every kind of instance */
<span class="lineNum">    4428 </span><span class="lineNoCov">          0 :     sentinelCheckSubjectivelyDown(ri);</span>
<span class="lineNum">    4429 </span>            : 
<span class="lineNum">    4430 </span>            :     /* Masters and slaves */
<span class="lineNum">    4431 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) {</span>
<span class="lineNum">    4432 </span>            :         /* Nothing so far. */
<span class="lineNum">    4433 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    4434 </span>            : 
<span class="lineNum">    4435 </span>            :     /* Only masters */
<span class="lineNum">    4436 </span><span class="lineNoCov">          0 :     if (ri-&gt;flags &amp; SRI_MASTER) {</span>
<span class="lineNum">    4437 </span><span class="lineNoCov">          0 :         sentinelCheckObjectivelyDown(ri);</span>
<span class="lineNum">    4438 </span><span class="lineNoCov">          0 :         if (sentinelStartFailoverIfNeeded(ri))</span>
<span class="lineNum">    4439 </span><span class="lineNoCov">          0 :             sentinelAskMasterStateToOtherSentinels(ri,SENTINEL_ASK_FORCED);</span>
<span class="lineNum">    4440 </span><span class="lineNoCov">          0 :         sentinelFailoverStateMachine(ri);</span>
<span class="lineNum">    4441 </span><span class="lineNoCov">          0 :         sentinelAskMasterStateToOtherSentinels(ri,SENTINEL_NO_FLAGS);</span>
<span class="lineNum">    4442 </span>            :     }
<span class="lineNum">    4443 </span>            : }
<span class="lineNum">    4444 </span>            : 
<a name="4445"><span class="lineNum">    4445 </span>            : /* Perform scheduled operations for all the instances in the dictionary.</a>
<span class="lineNum">    4446 </span>            :  * Recursively call the function against dictionaries of slaves. */
<span class="lineNum">    4447 </span><span class="lineNoCov">          0 : void sentinelHandleDictOfRedisInstances(dict *instances) {</span>
<span class="lineNum">    4448 </span><span class="lineNoCov">          0 :     dictIterator *di;</span>
<span class="lineNum">    4449 </span><span class="lineNoCov">          0 :     dictEntry *de;</span>
<span class="lineNum">    4450 </span><span class="lineNoCov">          0 :     sentinelRedisInstance *switch_to_promoted = NULL;</span>
<span class="lineNum">    4451 </span>            : 
<span class="lineNum">    4452 </span>            :     /* There are a number of things we need to perform against every master. */
<span class="lineNum">    4453 </span><span class="lineNoCov">          0 :     di = dictGetIterator(instances);</span>
<span class="lineNum">    4454 </span><span class="lineNoCov">          0 :     while((de = dictNext(di)) != NULL) {</span>
<span class="lineNum">    4455 </span><span class="lineNoCov">          0 :         sentinelRedisInstance *ri = dictGetVal(de);</span>
<span class="lineNum">    4456 </span>            : 
<span class="lineNum">    4457 </span><span class="lineNoCov">          0 :         sentinelHandleRedisInstance(ri);</span>
<span class="lineNum">    4458 </span><span class="lineNoCov">          0 :         if (ri-&gt;flags &amp; SRI_MASTER) {</span>
<span class="lineNum">    4459 </span><span class="lineNoCov">          0 :             sentinelHandleDictOfRedisInstances(ri-&gt;slaves);</span>
<span class="lineNum">    4460 </span><span class="lineNoCov">          0 :             sentinelHandleDictOfRedisInstances(ri-&gt;sentinels);</span>
<span class="lineNum">    4461 </span><span class="lineNoCov">          0 :             if (ri-&gt;failover_state == SENTINEL_FAILOVER_STATE_UPDATE_CONFIG) {</span>
<span class="lineNum">    4462 </span><span class="lineNoCov">          0 :                 switch_to_promoted = ri;</span>
<span class="lineNum">    4463 </span>            :             }
<span class="lineNum">    4464 </span>            :         }
<span class="lineNum">    4465 </span>            :     }
<span class="lineNum">    4466 </span><span class="lineNoCov">          0 :     if (switch_to_promoted)</span>
<span class="lineNum">    4467 </span><span class="lineNoCov">          0 :         sentinelFailoverSwitchToPromotedSlave(switch_to_promoted);</span>
<span class="lineNum">    4468 </span><span class="lineNoCov">          0 :     dictReleaseIterator(di);</span>
<span class="lineNum">    4469 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4470 </span>            : 
<span class="lineNum">    4471 </span>            : /* This function checks if we need to enter the TITL mode.
<span class="lineNum">    4472 </span>            :  *
<span class="lineNum">    4473 </span>            :  * The TILT mode is entered if we detect that between two invocations of the
<span class="lineNum">    4474 </span>            :  * timer interrupt, a negative amount of time, or too much time has passed.
<span class="lineNum">    4475 </span>            :  * Note that we expect that more or less just 100 milliseconds will pass
<span class="lineNum">    4476 </span>            :  * if everything is fine. However we'll see a negative number or a
<span class="lineNum">    4477 </span>            :  * difference bigger than SENTINEL_TILT_TRIGGER milliseconds if one of the
<span class="lineNum">    4478 </span>            :  * following conditions happen:
<span class="lineNum">    4479 </span>            :  *
<span class="lineNum">    4480 </span>            :  * 1) The Sentiel process for some time is blocked, for every kind of
<span class="lineNum">    4481 </span>            :  * random reason: the load is huge, the computer was frozen for some time
<span class="lineNum">    4482 </span>            :  * in I/O or alike, the process was stopped by a signal. Everything.
<span class="lineNum">    4483 </span>            :  * 2) The system clock was altered significantly.
<span class="lineNum">    4484 </span>            :  *
<span class="lineNum">    4485 </span>            :  * Under both this conditions we'll see everything as timed out and failing
<span class="lineNum">    4486 </span>            :  * without good reasons. Instead we enter the TILT mode and wait
<span class="lineNum">    4487 </span>            :  * for SENTINEL_TILT_PERIOD to elapse before starting to act again.
<a name="4488"><span class="lineNum">    4488 </span>            :  *</a>
<span class="lineNum">    4489 </span>            :  * During TILT time we still collect information, we just do not act. */
<span class="lineNum">    4490 </span><span class="lineNoCov">          0 : void sentinelCheckTiltCondition(void) {</span>
<span class="lineNum">    4491 </span><span class="lineNoCov">          0 :     mstime_t now = mstime();</span>
<span class="lineNum">    4492 </span><span class="lineNoCov">          0 :     mstime_t delta = now - sentinel.previous_time;</span>
<span class="lineNum">    4493 </span>            : 
<span class="lineNum">    4494 </span><span class="lineNoCov">          0 :     if (delta &lt; 0 || delta &gt; SENTINEL_TILT_TRIGGER) {</span>
<span class="lineNum">    4495 </span><span class="lineNoCov">          0 :         sentinel.tilt = 1;</span>
<span class="lineNum">    4496 </span><span class="lineNoCov">          0 :         sentinel.tilt_start_time = mstime();</span>
<span class="lineNum">    4497 </span><span class="lineNoCov">          0 :         sentinelEvent(LL_WARNING,&quot;+tilt&quot;,NULL,&quot;#tilt mode entered&quot;);</span>
<span class="lineNum">    4498 </span>            :     }
<span class="lineNum">    4499 </span><span class="lineNoCov">          0 :     sentinel.previous_time = mstime();</span>
<a name="4500"><span class="lineNum">    4500 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    4501 </span>            : 
<span class="lineNum">    4502 </span><span class="lineNoCov">          0 : void sentinelTimer(void) {</span>
<span class="lineNum">    4503 </span><span class="lineNoCov">          0 :     sentinelCheckTiltCondition();</span>
<span class="lineNum">    4504 </span><span class="lineNoCov">          0 :     sentinelHandleDictOfRedisInstances(sentinel.masters);</span>
<span class="lineNum">    4505 </span><span class="lineNoCov">          0 :     sentinelRunPendingScripts();</span>
<span class="lineNum">    4506 </span><span class="lineNoCov">          0 :     sentinelCollectTerminatedScripts();</span>
<span class="lineNum">    4507 </span><span class="lineNoCov">          0 :     sentinelKillTimedoutScripts();</span>
<span class="lineNum">    4508 </span>            : 
<span class="lineNum">    4509 </span>            :     /* We continuously change the frequency of the Redis &quot;timer interrupt&quot;
<span class="lineNum">    4510 </span>            :      * in order to desynchronize every Sentinel from every other.
<span class="lineNum">    4511 </span>            :      * This non-determinism avoids that Sentinels started at the same time
<span class="lineNum">    4512 </span>            :      * exactly continue to stay synchronized asking to be voted at the
<span class="lineNum">    4513 </span>            :      * same time again and again (resulting in nobody likely winning the
<span class="lineNum">    4514 </span>            :      * election because of split brain voting). */
<span class="lineNum">    4515 </span><span class="lineNoCov">          0 :     server.hz = CONFIG_DEFAULT_HZ + rand() % CONFIG_DEFAULT_HZ;</span>
<span class="lineNum">    4516 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4517 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
